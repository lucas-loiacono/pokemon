<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Pok√©mon Rancher</title>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <link href="https://unpkg.com/nes.css/css/nes.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --azul-poke: #020c69;
            --fondo: linear-gradient(180deg, #b2fefa 0%, #ffffff 100%);
        }
        body {
            font-family: 'Press Start 2P';
            background: var(--fondo);
            min-height: 100vh;
            color: #333;
            font-size: 12px; 
        }
        nav { display: none; }
        .page { display: none; }
        #view-home { display: block; }
        #granja:target ~ #view-home,
        #habitats:target ~ #view-home,
        #capturar:target ~ #view-home,
        #captura-escenario:target ~ #view-home,
        #captura-resultado:target ~ #view-home,
        #combates:target ~ #view-home,
        #equipo:target ~ #view-home,
        #caja:target ~ #view-home,
        #habitat-detalle:target ~ #view-home,
        #poke-interaccion:target ~ #view-home {
            display: none !important;
        }
        #granja:target ~ nav,
        #habitats:target ~ nav,
        #capturar:target ~ nav,
        #captura-escenario:target ~ nav,
        #captura-resultado:target ~ nav,
        #combates:target ~ nav,
        #equipo:target ~ nav,
        #caja:target ~ nav,
        #habitat-detalle:target ~ nav,
        #poke-interaccion:target ~ nav {
            display: flex;
        }
        #granja:target ~ .page { display: none !important; }
        #granja:target ~ #view-granja { display: block !important; }
        
        #habitats:target ~ .page { display: none !important; }
        #habitats:target ~ #view-habitats { display: block !important; }
        
        #capturar:target ~ .page { display: none !important; }
        #capturar:target ~ #view-capturar { display: block !important; }
        
        /* view-combates se maneja con JavaScript */
        
        #equipo:target ~ .page { display: none !important; }
        #equipo:target ~ #view-equipo { display: block !important; }
        
        #caja:target ~ .page { display: none !important; }
        #caja:target ~ #view-caja { display: block !important; }
        #captura-escenario:target ~ .page { display: none !important; }
        #captura-escenario:target ~ #view-captura-escenario { display: block !important; }
        
        #captura-resultado:target ~ .page { display: none !important; }
        #captura-resultado:target ~ #view-captura-resultado { display: block !important; }
        
        #habitat-detalle:target ~ .page { display: none !important; }
        #habitat-detalle:target ~ #view-habitat-detalle { display: block !important; }
        
        #poke-interaccion:target ~ .page { display: none !important; }
        #poke-interaccion:target ~ #view-poke-interaccion { display: block !important; }
        nav {
            background: white;
            padding: 15px;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-btn {
            text-decoration: none;
            color: #555;
            font-size: 0.7rem; 
            padding: 8px 12px;
            text-transform: uppercase;
            transition: 0.2s;
            font-weight: bold;
        }
        .nav-btn:hover { color: var(--azul-poke); transform: translateY(-2px); }
        .page {
            padding: 40px 20px;
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
            padding-bottom: 100px;
        }
        h1, h2, h3 { margin-bottom: 20px; line-height: 1.5; }
        .logo-db-container { margin: 50px auto; text-align: center; max-width: 500px; }
        .logo-img { width: 100%; max-height: 200px; object-fit: contain; }
        .menu-inicio {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }      
        .nes-btn.inicio:hover { background: var(--azul-poke); color: white; margin-top: -2px; margin-bottom: 2px;}
        .resources-hud {
            background: #fff;
            padding: 10px;
            border: 4px solid #333;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        .gen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px;
            margin-top: 20px;
        }
        .granja-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }.habitat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }.captura-grid {
            display: grid;
            /* Fuerza 3 columnas exactas */
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .gen-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            position: relative; 
            transition: transform 0.2s;
            border: 2px solid transparent;
        }
        .gen-card:hover { border-color: var(--azul-poke); }
        .farm-img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 10px; }
        .gen-card.locked { background: #e0e0e0; border-color: #999; pointer-events: none; }
        .gen-card.locked::after {
            content: "üîí Nivel " attr(data-req);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #333; color: white; padding: 5px; font-size: 0.6rem;
        }
        .gen-card.locked .farm-img { opacity: 0.3; filter: grayscale(100%); }
        .nes-btn.cooldown { background: #7f8c8d; box-shadow: 0 4px 0 #555; cursor: not-allowed; }
        .zone-img { width: 100%; height: 100px; object-fit: cover;  }
        .zone-body { padding: 10px; }
        .scene-bg { width: 100%; height: 100%; object-fit: cover; }
        .scene-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.2);
        }
        .radio-group { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .radio-group input { display: none; }
        .radio-label {
            padding: 10px; border: 4px solid #ccc; cursor: pointer; background: #fff;
        }
        .radio-group input:checked + .radio-label { border-color: var(--azul-poke); background: #e3f2fd; }
        .habitat-slots {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            max-width: 600px; margin: -40px auto 20px; position: relative; z-index: 10;
        }
        .poke-slot {
            background: white; border: 4px solid #333; padding: 5px; cursor: pointer;
            font-size: 0.7rem;
        }
        .poke-slot:hover { border-color: rgb(0, 38, 255); }
        .poke-slot.empty { border-style: dashed; border-color: #999; color: #999; display: flex; align-items: center; justify-content: center; height: 100px; }
        .box-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px; background: #333; padding: 10px; border: 4px solid #000;
        }
        .box-item { background: white; width:"80"; padding: 5px; font-size: 0.6rem; border: 2px solid #999; }
        /* MODALS DE COMBATE - OVERLAY FIJO */
        .combat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }
        .combat-modal.active {
            display: block;
        }
    </style>
</head>
<body>
<section id="view-inicializar" class="page" style="display: none; background: white; z-index: 2000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto;">
    <div style="max-width: 800px; margin: 50px auto;">
        <h1 class="nes-text is-primary">¬°Bienvenido a Pok√©mon Rancher!</h1>
        <p>Parece que eres nuevo aqu√≠.</p>
        <p>Para comenzar tu aventura, el Profesor te ofrece un compa√±ero:</p>
        
        <div id="lista-starters" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; margin-top: 50px;">
            Cargando...
        </div>
    </div>
</section>

    <div id="home"></div>
    <div id="granja"></div>
    <div id="habitats"></div>
    <div id="habitat-detalle"></div>
    <div id="poke-interaccion"></div>
    <div id="capturar"></div>
    <div id="captura-escenario"></div>
    <div id="captura-resultado"></div>
    <div id="combates"></div>
    <div id="equipo"></div>
    <div id="caja"></div>
    <nav>
        <a href="#granja" class="nav-btn">Granja</a>
        <a href="#habitats" class="nav-btn">Habitats</a>
        <a href="#capturar" class="nav-btn">Capturar</a>
        <a href="#combates" class="nav-btn">Combates</a>
        <a href="#equipo" class="nav-btn">Equipo</a>
        <a href="#caja" class="nav-btn">Caja</a>
        <a href="#home" class="nav-btn" style="color: red;">Volver</a>
    </nav>
    <section id="view-home">
        <div class="logo-db-container">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/International_Pok%C3%A9mon_logo.svg" 
                 alt="Logo Pok√©mon Rancher" class="logo-img">
        </div>
        <div class="menu-inicio">
            <a href="#granja" class="nes-btn inicio">GRANJA</a>
            <a href="#habitats" class="nes-btn inicio">HABITATS</a>
            <a href="#capturar" class="nes-btn inicio">CAPTURAR</a>
            <a href="#combates" class="nes-btn inicio">COMBATES</a>
            <a href="#equipo" class="nes-btn inicio">EQUIPO</a>
            <a href="#caja" class="nes-btn inicio">CAJA</a>
        </div>
    </section>
   <section id="view-granja" class="page" style="display: none;">
    <div class="container" style="margin-top: 20px; position: relative;">
        
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 30px; position: relative; height: 60px;">
            
            <div style="text-align: center; width: 100%;">
                <h1 style="margin: 0;">Mis Granjas</h1>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.8rem;">Recolecta comida para tus Pok√©mon</p>
            </div>

            <div class="nes-container is-rounded" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); padding: 5px 15px; background: white; display: flex; align-items: center; gap: 10px; z-index: 10;">
                <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen_bayas/Baya_Ziuela_EP.png" width="28">
                <span id="contador-bayas-granja" style="font-weight: bold; font-size: 1rem;">--</span>
            </div>
        </div>

        <div id="lista-granjas" class="granja-grid">
            <p style="text-align:center; width:100%;">Cargando...</p>
        </div>
    </div>
</section>
 <section id="view-habitats" class="page">
    <h1>Gestionar H√°bitats</h1>
    <p>Visita a tus Pok√©mon y alim√©ntalos.</p>
    
    <div class="habitat-grid">
        
        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatllanura.jpg" class="zone-img">
            <div class="zone-body">
                <h3>Pradera (<span id="hab-count-1">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(1)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatbosque.png" class="zone-img">
            <div class="zone-body">
                <h3>Bosque (<span id="hab-count-2">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(2)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatagua.png" class="zone-img">
            <div class="zone-body">
                <h3>Agua (<span id="hab-count-3">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(3)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatacero.png" class="zone-img">
            <div class="zone-body">
                <h3>Acero (<span id="hab-count-4">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(4)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatdesierto.jpeg" class="zone-img">
            <div class="zone-body">
                <h3>Desierto (<span id="hab-count-5">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(5)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitathielo.png" class="zone-img">
            <div class="zone-body">
                <h3>Hielo (<span id="hab-count-6">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(6)">Entrar</a>
            </div>
        </div>

    </div>
</section>
    <section id="view-habitat-detalle" class="page">
        <h2 id="titulo-habitat-detalle">Cargando...</h2>
<div class="nes-container is-rounded" style="height: 200px;">
    <img id="fondo-habitat-detalle" src="" class="scene-bg">
</div>
        <<div class="habitat-slots" id="lista-slots-habitat">
    </div>
        <a href="#habitats" class="nav-btn" style="display:inline-block; margin-top:20px;">&larr; Volver</a>
    </section>
   <section id="view-poke-interaccion" class="page">
    <div class="nes-container is-rounded" style="background:white; max-width:500px; margin:auto; text-align: left;">
        
        <div style="display:flex; gap:20px; align-items:center; margin-bottom: 20px;">
            
            <div style="text-align: center;">
                <img id="int-img" src="" width="120" style="image-rendering: pixelated; min-height: 120px;">
            </div>
            
            <div style="flex: 1;">
                <h3 id="int-nombre" style="margin:0; font-size: 1.1rem; text-transform: capitalize;">Cargando...</h3>
                
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    <input type="text" id="int-apodo-input" class="nes-input is-success" style="padding: 0 8px; height: 28px; font-size: 0.7rem;" placeholder="Nuevo apodo">
                    <button class="nes-btn is-primary" style="padding: 0 8px; height: 28px; font-size: 0.7rem;" onclick="guardarApodo()">OK</button>
                </div>

                <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: baseline;">
                    <span id="int-nivel" style="color:var(--azul-poke); font-weight: bold; font-size: 0.9rem;">Nivel --</span>
                    <span id="int-xp-text" style="font-size: 0.6rem; color: #666;">XP: --/--</span>
                </div>
                <progress id="int-progress" class="nes-progress is-primary" value="0" max="100" style="height: 15px; margin-top: 4px; width: 100%;"></progress>
            </div>
        </div>

        <div style="border-top: 4px dashed #ddd; margin: 20px 0; opacity: 0.6;"></div>

        <h3 style="text-align: center; color: #e67e22; margin-bottom: 15px; font-size: 1rem;">üçé Zona de Cuidados</h3>
        
        <div style="background: #fffdf6; padding: 15px; border-radius: 12px; border: 3px solid #f0d39e;">
            <p style="text-align: center; font-size: 0.8rem; margin-bottom: 15px;">
                Tu Inventario: <strong id="int-bayas-qty" style="font-size: 1.1rem; color: #d35400;">--</strong> Bayas
            </p>
            
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen_bayas/Baya_Ziuela_EP.png" width="36">

                    <div style="font-size: 0.65rem; line-height: 1.3;">
                        <strong style="color: #e67e22;">Baya Verde</strong><br>
                        <span>+20 XP</span>
                    </div>
                </div>
                <button class="nes-btn is-warning" style="font-size: 0.7rem; padding: 0 12px;" onclick="accionAlimentar()">DAR DE COMER</button>
            </div>
        </div>

        <br>
        <button class="nes-btn" style="width: 100%; margin-top: 10px;" onclick="cerrarInteraccion()">Volver</button>
    </div>
</section>
    <section id="view-capturar" class="page">
    <h1>Explorar Zona</h1>
    <p>Elige una zona para buscar Pok√©mon salvajes.</p>
    
    <div class="captura-grid">
        
        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturallanura.png" class="zone-img">
            <div class="zone-body">
                <h3>Pradera</h3>
                <a href="#captura-escenario" class="nes-btn is-primary" onclick="cargarEscenario(1)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturabosque.png" class="zone-img">
            <div class="zone-body">
                <h3>Bosque</h3>
                <a href="#captura-escenario" class="nes-btn is-success" onclick="cargarEscenario(2)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturaplaya.png" class="zone-img">
            <div class="zone-body">
                <h3>Playa</h3>
                <a href="#captura-escenario" class="nes-btn is-primary" onclick="cargarEscenario(3)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturacueva.png" class="zone-img">
            <div class="zone-body">
                <h3>Cueva</h3>
                <a href="#captura-escenario" class="nes-btn is-warning" onclick="cargarEscenario(4)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturadesierto.png" class="zone-img">
            <div class="zone-body">
                <h3>Desierto</h3>
                <a href="#captura-escenario" class="nes-btn is-warning" onclick="cargarEscenario(5)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturahielo.png" class="zone-img">
            <div class="zone-body">
                <h3>Nieve</h3>
                <a href="#captura-escenario" class="nes-btn is-primary" onclick="cargarEscenario(6)">Buscar</a>
            </div>
        </div>

    </div>
</section>
    <section id="view-captura-escenario" class="page">
        <h2>Zona Salvaje</h2>
        <div class="nes-container is-rounded">
            <img src="https://img.freepik.com/free-vector/landscape-with-mountains_23-2148283526.jpg" class="scene-bg">
            <div class="scene-overlay">
                <a href="#captura-resultado" class="nes-btn" style="width:auto; padding:20px 40px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Pokebola-pokeball-png-0.png" style="width:20px;">
                    ¬°Lanzar Pok√©ball!
                </a>
            </div>
        </div>
        <a href="#capturar" class="nav-btn" style="display:inline-block; margin-top:20px;">&larr; Huir</a>
    </section>
    <section id="view-captura-resultado" class="page">
        <div class="nes-container is-rounded" style="background:white; padding:20px; max-width:400px; margin:auto;">
            <h3>¬°Atrapado!</h3>
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png" width="150">
            <h2>PIKACHU</h2>
            <p>Tipo El√©ctrico. Le gustan las manzanas.</p>
            <form action="#caja" method="GET">
                <div class="radio-group">
                    <label><input type="radio" name="acc" value="box" checked><span class="radio-label">Guardar</span></label>
                    <label><input type="radio" name="acc" value="release"><span class="radio-label" style="color:red;">Liberar</span></label>
                </div>
                <button class="nes-btn">CONFIRMAR</button>
            </form>
        </div>
    </section>
    <section id="view-caja" class="page">
        <h1>Mi Caja</h1>
        <div class="box-grid">
            <div class="box-item">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png" ><br>Pikachu
            </div>
            <div class="box-item">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" ><br>Bulbasaur
            </div>
            <div class="box-item"></div><div class="box-item"></div><div class="box-item"></div>
        </div>
        <br>
        <a href="#home" class="nav-btn" style="display:inline-block; margin-top:20px;">&larr; Volver al Inicio</a>
    </section>
    <!-- ==================== SECCI√ìN: LISTA DE NIVELES ==================== -->
<section id="view-combates" class="page" style="display: none;">
    <h1>‚öîÔ∏è Combates</h1>
    
    <div id="lista-niveles" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; margin: 0 auto;">
        <!-- Se llenar√° con JavaScript -->
    </div>
</section>
<!-- ==================== SECCI√ìN: DETALLE DEL NIVEL ==================== -->
<section id="view-nivel-detalle" class="combat-modal">
    <div style="max-width: 600px; margin: 0 auto;">
        <h2 id="nivel-titulo" style="text-align: left; margin-bottom: 10px; font-size: 0.9rem;">Nivel 1</h2>
        <h3 id="nivel-nombre" style="text-align: left; margin-bottom: 30px; font-size: 0.9rem;">Nombre rival</h3>
        
        <div style="display: flex; gap: 40px; align-items: flex-start; margin-bottom: 40px;">
            <!-- Imagen del entrenador -->
            <img id="nivel-imagen" src="" style="width: 200px; height: 300px; object-fit: contain;">
            
            <!-- Equipo del rival -->
            <div style="flex: 1;">
                <h3 style="margin-bottom: 15px; font-size: 0.8rem;">Equipo</h3>
                <div id="equipo-rival" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="nes-btn is-warning" onclick="verPrediccion()" style="padding: 15px 40px; font-size: 0.8rem;">
                Ver Predicci√≥n
            </button>
            <br><br>
            <a href="#combates" class="nav-btn" onclick="volverALista()">‚Üê Volver</a>
        </div>
    </div>
</section>
<!-- ==================== SECCI√ìN: PANTALLA DE PREDICCI√ìN ==================== -->
<section id="view-prediccion" class="combat-modal">
    <div style="max-width: 1200px; margin: 0 auto;">
        <h1 style="text-align: center; margin-bottom: 30px; font-size: 1.2rem;">üìä Predicci√≥n de Batalla</h1>
        
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: center; min-height: 400px;">
            <!-- Equipo Jugador (Izquierda) -->
            <div id="equipo-jugador-prediccion">
                <!-- Se llenar√° din√°micamente -->
            </div>
            
            <!-- Resultado Predicho (Centro) -->
            <div style="text-align: center;">
                <div style="width: 220px; height: 220px; border: 5px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); box-shadow: 0 8px 16px rgba(0,0,0,0.2);">
                    <div style="text-align: center;">
                        <div style="font-size: 0.65rem; margin-bottom: 8px; color: #555; letter-spacing: 1px;">RESULTADO</div>
                        <div style="font-size: 0.65rem; margin-bottom: 15px; color: #555; letter-spacing: 1px;">PREDICHO</div>
                        <div id="porcentaje-victoria" style="font-size: 2.5rem; font-weight: bold; color: var(--azul-poke); text-shadow: 2px 2px 4px rgba(0,0,0,0.1); line-height: 1;">--</div>
                        <div id="mensaje-porcentaje" style="font-size: 0.55rem; margin-top: 10px; color: #888; font-weight: normal;">Calculando...</div>
                    </div>
                </div>
            </div>
            
            <!-- Equipo Rival (Derecha) -->
            <div id="equipo-rival-prediccion" style="text-align: right;">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
        
        <!-- Detalles de los combates individuales -->
        <div id="detalles-combates" style="margin-top: 30px; padding: 20px; background: white; border: 4px solid #333; border-radius: 10px;">
            <h3 style="font-size: 0.8rem; margin-bottom: 15px; text-align: center;">‚öîÔ∏è Combates 1 vs 1</h3>
            <p style="font-size: 0.55rem; text-align: center; color: #666; margin-bottom: 15px;">Necesitas ganar 3 o m√°s combates para ganar la batalla</p>
            <div id="lista-predicciones" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
        
        <!-- Botones de acci√≥n -->
        <div style="text-align: center; margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
            <button class="nes-btn is-error" onclick="volverADetalleNivel()" style="padding: 15px 30px; font-size: 0.8rem;">
                ‚Üê Cancelar
            </button>
            <button class="nes-btn is-success" onclick="ejecutarCombate()" style="padding: 15px 50px; font-size: 0.8rem;">
                ‚öîÔ∏è COMBATIR
            </button>
        </div>
    </div>
</section>
<!-- ==================== SECCI√ìN: RESULTADO ==================== -->
<section id="view-resultado" class="combat-modal">
    <div style="max-width: 700px; margin: 0 auto; text-align: center;">
        <h1 id="resultado-titulo" style="font-size: 2.5rem; margin-bottom: 20px;">Gan√≥ o Perdi√≥</h1>
        <p id="resultado-mensaje" style="font-size: 0.8rem; color: #666; margin-bottom: 40px;">Mensaje del resultado</p>
        
        <!-- Recompensas -->
        <div style="background: white; border: 4px solid #333; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
            <h2 style="font-size: 1rem; margin-bottom: 20px;">üéÅ Recompensas</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- XP del Jugador -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 2px solid var(--azul-poke);">
                    <div style="font-size: 0.6rem; color: #666; margin-bottom: 5px;">JUGADOR</div>
                    <div id="xp-jugador-ganada" style="font-size: 1.5rem; font-weight: bold; color: var(--azul-poke);">+100 XP</div>
                    <div id="jugador-subio-nivel" style="font-size: 0.6rem; color: #27ae60; margin-top: 5px; display: none;">
                        üéâ ¬°Subiste de nivel!
                    </div>
                </div>
                
                <!-- XP de Pok√©mon -->
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border: 2px solid #ff9800;">
                    <div style="font-size: 0.6rem; color: #666; margin-bottom: 5px;">CADA POK√âMON</div>
                    <div id="xp-pokemon-ganada" style="font-size: 1.5rem; font-weight: bold; color: #ff9800;">+30 XP</div>
                    <div style="font-size: 0.55rem; color: #666; margin-top: 5px;" id="total-pokemons-text">5 Pok√©mon</div>
                </div>
            </div>
        </div>
        
        <!-- Pok√©mon que subieron de nivel -->
        <div id="resultado-content" style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 20px; font-size: 0.9rem;">‚¨ÜÔ∏è Pok√©mon que subieron de nivel</h3>
            <div id="pokemons-subieron" style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
        
        <button class="nes-btn is-primary" onclick="volverALista()" style="padding: 15px 60px; font-size: 0.9rem;">
            Continuar
        </button>
    </div>
</section>
    <section id="view-equipo" class="page">
        <h1>Mi Equipo</h1>
        <p>Gestiona tu equipo de 6 Pok√©mon...</p>
    </section>
    <section id="modal-seleccion-habitat" class="combat-modal">
    <div class="nes-container is-rounded is-white" style="max-width: 600px; margin: 20px auto; background: white;">
        <h2 style="text-align: center;">Elige un Pok√©mon</h2>
        <p style="text-align: center; font-size: 0.7rem;">Solo ver√°s los que no est√°n ocupados.</p>
        
        <div id="lista-candidatos-habitat" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px;">
            Cargando...
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="nes-btn is-error" onclick="cerrarModalSeleccion()">Cancelar</button>
        </div>
    </div>
</section>
    <script>
const API_URL = 'http://localhost:3000/api';
let entrenadores = [];
let entrenadorSeleccionado = null;
let resultadoCombate = null;
let efectividades = [];
let equipoJugador = [];

console.log('‚úÖ Script de combates cargado');

/// ========== DETECTAR CAMBIO DE HASH (NAVEGACI√ìN) ==========
window.addEventListener('hashchange', () => {
    const hash = window.location.hash;
    const viewCombates = document.getElementById('view-combates');
    
    // 1. Ocultar combates si salimos de ah√≠
    if (hash !== '#combates') {
        viewCombates.style.display = 'none';
    }

    // 2. Cargar la secci√≥n correspondiente
    if (hash === '#combates') {
        viewCombates.style.display = 'block';
        cargarCombates();
    } 
    else if (hash === '#habitats') {
        actualizarContadoresHabitat();
    } 
    else if (hash === '#granja') {  // <--- ESTO ES LO QUE FALTABA
        cargarGranja();
    }
});

// ========== CARGAR AL INICIO (REFRESH) ==========
window.addEventListener('DOMContentLoaded', async () => {
    await verificarEstadoJuego();

    try {
        const res = await fetch(`${API_URL}/tipo-efectividad`);
        if (res.ok) efectividades = await res.json();
    } catch (error) { console.error(error); }

    const hash = window.location.hash;
    
    // Cargar la vista inicial si estamos en una espec√≠fica
    if (hash === '#combates') {
        document.getElementById('view-combates').style.display = 'block';
        cargarCombates();
    } else if (hash === '#granja') { // <--- ESTO TAMBI√âN FALTABA
        cargarGranja();
    } else if (hash === '#habitats') {
        actualizarContadoresHabitat();
    }
});
// ========== CARGAR NIVELES ==========
async function cargarCombates() {
    console.log('üîÑ Cargando combates...');
    
    try {
        const res = await fetch(`${API_URL}/entrenadores`);
        
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        entrenadores = await res.json();
        console.log('‚úÖ Entrenadores cargados:', entrenadores);
        
        const html = entrenadores.map(e => {
            const bloqueado = !e.desbloqueado;
            const derrotado = parseInt(e.victorias) > 0;
            
            return `
                <button 
                    class="nes-btn ${bloqueado ? 'is-disabled' : (derrotado ? 'is-success' : '')}" 
                    ${bloqueado ? 'disabled' : ''}
                    onclick="verNivel(${e.id})"
                    style="padding: 20px; font-size: 0.8rem; position: relative;">
                    ${bloqueado ? 'üîí ' : ''}Nivel ${e.nivel}
                    ${derrotado ? '<br><span style="font-size: 0.6rem;">‚úì Completado</span>' : ''}
                </button>
            `;
        }).join('');
        
        document.getElementById('lista-niveles').innerHTML = html;
        console.log('‚úÖ HTML renderizado');
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        document.getElementById('lista-niveles').innerHTML = `
            <div style="grid-column: 1/-1; text-align: center;" class="nes-text is-error">
                <p>Error al cargar entrenadores</p>
                <p style="font-size: 0.6rem;">${error.message}</p>
                <p style="font-size: 0.6rem;">¬øBackend corriendo en ${API_URL}?</p>
            </div>
        `;
    }
}

// ========== VER DETALLE DEL NIVEL ==========
async function verNivel(id) {
    console.log('üëÅÔ∏è Ver nivel:', id);
    
    try {
        const res = await fetch(`${API_URL}/entrenadores/${id}`);
        entrenadorSeleccionado = await res.json();
        console.log('‚úÖ Entrenador cargado:', entrenadorSeleccionado);
        
        document.getElementById('nivel-titulo').textContent = `Nivel ${entrenadorSeleccionado.nivel}`;
        document.getElementById('nivel-nombre').textContent = entrenadorSeleccionado.nombre;
        document.getElementById('nivel-imagen').src = entrenadorSeleccionado.imagen_url;
        
        const equipoHTML = entrenadorSeleccionado.pokemons.map(p => `
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border: 3px solid #333; border-radius: 8px; background: white;">
                <img src="${p.imagen_url}" width="50" style="border: 2px solid #333; border-radius: 5px;"
                     onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png'">
                <div style="text-align: left; flex: 1;">
                    <div style="font-size: 0.7rem; text-transform: capitalize;">${p.nombre}</div>
                    <div style="font-size: 0.6rem; color: #666;">${p.tipos.join(' / ')}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Lvl ${p.nivel}</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('equipo-rival').innerHTML = equipoHTML;
        
        // Mostrar detalle
        document.getElementById('view-nivel-detalle').classList.add('active');
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al cargar el entrenador: ' + error.message);
    }
}

// ========== CALCULAR MULTIPLICADOR (CLIENTE) ==========

function calcularMultiplicadorCliente(tiposAtacante, tiposDefensor, efectividades) {
    let sumaEfectividad = 0;
    
    if (!Array.isArray(efectividades)) {
        console.error('‚ùå efectividades no es un array');
        return 0;
    }

    for (const tipoAtacante of tiposAtacante) {
        for (const tipoDefensor of tiposDefensor) {
            const efectividad = efectividades.find(
                e => e.tipo_atacante === tipoAtacante && e.tipo_defensor === tipoDefensor
            );
            
            if (efectividad) {
                sumaEfectividad += parseFloat(efectividad.multiplicador);
            } else {
                sumaEfectividad += 1.0; // Da√±o neutro si no encuentra registro
            }
        }
    }
    
    return sumaEfectividad;
}

// ========== VER PREDICCI√ìN ==========
async function verPrediccion() {
    console.log('üîÆ Mostrando predicci√≥n...');
    
    try {
        // Cargar efectividades si no est√°n disponibles
        if (!efectividades || efectividades.length === 0) {
            console.log('‚ö†Ô∏è Cargando efectividades...');
            const resEfectividad = await fetch(`${API_URL}/tipo-efectividad`);
            efectividades = await resEfectividad.json();
            console.log('‚úÖ Efectividades cargadas:', efectividades.length);
        }
        
        // Obtener equipo del jugador
        const equipoRes = await fetch(`${API_URL}/jugador/equipo`);
        equipoJugador = await equipoRes.json();
        console.log('üë• Equipo jugador:', equipoJugador);
        
        if (equipoJugador.error || equipoJugador.length === 0) {
            alert('‚ùå No ten√©s Pok√©mon en tu equipo. Agreg√° al menos uno antes de combatir.');
            return;
        }
        
        // Ocultar detalle, mostrar predicci√≥n
        document.getElementById('view-nivel-detalle').classList.remove('active');
        document.getElementById('view-prediccion').classList.add('active');
        
        // Renderizar equipos
        const jugadorHTML = equipoJugador.map(p => `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; border: 3px solid #333; border-radius: 8px; background: white;">
                <img src="${p.imagen_url}" width="50" style="border: 2px solid #333; border-radius: 5px;"
                     onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png'">
                <div style="text-align: left;">
                    <div style="font-size: 0.7rem; text-transform: capitalize;">${p.apodo || p.nombre}</div>
                    <div style="font-size: 0.6rem; color: #666;">${p.tipos.join(' / ')}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Lvl ${p.nivel}</div>
                </div>
            </div>
        `).join('');
        
        const rivalHTML = entrenadorSeleccionado.pokemons.map(p => `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; border: 3px solid #333; border-radius: 8px; background: white; justify-content: flex-end;">
                <div style="text-align: right;">
                    <div style="font-size: 0.7rem; text-transform: capitalize;">${p.nombre}</div>
                    <div style="font-size: 0.6rem; color: #666;">${p.tipos.join(' / ')}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Lvl ${p.nivel}</div>
                </div>
                <img src="${p.imagen_url}" width="50" style="border: 2px solid #333; border-radius: 5px;"
                     onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png'">
            </div>
        `).join('');
        
        document.getElementById('equipo-jugador-prediccion').innerHTML = jugadorHTML;
        document.getElementById('equipo-rival-prediccion').innerHTML = rivalHTML;
        
        // ========== CALCULAR PREDICCI√ìN ==========
        const totalCombates = Math.min(equipoJugador.length, entrenadorSeleccionado.pokemons.length, 5);
        const predicciones = [];

        for (let i = 0; i < totalCombates; i++) {
            const pokemonJugador = equipoJugador[i];
            const pokemonRival = entrenadorSeleccionado.pokemons[i];

            const multiplicadorJugador = calcularMultiplicadorCliente(
                pokemonJugador.tipos,
                pokemonRival.tipos,
                efectividades
            );

            const multiplicadorRival = calcularMultiplicadorCliente(
                pokemonRival.tipos,
                pokemonJugador.tipos,
                efectividades
            );

            const poderJugador = pokemonJugador.nivel * multiplicadorJugador;
            const poderRival = pokemonRival.nivel * multiplicadorRival;
            
            const ganadorPredicho = poderJugador > poderRival ? 'jugador' : 'rival';
            
            predicciones.push({
                numero: i + 1,
                pokemonJugador: pokemonJugador.apodo || pokemonJugador.nombre,
                pokemonRival: pokemonRival.nombre,
                poderJugador: poderJugador.toFixed(2),
                poderRival: poderRival.toFixed(2),
                multiplicadorJugador: multiplicadorJugador.toFixed(2),
                multiplicadorRival: multiplicadorRival.toFixed(2),
                ganador: ganadorPredicho
            });
        }

        // Calcular resultado
        let victoriasPredichasJugador = 0;
        let victoriasPredichasRival = 0;
        
        predicciones.forEach(p => {
            if (p.ganador === 'jugador') {
                victoriasPredichasJugador++;
            } else {
                victoriasPredichasRival++;
            }
        });
        
        const ganarasLaBatalla = victoriasPredichasJugador >= 3;
        const mensajeResultado = `${victoriasPredichasJugador} vs ${victoriasPredichasRival}`;
        
        console.log('\nüèÜ PREDICCI√ìN:');
        console.log('   Victorias Jugador:', victoriasPredichasJugador);
        console.log('   Victorias Rival:', victoriasPredichasRival);
        console.log('   Resultado predicho:', ganarasLaBatalla ? 'VICTORIA' : 'DERROTA\n');
        
        // Mostrar predicciones
        const prediccionesHTML = predicciones.map(p => `
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; padding: 8px; border: 2px solid ${p.ganador === 'jugador' ? '#27ae60' : '#e74c3c'}; border-radius: 5px; background: ${p.ganador === 'jugador' ? '#e8f5e9' : '#ffebee'};">
                <div style="text-align: left; font-size: 0.6rem;">
                    <div style="font-weight: bold;">${p.pokemonJugador}</div>
                    <div style="color: #666;">Poder: ${p.poderJugador} (√ó${p.multiplicadorJugador})</div>
                </div>
                <div style="font-size: 0.7rem; font-weight: bold;">
                    ${p.ganador === 'jugador' ? '‚úÖ' : '‚ùå'}
                </div>
                <div style="text-align: right; font-size: 0.6rem;">
                    <div style="font-weight: bold;">${p.pokemonRival}</div>
                    <div style="color: #666;">Poder: ${p.poderRival} (√ó${p.multiplicadorRival})</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('lista-predicciones').innerHTML = prediccionesHTML;
        
        // Mostrar resultado predicho
        const porcentajeElement = document.getElementById('porcentaje-victoria');
        const mensajeElement = document.getElementById('mensaje-porcentaje');
        
        porcentajeElement.textContent = mensajeResultado;
        porcentajeElement.style.fontSize = '2rem';
        
        if (ganarasLaBatalla) {
            porcentajeElement.style.color = '#27ae60';
            mensajeElement.textContent = '¬°Vas a ganar!';
            mensajeElement.style.color = '#27ae60';
        } else {
            porcentajeElement.style.color = '#e74c3c';
            mensajeElement.textContent = 'Vas a perder';
            mensajeElement.style.color = '#e74c3c';
        }
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al calcular predicci√≥n: ' + error.message);
    }
}

// ========== VOLVER AL DETALLE DEL NIVEL ==========
function volverADetalleNivel() {
    document.getElementById('view-prediccion').classList.remove('active');
    document.getElementById('view-nivel-detalle').classList.add('active');
}

// ========== EJECUTAR COMBATE ==========
async function ejecutarCombate() {
    console.log('üé≤ Ejecutando combate...');
    
    try {
        const res = await fetch(`${API_URL}/entrenadores/${entrenadorSeleccionado.id}/combatir`, {
            method: 'POST'
        });
        
        resultadoCombate = await res.json();
        console.log('üìä Resultado:', resultadoCombate);
        
        if (resultadoCombate.error) {
            alert(`‚ùå ${resultadoCombate.mensaje || resultadoCombate.error}`);
            volverALista();
            return;
        }
        
        mostrarResultado();
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error durante el combate: ' + error.message);
        volverALista();
    }
}

// ========== MOSTRAR RESULTADO ==========
function mostrarResultado() {
    console.log('üìã Mostrando resultado...');
    
    document.getElementById('view-prediccion').classList.remove('active');
    document.getElementById('view-resultado').classList.add('active');
    
    const gano = resultadoCombate.resultado === 'victoria';
    
    // T√≠tulo y mensaje
    document.getElementById('resultado-titulo').textContent = gano ? 'üéâ ¬°Ganaste!' : 'üíî Perdiste';
    document.getElementById('resultado-titulo').style.color = gano ? 'green' : 'red';
    document.getElementById('resultado-mensaje').textContent = resultadoCombate.mensaje;
    
    // Mostrar recompensas de XP
    document.getElementById('xp-jugador-ganada').textContent = `+${resultadoCombate.xp_jugador} XP`;
    document.getElementById('xp-pokemon-ganada').textContent = `+${resultadoCombate.xp_pokemon} XP`;
    document.getElementById('total-pokemons-text').textContent = `${resultadoCombate.total_pokemons} Pok√©mon`;
    
    // Mostrar si el jugador subi√≥ de nivel
    const jugadorSubioElement = document.getElementById('jugador-subio-nivel');
    if (resultadoCombate.jugador_subio_nivel) {
        jugadorSubioElement.style.display = 'block';
        jugadorSubioElement.textContent = `üéâ ¬°Subiste al nivel ${resultadoCombate.jugador_niveles_subidos[resultadoCombate.jugador_niveles_subidos.length - 1]}!`;
    } else {
        jugadorSubioElement.style.display = 'none';
    }
    
    // Filtrar solo Pok√©mon que subieron de nivel
    const subieron = resultadoCombate.pokemons_actualizados.filter(p => p.subio_nivel);
    console.log('‚¨ÜÔ∏è Pok√©mon que subieron:', subieron);
    
    if (subieron.length === 0) {
        document.getElementById('pokemons-subieron').innerHTML = `
            <p style="font-size: 0.7rem; color: #999;">Ning√∫n Pok√©mon subi√≥ de nivel</p>
        `;
    } else {
        const pokemonsHTML = subieron.map(p => `
            <div style="display: flex; align-items: center; gap: 15px; padding: 10px; border: 3px solid #27ae60; border-radius: 8px; background: #e8f5e9; width: 100%; max-width: 400px;">
                <div style="font-size: 2rem;">‚¨ÜÔ∏è</div>
                <div style="text-align: left; flex: 1;">
                    <div style="font-size: 0.8rem; text-transform: capitalize; font-weight: bold;">${p.pokemon}</div>
                    <div style="font-size: 0.7rem; color: #27ae60;">
                        Subi√≥ al nivel ${p.niveles_subidos.join(', ')}
                    </div>
                    <div style="font-size: 0.6rem; color: #666;">
                        +${p.xp_ganada} XP
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('pokemons-subieron').innerHTML = pokemonsHTML;
    }
}

// ========== VOLVER A LA LISTA ==========
function volverALista() {
    console.log('üîô Volviendo a lista...');
    
    // Quitar todas las clases active de los modals
    document.getElementById('view-nivel-detalle').classList.remove('active');
    document.getElementById('view-prediccion').classList.remove('active');
    document.getElementById('view-resultado').classList.remove('active');
    
    entrenadorSeleccionado = null;
    resultadoCombate = null;
    
    window.location.hash = '#combates';
    cargarCombates();
}

// ========== ACTUALIZAR CONTADORES DE H√ÅBITAT ==========
async function actualizarContadoresHabitat() {
    console.log('üîÑ Actualizando contadores de h√°bitat...');
    try {
        const res = await fetch(`${API_URL}/jugador/habitats`);
        if (!res.ok) throw new Error('Error al cargar habitats');
        
        const habitats = await res.json();
        
        // 1. Reseteamos todos a 0 visualmente
        for (let i = 1; i <= 6; i++) {
            const contador = document.getElementById(`hab-count-${i}`);
            if (contador) contador.textContent = '0';
        }

        // 2. Actualizamos con la info real de la base de datos
        // Aseg√∫rate de que tu API devuelva "habitat_id" y "cantidad_pokemons" (o el nombre que tenga tu columna count)
        habitats.forEach(h => {
            const idHabitat = h.habitat_id || h.id; // Ajusta seg√∫n tu API
            const cantidad = h.cantidad_pokemons || h.total || h.count || 0;
            
            const contador = document.getElementById(`hab-count-${idHabitat}`);
            if (contador) {
                contador.textContent = cantidad;
            }
        });

    } catch (error) {
        console.error('‚ùå Error actualizando contadores:', error);
    }
}

// Diccionario con las fotos de fondo de cada h√°bitat
const infoHabitats = {
    1: { nombre: 'Pradera', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatllanura.jpg' },
    2: { nombre: 'Bosque', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatbosque.png' },
    3: { nombre: 'Agua', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatagua.png' },
    4: { nombre: 'Acero', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatacero.png' },
    5: { nombre: 'Desierto', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatdesierto.jpeg' },
    6: { nombre: 'Hielo', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitathielo.png' }
};

let habitatActualId = null;

async function cargarHabitat(id) {
    console.log('üå≤ Cargando h√°bitat:', id);
    habitatActualId = id;
    
    // 1. CAMBIAR FONDO Y T√çTULO SEG√öN EL H√ÅBITAT
    const info = infoHabitats[id];
    if (info) {
        document.getElementById('titulo-habitat-detalle').textContent = info.nombre;
        document.getElementById('fondo-habitat-detalle').src = info.fondo;
    }

    // 2. PEDIR POK√âMONS A LA API
    try {
        const res = await fetch(`${API_URL}/jugador/habitats/${id}/pokemons`);
        const pokemons = await res.json();
        
        const contenedor = document.getElementById('lista-slots-habitat');
        contenedor.innerHTML = ''; 

        for (let i = 0; i < 6; i++) {
            const pokemon = pokemons[i];

            if (pokemon) {
                // Pasamos la URL de la foto para que la interacci√≥n la use despu√©s
                contenedor.innerHTML += `
                    <a href="#poke-interaccion" class="poke-slot" 
                       onclick="interactuarPokemon(${pokemon.id}, '${pokemon.imagen_url}')">
                        <img src="${pokemon.imagen_url}" width="50">
                        <div>${pokemon.apodo || pokemon.nombre}</div>
                        <div style="color:var(--azul-poke);">Nvl ${pokemon.nivel}</div>
                    </a>
                `;
            } else {
                contenedor.innerHTML += `
                    <div class="poke-slot empty" onclick="abrirModalSeleccion(${id})">
                        + A√±adir
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error cargando habitat:', error);
    }
}
// Variable para recordar en qu√© h√°bitat estamos intentando a√±adir
let habitatSeleccionadoId = null;

// 1. ABRIR EL MODAL Y CARGAR POK√âMON DISPONIBLES
async function abrirModalSeleccion(idHabitat) {
    habitatSeleccionadoId = idHabitat;
    document.getElementById('modal-seleccion-habitat').classList.add('active');
    document.getElementById('lista-candidatos-habitat').innerHTML = '<p>Cargando caja...</p>';

    try {
        // Pedimos todos los pokemons del jugador
        const res = await fetch(`${API_URL}/jugador/pokemons`);
        const pokemons = await res.json();

        // Filtramos: (Aqu√≠ podr√≠as filtrar por tipo si quisieras ser estricto)
        // Por ahora mostraremos todos para probar.
        
        let html = '';
        
        if (pokemons.length === 0) {
            html = '<p>No tienes Pok√©mon en tu caja.</p>';
        } else {
            pokemons.forEach(p => {
                // DETECTAMOS EL ID CORRECTO:
                // Si p.id existe √∫salo, si no, usa p.jugador_pokemon_id
                const idReal = p.id || p.jugador_pokemon_id;

                html += `
                <div style="border: 2px solid #ccc; padding: 5px; display: flex; align-items: center; gap: 10px; cursor: pointer;" 
                     class="nes-pointer"
                     onclick="enviarPokemonAlHabitat(${idReal})">  <img src="${p.imagen_url}" width="40">
                    <div>
                        <div style="font-size: 0.7rem; font-weight: bold;">${p.apodo || p.nombre}</div>
                        <div style="font-size: 0.6rem;">Nvl ${p.nivel}</div>
                    </div>
                </div>
                `;
            });
        }

        document.getElementById('lista-candidatos-habitat').innerHTML = html;

    } catch (error) {
        console.error(error);
        document.getElementById('lista-candidatos-habitat').innerHTML = '<p>Error al cargar.</p>';
    }
}

// 2. ENVIAR EL POK√âMON SELECCIONADO AL SERVIDOR
async function enviarPokemonAlHabitat(jugadorPokemonId) {
    if (!habitatSeleccionadoId) return;

    // Efecto visual de "cargando"
    const lista = document.getElementById('lista-candidatos-habitat');
    lista.innerHTML = '<p>Asignando...</p>';

    try {
        const res = await fetch(`${API_URL}/jugador/habitats/${habitatSeleccionadoId}/asignar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jugador_pokemon_id: jugadorPokemonId })
        });

        const data = await res.json();

        if (data.error) {
            alert('‚ùå Error: ' + data.error);
            // Volvemos a cargar la lista por si quiere intentar con otro
            abrirModalSeleccion(habitatSeleccionadoId);
        } else {
            // ¬°√âXITO!
            alert('‚úÖ ¬°Pok√©mon a√±adido al h√°bitat!');
            cerrarModalSeleccion();
            cargarHabitat(habitatSeleccionadoId); // Recargamos el fondo para ver al nuevo
            actualizarContadoresHabitat(); // Actualizamos el (1/6)
        }

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

// 3. CERRAR MODAL
function cerrarModalSeleccion() {
    document.getElementById('modal-seleccion-habitat').classList.remove('active');
    habitatSeleccionadoId = null;
}
// ==================== L√ìGICA DE INICIALIZACI√ìN ====================

async function verificarEstadoJuego() {
    try {
        // Intentamos obtener los datos del jugador
        const res = await fetch(`${API_URL}/jugador`);
        
        if (res.status === 404) {
            // SI NO EXISTE JUGADOR (404) -> MOSTRAR PANTALLA DE SELECCI√ìN
            console.log('üÜï Nuevo jugador detectado. Iniciando selecci√≥n de starter...');
            document.getElementById('view-inicializar').style.display = 'block';
            cargarStarters();
        } else {
            // SI EXISTE -> OCULTAR PANTALLA DE SELECCI√ìN
            document.getElementById('view-inicializar').style.display = 'none';
        }
    } catch (error) {
        console.error('Error verificando estado:', error);
    }
}

async function cargarStarters() {
    try {
        const res = await fetch(`${API_URL}/inicializar/starters`);
        const starters = await res.json();
        
        const contenedor = document.getElementById('lista-starters');
        
        contenedor.innerHTML = starters.map(p => `
            <div class="nes-container is-rounded is-centered with-title" style="width: 220px; cursor: pointer; background: white;" onclick="elegirStarter(${p.id})">
                <p class="title">${p.nombre}</p>
                <img src="${p.imagen_url}" width="120" style="margin-bottom: 10px;">
                <div>
                    <span class="nes-text is-primary">Tipo: ${p.tipos.join('/')}</span>
                </div>
                <br>
                <button class="nes-btn is-success">¬°Te elijo a ti!</button>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error cargando starters:', error);
        document.getElementById('lista-starters').innerHTML = '<p class="nes-text is-error">Error al conectar con el servidor.</p>';
    }
}

async function elegirStarter(idPokemon) {
    if (!confirm("¬øEst√°s seguro de tu elecci√≥n? No podr√°s cambiarlo.")) return;

    try {
        const res = await fetch(`${API_URL}/inicializar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pokemon_starter_id: idPokemon })
        });

        const data = await res.json();

        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(`¬°Genial! Has comenzado tu aventura con ${data.pokemon_starter.nombre}.`);
            // Recargar la p√°gina para entrar al juego normal
            window.location.href = "#home";
            location.reload();
        }

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

// Variable global
let pokemonInteraccionId = null;

async function interactuarPokemon(id, imgUrl) {
    pokemonInteraccionId = id;
    console.log('ü•ï Interactuando con:', id);
    
    // Cambiamos de vista
    window.location.hash = '#poke-interaccion';
    
    // 1. PONEMOS LA FOTO INMEDIATAMENTE
    if (imgUrl) {
        document.getElementById('int-img').src = imgUrl;
    } else {
        document.getElementById('int-img').src = ''; 
    }

    // Resetear textos mientras carga
    document.getElementById('int-nombre').textContent = 'Cargando...';
    document.getElementById('int-apodo-input').value = '';
    
    try {
        // Pedir datos de Nivel y XP
        const resPoke = await fetch(`${API_URL}/jugador/pokemons/${id}/nivel`);
        const dataPoke = await resPoke.json();
        
        // Pedir Inventario
        const resInv = await fetch(`${API_URL}/jugador/inventario`);
        const dataInv = await resInv.json();
        
        // --- ACTUALIZAR DATOS ---
        const nombreMostrar = dataPoke.apodo || dataPoke.pokemon || 'Pok√©mon';
        document.getElementById('int-nombre').textContent = nombreMostrar;
        
        // AQU√ç EST√Å EL CAMBIO:
        document.getElementById('int-apodo-input').placeholder = "Cambiar nombre";
        
        // Actualizar barra de nivel
        actualizarBarraXP(dataPoke);

        // Actualizar bayas
        const bayas = dataInv.find(i => i.fruta_id === 1);
        document.getElementById('int-bayas-qty').textContent = bayas ? bayas.cantidad : 0;

    } catch (error) {
        console.error(error);
        alert('Error al cargar datos del Pok√©mon');
    }
}

// Helper para actualizar la barra visualmente
function actualizarBarraXP(data) {
    document.getElementById('int-nivel').textContent = `Nivel ${data.nivel}`;
    
    // Si es nivel m√°ximo
    if (data.max_nivel) {
        document.getElementById('int-xp-text').textContent = 'M√ÅXIMO';
        document.getElementById('int-progress').value = 100;
        document.getElementById('int-progress').classList.remove('is-primary');
        document.getElementById('int-progress').classList.add('is-warning');
    } else {
        document.getElementById('int-xp-text').textContent = `XP: ${data.xp_en_nivel_actual} / ${data.xp_para_subir}`;
        document.getElementById('int-progress').value = data.porcentaje_progreso;
        document.getElementById('int-progress').classList.remove('is-warning');
        document.getElementById('int-progress').classList.add('is-primary');
    }
}

// 2. ALIMENTAR POK√âMON
async function accionAlimentar() {
    if (!pokemonInteraccionId) return;
    
    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/alimentar`, {
            method: 'POST'
        });
        const data = await res.json();
        
        if (data.error) {
            alert('‚ùå ' + (data.mensaje || data.error)); // Tu backend a veces devuelve "mensaje" en error
        } else {
            // √âXITO
            // Nota: Tu backend devuelve "frutas_restantes", no "bayas_restantes"
            if (data.frutas_restantes !== undefined) {
                document.getElementById('int-bayas-qty').textContent = data.frutas_restantes;
            }
            
            // Animaci√≥n de subida de XP o Nivel
            if (data.subio_nivel) {
                alert(`üéâ ¬°Subi√≥ de nivel! Ahora es nivel ${data.nivel_actual}`);
                // Actualizar texto de nivel inmediatamente
                document.getElementById('int-nivel').textContent = `Nivel ${data.nivel_actual}`;
            } else {
                // Mensaje flotante simple
                console.log(`Gan√≥ ${data.xp_ganada} XP`);
            }
            
            // Recargar barra de XP visualmente
            const resPoke = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/nivel`);
            const dataPoke = await resPoke.json();
            actualizarBarraXP(dataPoke);
        }
    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

// 3. CAMBIAR APODO
async function guardarApodo() {
    const nuevoApodo = document.getElementById('int-apodo-input').value;
    if (!nuevoApodo || !pokemonInteraccionId) return;
    
    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/apodo`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apodo: nuevoApodo })
        });
        
        const data = await res.json();
        
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('‚úÖ Nombre cambiado a: ' + data.apodo);
            document.getElementById('int-nombre').textContent = data.apodo;
            document.getElementById('int-apodo-input').value = '';
        }
    } catch (error) {
        console.error(error);
    }
}

async function cargarGranja() {
    // Niveles seg√∫n tu base de datos
    const nivelesDesbloqueo = { 
        2: 3, 
        3: 6, 
        4: 12, 
        5: 18, 
        6: 25 
    };

    try {
        // Cargar Contador
        try {
            const resInv = await fetch(`${API_URL}/jugador/inventario`);
            if (resInv.ok) {
                const inventario = await resInv.json();
                const bayas = inventario.find(i => i.fruta_id === 1);
                const contador = document.getElementById('contador-bayas-granja');
                if (contador) contador.textContent = bayas ? bayas.cantidad : 0;
            }
        } catch (e) { console.error(e); }

        // Cargar Parcelas
        const res = await fetch(`${API_URL}/jugador/granjas`);
        if (!res.ok) {
            document.getElementById('lista-granjas').innerHTML = '<p>Error de conexi√≥n.</p>';
            return;
        }

        const data = await res.json();
        const listaGranjas = data.granjas || [];
        const contenedor = document.getElementById('lista-granjas');
        contenedor.innerHTML = '';

        if (listaGranjas.length === 0) {
            contenedor.innerHTML = '<p style="width:100%;">No tienes parcelas.</p>';
            return;
        }

        listaGranjas.forEach(g => {
            const numero = g.numero_granja;
            const imagenGranja = "https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen%20granja/granjasinfondo.png";
            
            let imagenHTML = '';
            let botonAccion = '';
            // CORRECCI√ìN: Quitamos el 'border: 4px solid' para que use el estilo pixelado original
            let estiloContenedor = 'background: white;'; 

            if (!g.desbloqueada) {
                // --- BLOQUEADO ---
                const nivelReq = nivelesDesbloqueo[numero] || 30;
                // Fondo gris suave, sin borde manual (usar√° el pixelado gris√°ceo por defecto)
                estiloContenedor = 'background: #e0e0e0; color: #777;'; 

                imagenHTML = `
                    <div style="position: relative; width: 100%; height: 120px; display:flex; align-items:center; justify-content:center;">
                        <img src="${imagenGranja}" style="height: 100%; width: auto; filter: grayscale(100%); opacity: 0.4;">
                        
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                    background: #333; color: white; padding: 6px 10px; border-radius: 4px; 
                                    font-size: 0.8rem; z-index: 10; white-space: nowrap;">
                            üîí Nivel ${nivelReq}
                        </div>
                    </div>
                `;

                botonAccion = `
                    <button class="nes-btn is-disabled" style="width: 100%; font-size: 0.7rem; margin-top: 10px;">BLOQUEADO</button>
                `;

            } else {
                // --- DESBLOQUEADO ---
                
                imagenHTML = `
                    <div style="width: 100%; height: 120px; display:flex; align-items:center; justify-content:center;">
                        <img src="${imagenGranja}" style="height: 100%; width: auto; filter: drop-shadow(0 4px 0 rgba(0,0,0,0.2));">
                    </div>
                `;

                if (g.puede_recolectar) {
                    botonAccion = `
                        <button class="nes-btn is-warning" onclick="recolectar(${g.granja_id})" style="width: 100%; font-size: 0.7rem; margin-top: 10px; padding: 5px;">
                            RECOLECTAR (+20)
                        </button>`;
                } else {
                    // Tiempo restante
                    let textoTiempo = "Creciendo...";
                    if (g.tiempo_restante > 0) {
                        const minutos = Math.floor(g.tiempo_restante / 60);
                        const segundos = Math.floor(g.tiempo_restante % 60);
                        textoTiempo = `‚è≥ ${minutos}:${segundos.toString().padStart(2, '0')}`;
                    }

                    botonAccion = `
                        <button class="nes-btn is-primary" style="width: 100%; font-size: 0.7rem; margin-top: 10px; opacity: 0.8; cursor: default;">
                            ${textoTiempo}
                        </button>`;
                }
            }

            // Insertamos la tarjeta
            // Al usar 'nes-container is-rounded' sin forzar border, volver√° el marco original
            contenedor.innerHTML += `
                <div class="nes-container is-rounded" style="${estiloContenedor} padding: 15px; text-align: center;">
                    
                    <h3 style="font-size: 0.9rem; margin: 0 0 15px 0; border-bottom: 2px dashed #ccc; padding-bottom: 5px;">
                        Parcela ${numero}
                    </h3>

                    ${imagenHTML}

                    ${botonAccion}
                </div>
            `;
        });

    } catch (error) {
        console.error('Error cargando granja:', error);
    }
}
// ==================== FUNCIONES DE GRANJA ====================

async function recolectar(granjaId) {
    try {
        // 1. Efecto visual en el bot√≥n (para que sepas que hiciste clic)
        const btn = event.target; 
        const textoOriginal = btn.innerHTML;
        btn.innerHTML = '‚è≥...';
        btn.disabled = true;

        // 2. Llamada al Servidor
        const res = await fetch(`${API_URL}/jugador/granjas/${granjaId}/recolectar`, {
            method: 'POST'
        });
        const data = await res.json();

        if (data.error) {
            // Si hay error (ej: inventario lleno), mostramos aviso y restauramos bot√≥n
            alert(data.mensaje || data.error);
            btn.innerHTML = textoOriginal;
            btn.disabled = false;
        } else {
            // 3. √âXITO: Actualizamos el contador ARRIBA A LA DERECHA inmediatamente
            // El backend nos devuelve "total_frutas"
            if (data.total_frutas !== undefined) {
                const contador = document.getElementById('contador-bayas-granja');
                if (contador) {
                    contador.textContent = data.total_frutas;
                    
                    // Efecto visual extra: parpadeo verde para indicar ganancia
                    contador.style.color = '#27ae60'; 
                    setTimeout(() => contador.style.color = '', 500);
                }
            }

            // 4. Recargamos la grilla para que la parcela pase a "Creciendo..."
            await cargarGranja(); 
        }

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

// 4. CERRAR
function cerrarInteraccion() {
    // Volvemos al habitat anterior (usando la variable global que creamos antes)
    if (habitatActualId) {
        cargarHabitat(habitatActualId); // Recargar para ver cambios (nivel, nombre)
        window.location.hash = '#habitat-detalle';
    } else {
        window.location.hash = '#habitats';
    }
}
</script>

</body>
</html>