<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Pok√©mon Rancher</title>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <link href="https://unpkg.com/nes.css/css/nes.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --azul-poke: #020c69;
            --fondo: linear-gradient(180deg, #b2fefa 0%, #ffffff 100%);
        }
       body {
            font-family: 'Press Start 2P';
            background: var(--fondo);
            background-attachment: fixed; 
            background-repeat: no-repeat; 
            margin: 0; 
            min-height: 100vh;
            color: #333;
            font-size: 12px; 
        }

        #view-home { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
        }
        nav { display: none; }
        .page { display: none; }
        #view-home { display: block; }
        #granja:target ~ #view-home,
        #habitats:target ~ #view-home,
        #capturar:target ~ #view-home,
        #captura-escenario:target ~ #view-home,
        #captura-resultado:target ~ #view-home,
        #combates:target ~ #view-home,
        #equipo:target ~ #view-home,
        #caja:target ~ #view-home,
        #habitat-detalle:target ~ #view-home,
        #poke-interaccion:target ~ #view-home {
            display: none !important;
        }
        #granja:target ~ nav,
        #habitats:target ~ nav,
        #capturar:target ~ nav,
        #captura-escenario:target ~ nav,
        #captura-resultado:target ~ nav,
        #combates:target ~ nav,
        #equipo:target ~ nav,
        #caja:target ~ nav,
        #habitat-detalle:target ~ nav,
        #poke-interaccion:target ~ nav {
            display: flex;
        }
        #granja:target ~ .page { display: none !important; }
        #granja:target ~ #view-granja { display: block !important; }
        
        #habitats:target ~ .page { display: none !important; }
        #habitats:target ~ #view-habitats { display: block !important; }
        
        #capturar:target ~ .page { display: none !important; }
        #capturar:target ~ #view-capturar { display: block !important; }
        
        /* view-combates se maneja con JavaScript */
        
        #equipo:target ~ .page { display: none !important; }
        #equipo:target ~ #view-equipo { display: block !important; }
        
        #caja:target ~ .page { display: none !important; }
        #caja:target ~ #view-caja { display: block !important; }
        #captura-escenario:target ~ .page { display: none !important; }
        #captura-escenario:target ~ #view-captura-escenario { display: block !important; }
        
        #captura-resultado:target ~ .page { display: none !important; }
        #captura-resultado:target ~ #view-captura-resultado { display: block !important; }
        
        #habitat-detalle:target ~ .page { display: none !important; }
        #habitat-detalle:target ~ #view-habitat-detalle { display: block !important; }
        
        #poke-interaccion:target ~ .page { display: none !important; }
        #poke-interaccion:target ~ #view-poke-interaccion { display: block !important; }
        nav {
            background: white;
            padding: 15px;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-btn {
            text-decoration: none;
            color: #555;
            font-size: 0.7rem; 
            padding: 8px 12px;
            text-transform: uppercase;
            transition: 0.2s;
            font-weight: bold;
        }
        .nav-btn:hover { color: var(--azul-poke); transform: translateY(-2px); }
        .page {
            padding: 40px 20px;
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
            padding-bottom: 100px;
        }
        h1, h2, h3 { margin-bottom: 20px; line-height: 1.5; }
        .logo-db-container { margin: 50px auto; text-align: center; max-width: 500px; }
        .logo-img { width: 100%; max-height: 200px; object-fit: contain; }
        .menu-inicio {
            display: grid;
            /* Hacemos que los botones midan al menos 220px de ancho */
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 30px; /* M√°s espacio entre ellos */
            max-width: 850px; /* Aprovechamos m√°s el ancho de la pantalla */
            margin: 0 auto;
            padding: 20px;
        }      

        .nes-btn.inicio {
            padding: 30px 10px; /* Botones mucho m√°s altos */
            font-size: 1rem; /* Texto m√°s grande */
            display: flex;
            flex-direction: column; /* Ponemos el √≠cono arriba y el texto abajo */
            align-items: center;
            justify-content: center;
            gap: 15px; /* Espacio entre √≠cono y texto */
            transition: all 0.2s ease; /* Animaci√≥n suave */
        }

        .nes-btn.inicio:hover { 
            background: var(--azul-poke); 
            color: white; 
            transform: scale(1.05); /* Efecto de que el bot√≥n se acerca al pasar el mouse */
        }
        .resources-hud {
            background: #fff;
            padding: 10px;
            border: 4px solid #333;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        .gen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px;
            margin-top: 20px;
        }
        .granja-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }.habitat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }.captura-grid {
            display: grid;
            /* Fuerza 3 columnas exactas */
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .gen-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            position: relative; 
            transition: transform 0.2s;
            border: 2px solid transparent;
        }
        .gen-card:hover { border-color: var(--azul-poke); }
        .farm-img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 10px; }
        .gen-card.locked { background: #e0e0e0; border-color: #999; pointer-events: none; }
        .gen-card.locked::after {
            content: "üîí Nivel " attr(data-req);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #333; color: white; padding: 5px; font-size: 0.6rem;
        }
        .gen-card.locked .farm-img { opacity: 0.3; filter: grayscale(100%); }
        .nes-btn.cooldown { background: #7f8c8d; box-shadow: 0 4px 0 #555; cursor: not-allowed; }
        .zone-img { width: 100%; height: 100px; object-fit: cover;  }
        .zone-body { padding: 10px; }
        .scene-bg { width: 100%; height: 100%; object-fit: cover; }
        .scene-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.2);
        }
        .radio-group { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .radio-group input { display: none; }
        .radio-label {
            padding: 10px; border: 4px solid #ccc; cursor: pointer; background: #fff;
        }
        .radio-group input:checked + .radio-label { border-color: var(--azul-poke); background: #e3f2fd; }
        .habitat-slots {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            max-width: 600px; margin: -40px auto 20px; position: relative; z-index: 10;
        }
        .poke-slot {
            background: white; border: 4px solid #333; padding: 5px; cursor: pointer;
            font-size: 0.7rem;
        }
        .poke-slot:hover { border-color: rgb(0, 38, 255); }
        .poke-slot.empty { border-style: dashed; border-color: #999; color: #999; display: flex; align-items: center; justify-content: center; height: 100px; }
        .box-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px; background: #333; padding: 10px; border: 4px solid #000;
        }
        .box-item { background: white; width:"80"; padding: 5px; font-size: 0.6rem; border: 2px solid #999; }
        /* MODALS DE COMBATE - OVERLAY FIJO */
        .combat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }
        .combat-modal.active {
            display: block;
        }

        .team-list {
            display: flex; flex-direction: column; gap: 12px;
            max-width: 500px; margin: 0 auto;
        }
        .team-slot {
            background: white; border: 4px solid #333; padding: 10px;
            display: flex; align-items: center; justify-content: space-between;
            text-decoration: none; transition: transform 0.1s;
        }
        .team-info { display: flex; align-items: center; gap: 15px; }
        .team-name { font-size: 0.8rem; font-weight: bold; text-align: left; text-transform: capitalize;}
        .team-lvl { color: var(--azul-poke); font-size: 0.6rem; margin-top: 4px; text-align: left; }
        
        .slot-empty {
            height: 74px; border: 4px dashed #aaa; background: rgba(255, 255, 255, 0.5);
            color: #888; font-size: 0.6rem; justify-content: center; cursor: pointer;
        }
        .slot-empty:hover { border-color: var(--azul-poke); color: var(--azul-poke); background: #e3f2fd; }
    </style>
</head>
<body>
<section id="view-inicializar" style="display: none; background: var(--fondo); z-index: 2000; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; overflow-y: auto;">
    
    <div style="display: flex; align-items: center; justify-content: center; min-height: 100%; padding: 20px;">
        
        <div class="nes-container is-rounded is-white" style="background: white; max-width: 850px; width: 100%; text-align: center; padding: 40px 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            
            <h1 style="color: var(--azul-poke); margin-bottom: 20px; font-size: 1.5rem; line-height: 1.5;">¬°Bienvenido a<br>Pok√©mon Rancher!</h1>
            <p style="font-size: 0.9rem;">Parece que eres nuevo aqu√≠.</p>
            <p style="margin-bottom: 30px; color: #555; font-size: 0.8rem;">Para comenzar tu aventura, el Profesor te ofrece un compa√±ero:</p>
            
            <div id="lista-starters" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 30px;">
                Cargando...
            </div>
            
        </div>

    </div>
</section>

    <div id="home"></div>
    <div id="granja"></div>
    <div id="habitats"></div>
    <div id="habitat-detalle"></div>
    <div id="poke-interaccion"></div>
    <div id="capturar"></div>
    <div id="captura-escenario"></div>
    <div id="captura-resultado"></div>
    <div id="combates"></div>
    <div id="equipo"></div>
    <div id="caja"></div>
    <nav style="justify-content: space-between; padding: 10px 20px; align-items: center;">
        
        <div style="display: flex; align-items: center; gap: 15px; width: 300px;">
            
            <div style="background: #f1c40f; padding: 5px 10px; border-radius: 5px; border: 4px solid #000; color: #000; font-weight: bold; text-align: center; line-height: 1.2;">
                <div style="font-size: 0.5rem;">NIVEL</div>
                <div id="hud-nivel-num" style="font-size: 1.2rem;">1</div>
            </div>

            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                <div style="display: flex; justify-content: space-between; font-size: 0.6rem; margin-bottom: 5px; color: #666; font-weight: bold;">
                    <span>EXP</span>
                    <span id="hud-xp-texto">0 / 100</span>
                </div>
                <progress id="hud-xp-bar" class="nes-progress is-success" value="0" max="100" style="height: 20px;"></progress>
            </div>
        </div>

       <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <a href="#granja" class="nav-btn">Granja</a>
                <a href="#habitats" class="nav-btn">Habitats</a>
                <a href="#capturar" class="nav-btn">Capturar</a>
                <a href="#combates" class="nav-btn">Combates</a>
                <a href="#equipo" class="nav-btn">Equipo</a>
                <a href="#caja" class="nav-btn">Caja</a>
                
                <span style="color: #ccc;">|</span>
                
                <a href="#home" class="nav-btn">Salir</a>
                
                <button onclick="borrarPartida()" class="nav-btn" style="color: red; border: none; background: transparent; cursor: pointer; font-family: 'Press Start 2P';">Reiniciar</button>
            </div>
    </nav>
 <section id="view-home">
        <div class="logo-db-container" style="max-width: 900px; margin-top: -50px; margin-bottom: 0;">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen-titulo/PokeRancher.png" 
                 alt="Logo Pok√©mon Rancher" class="logo-img" style="max-height: 450px; image-rendering: pixelated; width: 100%; height: auto;">
        </div>
        
        <div class="menu-inicio" style="margin-top: -30px;">
            <a href="#granja" class="nes-btn inicio">
                <span style="font-size: 3rem;">üöú</span>
                GRANJA
            </a>
            <a href="#habitats" class="nes-btn inicio">
                <span style="font-size: 3rem;">üèïÔ∏è</span>
                H√ÅBITATS
            </a>
            <a href="#capturar" class="nes-btn inicio">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Pokebola-pokeball-png-0.png" style="width: 55px; height: 55px; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3));">
                CAPTURAR
            </a>
            <a href="#combates" class="nes-btn inicio">
                <span style="font-size: 3rem;">‚öîÔ∏è</span>
                COMBATES
            </a>
            <a href="#equipo" class="nes-btn inicio">
                <span style="font-size: 3rem;">üõ°Ô∏è</span>
                EQUIPO
            </a>
            <a href="#caja" class="nes-btn inicio">
                <span style="font-size: 3rem;">üì¶</span>
                CAJA
            </a>
        </div>
    </section>
   <section id="view-granja" class="page" style="display: none;">
    <div class="container" style="margin-top: 20px; position: relative;">
        
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 30px; position: relative; height: 60px;">
            
            <div style="text-align: center;">
                <h1 style="margin: 0; font-size: 1.5rem;">Mis Granjas</h1>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.7rem;">Gestiona tus cultivos</p>
            </div>

            <div class="nes-container is-rounded" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); padding: 5px 15px; background: white; display: flex; align-items: center; gap: 10px; z-index: 10;">
                <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen_bayas/Baya_Ziuela_EP.png" width="28">
                <span id="contador-bayas-granja" style="font-weight: bold; font-size: 1rem;">--</span>
            </div>
        </div>

        <div id="lista-granjas" class="granja-grid">
            <p style="text-align:center; width:100%;">Cargando...</p>
        </div>
    </div>
</section>
 <section id="view-habitats" class="page">
    <h1>Gestionar H√°bitats</h1>
    <p>Visita a tus Pok√©mon y alim√©ntalos.</p>
    
    <div class="habitat-grid">
        
        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatllanura.jpg" class="zone-img">
            <div class="zone-body">
                <h3>Pradera (<span id="hab-count-1">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(1)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatbosque.png" class="zone-img">
            <div class="zone-body">
                <h3>Bosque (<span id="hab-count-2">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(2)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatagua.png" class="zone-img">
            <div class="zone-body">
                <h3>Agua (<span id="hab-count-3">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(3)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatacero.png" class="zone-img">
            <div class="zone-body">
                <h3>Acero (<span id="hab-count-4">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(4)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatdesierto.jpeg" class="zone-img">
            <div class="zone-body">
                <h3>Desierto (<span id="hab-count-5">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(5)">Entrar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitathielo.png" class="zone-img">
            <div class="zone-body">
                <h3>Hielo (<span id="hab-count-6">0</span>/6)</h3> 
                <a href="#habitat-detalle" class="nes-btn" onclick="cargarHabitat(6)">Entrar</a>
            </div>
        </div>

    </div>
</section>
    <section id="view-habitat-detalle" class="page">
        <h2 id="titulo-habitat-detalle">Cargando...</h2>
<div class="nes-container is-rounded" style="height: 200px;">
    <img id="fondo-habitat-detalle" src="" class="scene-bg">
</div>
        <div class="habitat-slots" id="lista-slots-habitat">
    </div>
        <a href="#habitats" class="nav-btn" style="display:inline-block; margin-top:20px;">&larr; Volver</a>
    </section>
   <section id="view-poke-interaccion" class="page">
    <div class="nes-container is-rounded" style="background:white; max-width:500px; margin:auto; text-align: left;">
        
        <div style="display:flex; gap:20px; align-items:center; margin-bottom: 20px;">
            
            <div style="text-align: center;">
                <img id="int-img" src="" width="120" style="image-rendering: pixelated; min-height: 120px;">
            </div>
            
            <div style="flex: 1;">
                <h3 id="int-nombre" style="margin:0; font-size: 1.1rem; text-transform: capitalize;">Cargando...</h3>
                
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    <input type="text" id="int-apodo-input" class="nes-input is-success" style="padding: 0 8px; height: 28px; font-size: 0.7rem;" placeholder="Nuevo apodo">
                    <button class="nes-btn is-primary" style="padding: 0 8px; height: 28px; font-size: 0.7rem;" onclick="guardarApodo()">OK</button>
                </div>

                <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: baseline;">
                    <span id="int-nivel" style="color:var(--azul-poke); font-weight: bold; font-size: 0.9rem;">Nivel --</span>
                    <span id="int-xp-text" style="font-size: 0.6rem; color: #666;">XP: --/--</span>
                </div>
                <progress id="int-progress" class="nes-progress is-primary" value="0" max="100" style="height: 15px; margin-top: 4px; width: 100%;"></progress>
            </div>
        </div>

        <div id="zona-evolucion" style="display: none; margin-bottom: 20px; text-align: center; animation: pulse 2s infinite;">
            <p style="color: #27ae60; font-size: 0.7rem; margin-bottom: 10px;">‚ú® ¬°Este Pok√©mon est√° reaccionando! ‚ú®</p>
            <button class="nes-btn is-success" onclick="realizarEvolucion()" style="width: 100%;">
            ¬°EVOLUCIONAR!
            </button>
        </div>

<div style="border-top: 4px dashed #ddd; margin: 20px 0; opacity: 0.6;"></div>

        <div style="border-top: 4px dashed #ddd; margin: 20px 0; opacity: 0.6;"></div>

        <h3 style="text-align: center; color: #e67e22; margin-bottom: 15px; font-size: 1rem;">üçé Zona de Cuidados</h3>
        
        <div style="background: #fffdf6; padding: 15px; border-radius: 12px; border: 3px solid #f0d39e;">
    <p style="text-align: center; font-size: 0.8rem; margin-bottom: 15px;">
        Tu Inventario: <strong id="int-bayas-qty" style="font-size: 1.1rem; color: #d35400;">--</strong> Bayas
    </p>
    
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 5px;">
        <div style="display: flex; align-items: center; gap: 5px;">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen_bayas/Baya_Ziuela_EP.png" width="30">
            <div style="font-size: 0.6rem; line-height: 1.2;">
                <strong style="color: #e67e22;">Baya</strong><br>
                <span>+20 XP</span>
            </div>
        </div>

        <div style="display: flex; gap: 5px;">
            <button class="nes-btn is-error" onclick="abrirMenuSacar()" style="font-size: 0.6rem; padding: 0 8px;" title="Opciones de salida">
            SACAR
            </button>
            
            <button class="nes-btn is-warning" style="font-size: 0.6rem; padding: 0 10px;" onclick="accionAlimentar()">
                COMER
            </button>
        </div>
    </div>
</div>

        <br>
        <button class="nes-btn" style="width: 100%; margin-top: 10px;" onclick="cerrarInteraccion()">Volver</button>
    </div>
</section>
    <section id="view-capturar" class="page">
    <h1>Explorar Zona</h1>
    <p>Elige una zona para buscar Pok√©mon salvajes.</p>
    
    <div class="captura-grid">
        
        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturallanura.png" class="zone-img">
            <div class="zone-body">
                <h3>Pradera</h3>
                <a href="#captura-escenario" class="nes-btn is-primary" onclick="cargarEscenario(1)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturabosque.png" class="zone-img">
            <div class="zone-body">
                <h3>Bosque</h3>
                <a href="#captura-escenario" class="nes-btn is-success" onclick="cargarEscenario(2)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturaplaya.png" class="zone-img">
            <div class="zone-body">
                <h3>Playa</h3>
                <a href="#captura-escenario" class="nes-btn is-primary" onclick="cargarEscenario(3)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturacueva.png" class="zone-img">
            <div class="zone-body">
                <h3>Cueva</h3>
                <a href="#captura-escenario" class="nes-btn is-warning" onclick="cargarEscenario(4)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturadesierto.png" class="zone-img">
            <div class="zone-body">
                <h3>Desierto</h3>
                <a href="#captura-escenario" class="nes-btn is-warning" onclick="cargarEscenario(5)">Buscar</a>
            </div>
        </div>

        <div class="gen-card nes-container is-rounded">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturahielo.png" class="zone-img">
            <div class="zone-body">
                <h3>Nieve</h3>
                <a href="#captura-escenario" class="nes-btn is-primary" onclick="cargarEscenario(6)">Buscar</a>
            </div>
        </div>

    </div>
</section>
    <section id="view-captura-escenario" class="page">
    <h2 id="titulo-zona-captura">Zona Salvaje</h2>
    
    <div class="nes-container is-rounded" style="padding: 0; overflow: hidden; position: relative; height: 300px; border: 4px solid #333;">
        <img id="img-escenario-fondo" src="" style="width: 100%; height: 100%; object-fit: cover;">
        
        <div style="position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
            
            <button id="btn-lanzar" class="nes-btn is-error" onclick="lanzarPokeball()" style="padding: 15px 30px; font-size: 1rem; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 0 #8e0000;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Pokebola-pokeball-png-0.png" style="width:24px; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5));">
                ¬°Lanzar Ball!
            </button>

        </div>
    </div>
    <br>
    <a href="#capturar" class="nes-btn">Huir</a>
</section>

<section id="view-captura-resultado" class="page">
    <div class="nes-container is-rounded" style="background:white; padding:20px; max-width:400px; margin:auto; border: 4px solid #212529;">
        <h3 style="color: #27ae60; text-transform: uppercase;">¬°Te atrap√©!</h3>
        
        <div style="margin: 20px 0; background: #f0f0f0; border-radius: 50%; width: 150px; height: 150px; display: inline-flex; align-items: center; justify-content: center; border: 4px solid #ccc;">
            <img id="res-img-pokemon" src="" width="120" style="image-rendering: pixelated;">
        </div>
        
        <h2 id="res-nombre-pokemon" style="margin-bottom: 5px;">POKEMON</h2>
        <div id="res-tipos-pokemon" style="font-size: 0.7rem; color: #666; margin-bottom: 15px;">Tipo</div>
        
        <p style="font-size: 0.8rem; border-top: 2px dashed #ddd; padding-top: 15px;">
            ¬øQu√© quieres hacer?
        </p>
        
        <<div style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">
            <label>
                <input type="radio" name="decision-captura" value="guardar" checked class="nes-radio">
                <span>Guardar en Caja</span>
            </label>
            <label>
                <input type="radio" name="decision-captura" value="liberar" class="nes-radio is-error">
                <span style="color: #e74c3c;">Liberar</span>
            </label>
        </div>
        
        <br>
        <button class="nes-btn is-primary" onclick="finalizarCaptura()" style="width: 100%;">CONFIRMAR</button>
    </div>
</section>
  <section id="view-caja" class="page">
        <h1 id="titulo-caja">Mi Caja (--/--)</h1>
        <p style="font-size: 0.8rem; color: #666; margin-bottom: 20px;">Aqu√≠ est√°n todos los Pok√©mon que has capturado.</p>
        
        <div id="lista-caja" class="box-grid" style="border-radius: 8px;">
            </div>
        <br>
        <a href="#home" class="nav-btn" style="display:inline-block; margin-top:20px;">&larr; Volver al Inicio</a>
    </section>

    <section id="modal-opciones-caja" class="combat-modal" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8);">
        <div class="nes-container is-rounded is-white" style="background: white; max-width: 350px; width: 90%; text-align: center;">
            <h3 id="caja-poke-nombre" style="text-transform: capitalize;">Pok√©mon</h3>
            
            <div style="background: #f0f0f0; border-radius: 50%; width: 120px; height: 120px; display: inline-flex; align-items: center; justify-content: center; border: 4px solid #ccc; margin: 15px 0;">
                <img id="caja-poke-img" src="" width="90" style="image-rendering: pixelated;">
            </div>
            
            <p style="color: var(--azul-poke); font-weight: bold;">Nivel <span id="caja-poke-nivel"></span></p>
            <p style="font-size: 0.7rem; color: #666; margin-bottom: 20px;" id="caja-poke-tipos"></p>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="nes-btn is-error" id="btn-liberar-caja">üëã Liberar (Adi√≥s)</button>
                <button class="nes-btn" onclick="document.getElementById('modal-opciones-caja').style.display='none'">Cerrar</button>
            </div>
        </div>
    </section>
    <!-- ==================== SECCI√ìN: LISTA DE NIVELES ==================== -->
<section id="view-combates" class="page" style="display: none;">
    <h1>‚öîÔ∏è Combates</h1>
    
    <div id="lista-niveles" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; margin: 0 auto;">
        <!-- Se llenar√° con JavaScript -->
    </div>
</section>
<!-- ==================== SECCI√ìN: DETALLE DEL NIVEL ==================== -->
<section id="view-nivel-detalle" class="combat-modal">
    <div style="max-width: 600px; margin: 0 auto;">
        <h2 id="nivel-titulo" style="text-align: left; margin-bottom: 10px; font-size: 0.9rem;">Nivel 1</h2>
        <h3 id="nivel-nombre" style="text-align: left; margin-bottom: 30px; font-size: 0.9rem;">Nombre rival</h3>
        
        <div style="display: flex; gap: 40px; align-items: flex-start; margin-bottom: 40px;">
            <!-- Imagen del entrenador -->
            <img id="nivel-imagen" src="" style="width: 200px; height: 300px; object-fit: contain;">
            
            <!-- Equipo del rival -->
            <div style="flex: 1;">
                <h3 style="margin-bottom: 15px; font-size: 0.8rem;">Equipo</h3>
                <div id="equipo-rival" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="nes-btn is-warning" onclick="verPrediccion()" style="padding: 15px 40px; font-size: 0.8rem;">
                Ver Predicci√≥n
            </button>
            <br><br>
            <a href="#combates" class="nav-btn" onclick="volverALista()">‚Üê Volver</a>
        </div>
    </div>
</section>
<!-- ==================== SECCI√ìN: PANTALLA DE PREDICCI√ìN ==================== -->
<section id="view-prediccion" class="combat-modal">
    <div style="max-width: 1200px; margin: 0 auto;">
        <h1 style="text-align: center; margin-bottom: 30px; font-size: 1.2rem;">üìä Predicci√≥n de Batalla</h1>
        
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: center; min-height: 400px;">
            <!-- Equipo Jugador (Izquierda) -->
            <div id="equipo-jugador-prediccion">
                <!-- Se llenar√° din√°micamente -->
            </div>
            
            <!-- Resultado Predicho (Centro) -->
            <div style="text-align: center;">
                <div style="width: 220px; height: 220px; border: 5px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); box-shadow: 0 8px 16px rgba(0,0,0,0.2);">
                    <div style="text-align: center;">
                        <div style="font-size: 0.65rem; margin-bottom: 8px; color: #555; letter-spacing: 1px;">RESULTADO</div>
                        <div style="font-size: 0.65rem; margin-bottom: 15px; color: #555; letter-spacing: 1px;">PREDICHO</div>
                        <div id="porcentaje-victoria" style="font-size: 2.5rem; font-weight: bold; color: var(--azul-poke); text-shadow: 2px 2px 4px rgba(0,0,0,0.1); line-height: 1;">--</div>
                        <div id="mensaje-porcentaje" style="font-size: 0.55rem; margin-top: 10px; color: #888; font-weight: normal;">Calculando...</div>
                    </div>
                </div>
            </div>
            
            <!-- Equipo Rival (Derecha) -->
            <div id="equipo-rival-prediccion" style="text-align: right;">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
        
        <!-- Detalles de los combates individuales -->
        <div id="detalles-combates" style="margin-top: 30px; padding: 20px; background: white; border: 4px solid #333; border-radius: 10px;">
            <h3 style="font-size: 0.8rem; margin-bottom: 15px; text-align: center;">‚öîÔ∏è Combates 1 vs 1</h3>
            <p style="font-size: 0.55rem; text-align: center; color: #666; margin-bottom: 15px;">Necesitas ganar 3 o m√°s combates para ganar la batalla</p>
            <div id="lista-predicciones" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
        
        <!-- Botones de acci√≥n -->
        <div style="text-align: center; margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
            <button class="nes-btn is-error" onclick="volverADetalleNivel()" style="padding: 15px 30px; font-size: 0.8rem;">
                ‚Üê Cancelar
            </button>
            <button class="nes-btn is-success" onclick="ejecutarCombate()" style="padding: 15px 50px; font-size: 0.8rem;">
                ‚öîÔ∏è COMBATIR
            </button>
        </div>
    </div>
</section>
<!-- ==================== SECCI√ìN: RESULTADO ==================== -->
<section id="view-resultado" class="combat-modal">
    <div style="max-width: 700px; margin: 0 auto; text-align: center;">
        <h1 id="resultado-titulo" style="font-size: 2.5rem; margin-bottom: 20px;">Gan√≥ o Perdi√≥</h1>
        <p id="resultado-mensaje" style="font-size: 0.8rem; color: #666; margin-bottom: 40px;">Mensaje del resultado</p>
        
        <!-- Recompensas -->
        <div style="background: white; border: 4px solid #333; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
            <h2 style="font-size: 1rem; margin-bottom: 20px;">üéÅ Recompensas</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- XP del Jugador -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 2px solid var(--azul-poke);">
                    <div style="font-size: 0.6rem; color: #666; margin-bottom: 5px;">JUGADOR</div>
                    <div id="xp-jugador-ganada" style="font-size: 1.5rem; font-weight: bold; color: var(--azul-poke);">+100 XP</div>
                    <div id="jugador-subio-nivel" style="font-size: 0.6rem; color: #27ae60; margin-top: 5px; display: none;">
                        üéâ ¬°Subiste de nivel!
                    </div>
                </div>
                
                <!-- XP de Pok√©mon -->
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border: 2px solid #ff9800;">
                    <div style="font-size: 0.6rem; color: #666; margin-bottom: 5px;">CADA POK√âMON</div>
                    <div id="xp-pokemon-ganada" style="font-size: 1.5rem; font-weight: bold; color: #ff9800;">+30 XP</div>
                    <div style="font-size: 0.55rem; color: #666; margin-top: 5px;" id="total-pokemons-text">5 Pok√©mon</div>
                </div>
            </div>
        </div>
        
        <!-- Pok√©mon que subieron de nivel -->
        <div id="resultado-content" style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 20px; font-size: 0.9rem;">‚¨ÜÔ∏è Pok√©mon que subieron de nivel</h3>
            <div id="pokemons-subieron" style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
        
        <button class="nes-btn is-primary" onclick="volverALista()" style="padding: 15px 60px; font-size: 0.9rem;">
            Continuar
        </button>
    </div>
</section>
   <section id="view-equipo" class="page">
        <h1>Mi Equipo</h1>
        <p style="margin-bottom: 25px; font-size: 0.7rem;">Selecciona tus 5 Pok√©mon para el combate. <br>¬°El orden importa!</p>

        <div id="lista-equipo" class="team-list">
            </div>

        <a href="#caja" class="nav-btn" style="display:inline-block; margin-top:20px;">&larr; VER CAJA</a>
    </section>

    <section id="modal-seleccion-equipo" class="combat-modal" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8);">
        <div class="nes-container is-rounded is-white" style="max-width: 600px; width: 90%; background: white;">
            <h2 style="text-align: center;">Elegir Pok√©mon</h2>
            <p style="text-align: center; font-size: 0.6rem; color: #666;">Selecciona un Pok√©mon de tu caja.</p>
            
            <div id="lista-candidatos-equipo" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px;">
                Cargando...
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="nes-btn is-error" onclick="cerrarModalEquipo()">Cancelar</button>
            </div>
        </div>
    </section>>
    <section id="modal-seleccion-habitat" class="combat-modal">
    <div class="nes-container is-rounded is-white" style="max-width: 600px; margin: 20px auto; background: white;">
        <h2 style="text-align: center;">Elige un Pok√©mon</h2>
        <p style="text-align: center; font-size: 0.7rem;">Solo ver√°s los que no est√°n ocupados.</p>
        
        <div id="lista-candidatos-habitat" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px;">
            Cargando...
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="nes-btn is-error" onclick="cerrarModalSeleccion()">Cancelar</button>
        </div>
    </div>
</section>
<section id="modal-sacar-opciones" class="combat-modal" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8);">
    <div class="nes-container is-rounded is-white" style="background: white; max-width: 400px; width: 90%; text-align: center;">
        
        <h3 style="color: #e74c3c;">Sacar Pok√©mon</h3>
        <p>¬øQu√© quieres hacer con <strong id="nombre-sacar-pokemon">este Pok√©mon</strong>?</p>
        
        <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
            
            <button class="nes-btn is-primary" onclick="ejecutarSalida('caja')">
                üì¶ Guardar en la Caja
            </button>
            <span style="font-size: 0.6rem; color: #666;">Se quita del h√°bitat pero te lo quedas.</span>

            <button class="nes-btn is-error" onclick="ejecutarSalida('liberar')">
                üëã Liberar (Adi√≥s)
            </button>
            <span style="font-size: 0.6rem; color: red;">Lo pierdes para siempre.</span>
        
        </div>

        <button class="nes-btn" onclick="document.getElementById('modal-sacar-opciones').style.display='none'">
            Cancelar
        </button>
    </div>
</section>
    <script>
const API_URL = 'https://pokemon-rancher-2c7u.onrender.com/api';
let entrenadores = [];
let entrenadorSeleccionado = null;
let resultadoCombate = null;
let efectividades = [];
let equipoJugador = [];

console.log('‚úÖ Script de combates cargado');

/// ========== DETECTAR CAMBIO DE HASH (NAVEGACI√ìN) ==========
window.addEventListener('hashchange', () => {
    const hash = window.location.hash;
    const viewCombates = document.getElementById('view-combates');
    
    actualizarHUDJugador();         
    actualizarContadoresBayas();

    // 1. Ocultar combates si salimos de ah√≠
    if (hash !== '#combates') {
        viewCombates.style.display = 'none';
    }

    // 2. Cargar la secci√≥n correspondiente
    if (hash === '#combates') {
        viewCombates.style.display = 'block';
        cargarCombates();
    } 
    else if (hash === '#habitats') {
        actualizarContadoresHabitat();
    } 
    else if (hash === '#granja') {  
        cargarGranja();
    }
    else if (hash === '#caja') {
        cargarCaja();
    }
    else if (hash === '#equipo') {
        cargarEquipo();
    }
});

// ========== CARGAR AL INICIO (REFRESH) ==========
window.addEventListener('DOMContentLoaded', async () => {
    await verificarEstadoJuego();

    actualizarHUDJugador();       
    actualizarContadoresBayas();

    try {
        const res = await fetch(`${API_URL}/tipo-efectividad`);
        if (res.ok) efectividades = await res.json();
    } catch (error) { console.error(error); }

    const hash = window.location.hash;
    
    // Cargar la vista inicial si estamos en una espec√≠fica
    if (hash === '#combates') {
        document.getElementById('view-combates').style.display = 'block';
        cargarCombates();
    } else if (hash === '#granja') { // <--- ESTO TAMBI√âN FALTABA
        cargarGranja();
    } else if (hash === '#habitats') {
        actualizarContadoresHabitat();
    }
    else if (hash === '#caja') {
        cargarCaja();
    }
});
// ========== CARGAR NIVELES ==========
async function cargarCombates() {
    console.log('üîÑ Cargando combates...');
    
    try {
        const res = await fetch(`${API_URL}/entrenadores`);
        
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        entrenadores = await res.json();
        console.log('‚úÖ Entrenadores cargados:', entrenadores);
        
        const html = entrenadores.map(e => {
            const bloqueado = !e.desbloqueado;
            const derrotado = parseInt(e.victorias) > 0;
            
            return `
                <button 
                    class="nes-btn ${bloqueado ? 'is-disabled' : (derrotado ? 'is-success' : '')}" 
                    ${bloqueado ? 'disabled' : ''}
                    onclick="verNivel(${e.id})"
                    style="padding: 20px; font-size: 0.8rem; position: relative;">
                    ${bloqueado ? 'üîí ' : ''}Nivel ${e.nivel}
                    ${derrotado ? '<br><span style="font-size: 0.6rem;">‚úì Completado</span>' : ''}
                </button>
            `;
        }).join('');
        
        document.getElementById('lista-niveles').innerHTML = html;
        console.log('‚úÖ HTML renderizado');
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        document.getElementById('lista-niveles').innerHTML = `
            <div style="grid-column: 1/-1; text-align: center;" class="nes-text is-error">
                <p>Error al cargar entrenadores</p>
                <p style="font-size: 0.6rem;">${error.message}</p>
                <p style="font-size: 0.6rem;">¬øBackend corriendo en ${API_URL}?</p>
            </div>
        `;
    }
}

// ========== VER DETALLE DEL NIVEL ==========
async function verNivel(id) {
    console.log('üëÅÔ∏è Ver nivel:', id);
    
    try {
        const res = await fetch(`${API_URL}/entrenadores/${id}`);
        entrenadorSeleccionado = await res.json();
        console.log('‚úÖ Entrenador cargado:', entrenadorSeleccionado);
        
        document.getElementById('nivel-titulo').textContent = `Nivel ${entrenadorSeleccionado.nivel}`;
        document.getElementById('nivel-nombre').textContent = entrenadorSeleccionado.nombre;
        document.getElementById('nivel-imagen').src = entrenadorSeleccionado.imagen_url;
        
        const equipoHTML = entrenadorSeleccionado.pokemons.map(p => `
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border: 3px solid #333; border-radius: 8px; background: white;">
                <img src="${p.imagen_url}" width="50" style="border: 2px solid #333; border-radius: 5px;"
                     onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png'">
                <div style="text-align: left; flex: 1;">
                    <div style="font-size: 0.7rem; text-transform: capitalize;">${p.nombre}</div>
                    <div style="font-size: 0.6rem; color: #666;">${p.tipos.join(' / ')}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Lvl ${p.nivel}</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('equipo-rival').innerHTML = equipoHTML;
        
        // Mostrar detalle
        document.getElementById('view-nivel-detalle').classList.add('active');
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al cargar el entrenador: ' + error.message);
    }
}

// ========== CALCULAR MULTIPLICADOR (CLIENTE) ==========

function calcularMultiplicadorCliente(tiposAtacante, tiposDefensor, efectividades) {
    let sumaEfectividad = 0;
    
    if (!Array.isArray(efectividades)) {
        console.error('‚ùå efectividades no es un array');
        return 0;
    }

    for (const tipoAtacante of tiposAtacante) {
        for (const tipoDefensor of tiposDefensor) {
            const efectividad = efectividades.find(
                e => e.tipo_atacante === tipoAtacante && e.tipo_defensor === tipoDefensor
            );
            
            if (efectividad) {
                sumaEfectividad += parseFloat(efectividad.multiplicador);
            } else {
                sumaEfectividad += 1.0; // Da√±o neutro si no encuentra registro
            }
        }
    }
    
    return sumaEfectividad;
}

// ========== VER PREDICCI√ìN ==========
async function verPrediccion() {
    console.log('üîÆ Mostrando predicci√≥n...');
    
    try {
        // Cargar efectividades si no est√°n disponibles
        if (!efectividades || efectividades.length === 0) {
            console.log('‚ö†Ô∏è Cargando efectividades...');
            const resEfectividad = await fetch(`${API_URL}/tipo-efectividad`);
            efectividades = await resEfectividad.json();
            console.log('‚úÖ Efectividades cargadas:', efectividades.length);
        }
        
        // Obtener equipo del jugador
        const equipoRes = await fetch(`${API_URL}/jugador/equipo`);
        equipoJugador = await equipoRes.json();
        console.log('üë• Equipo jugador:', equipoJugador);
        
        if (equipoJugador.error || equipoJugador.length === 0) {
            alert('‚ùå No ten√©s Pok√©mon en tu equipo. Agreg√° al menos uno antes de combatir.');
            return;
        }
        
        // Ocultar detalle, mostrar predicci√≥n
        document.getElementById('view-nivel-detalle').classList.remove('active');
        document.getElementById('view-prediccion').classList.add('active');
        
        // Renderizar equipos
        const jugadorHTML = equipoJugador.map(p => `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; border: 3px solid #333; border-radius: 8px; background: white;">
                <img src="${p.imagen_url}" width="50" style="border: 2px solid #333; border-radius: 5px;"
                     onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png'">
                <div style="text-align: left;">
                    <div style="font-size: 0.7rem; text-transform: capitalize;">${p.apodo || p.nombre}</div>
                    <div style="font-size: 0.6rem; color: #666;">${p.tipos.join(' / ')}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Lvl ${p.nivel}</div>
                </div>
            </div>
        `).join('');
        
        const rivalHTML = entrenadorSeleccionado.pokemons.map(p => `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; border: 3px solid #333; border-radius: 8px; background: white; justify-content: flex-end;">
                <div style="text-align: right;">
                    <div style="font-size: 0.7rem; text-transform: capitalize;">${p.nombre}</div>
                    <div style="font-size: 0.6rem; color: #666;">${p.tipos.join(' / ')}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Lvl ${p.nivel}</div>
                </div>
                <img src="${p.imagen_url}" width="50" style="border: 2px solid #333; border-radius: 5px;"
                     onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png'">
            </div>
        `).join('');
        
        document.getElementById('equipo-jugador-prediccion').innerHTML = jugadorHTML;
        document.getElementById('equipo-rival-prediccion').innerHTML = rivalHTML;
        
        // ========== CALCULAR PREDICCI√ìN ==========
        const totalCombates = Math.min(equipoJugador.length, entrenadorSeleccionado.pokemons.length, 5);
        const predicciones = [];

        for (let i = 0; i < totalCombates; i++) {
            const pokemonJugador = equipoJugador[i];
            const pokemonRival = entrenadorSeleccionado.pokemons[i];

            const multiplicadorJugador = calcularMultiplicadorCliente(
                pokemonJugador.tipos,
                pokemonRival.tipos,
                efectividades
            );

            const multiplicadorRival = calcularMultiplicadorCliente(
                pokemonRival.tipos,
                pokemonJugador.tipos,
                efectividades
            );

            const poderJugador = pokemonJugador.nivel * multiplicadorJugador;
            const poderRival = pokemonRival.nivel * multiplicadorRival;
            
            const ganadorPredicho = poderJugador > poderRival ? 'jugador' : 'rival';
            
            predicciones.push({
                numero: i + 1,
                pokemonJugador: pokemonJugador.apodo || pokemonJugador.nombre,
                pokemonRival: pokemonRival.nombre,
                poderJugador: poderJugador.toFixed(2),
                poderRival: poderRival.toFixed(2),
                multiplicadorJugador: multiplicadorJugador.toFixed(2),
                multiplicadorRival: multiplicadorRival.toFixed(2),
                ganador: ganadorPredicho
            });
        }

        // Calcular resultado
        let victoriasPredichasJugador = 0;
        let victoriasPredichasRival = 0;
        
        predicciones.forEach(p => {
            if (p.ganador === 'jugador') {
                victoriasPredichasJugador++;
            } else {
                victoriasPredichasRival++;
            }
        });
        
        const ganarasLaBatalla = victoriasPredichasJugador >= 3;
        const mensajeResultado = `${victoriasPredichasJugador} vs ${victoriasPredichasRival}`;
        
        console.log('\nüèÜ PREDICCI√ìN:');
        console.log('   Victorias Jugador:', victoriasPredichasJugador);
        console.log('   Victorias Rival:', victoriasPredichasRival);
        console.log('   Resultado predicho:', ganarasLaBatalla ? 'VICTORIA' : 'DERROTA\n');
        
        // Mostrar predicciones
        const prediccionesHTML = predicciones.map(p => `
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; padding: 8px; border: 2px solid ${p.ganador === 'jugador' ? '#27ae60' : '#e74c3c'}; border-radius: 5px; background: ${p.ganador === 'jugador' ? '#e8f5e9' : '#ffebee'};">
                <div style="text-align: left; font-size: 0.6rem;">
                    <div style="font-weight: bold;">${p.pokemonJugador}</div>
                    <div style="color: #666;">Poder: ${p.poderJugador} (√ó${p.multiplicadorJugador})</div>
                </div>
                <div style="font-size: 0.7rem; font-weight: bold;">
                    ${p.ganador === 'jugador' ? '‚úÖ' : '‚ùå'}
                </div>
                <div style="text-align: right; font-size: 0.6rem;">
                    <div style="font-weight: bold;">${p.pokemonRival}</div>
                    <div style="color: #666;">Poder: ${p.poderRival} (√ó${p.multiplicadorRival})</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('lista-predicciones').innerHTML = prediccionesHTML;
        
        // Mostrar resultado predicho
        const porcentajeElement = document.getElementById('porcentaje-victoria');
        const mensajeElement = document.getElementById('mensaje-porcentaje');
        
        porcentajeElement.textContent = mensajeResultado;
        porcentajeElement.style.fontSize = '2rem';
        
        if (ganarasLaBatalla) {
            porcentajeElement.style.color = '#27ae60';
            mensajeElement.textContent = '¬°Vas a ganar!';
            mensajeElement.style.color = '#27ae60';
        } else {
            porcentajeElement.style.color = '#e74c3c';
            mensajeElement.textContent = 'Vas a perder';
            mensajeElement.style.color = '#e74c3c';
        }
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al calcular predicci√≥n: ' + error.message);
    }
}

// ========== VOLVER AL DETALLE DEL NIVEL ==========
function volverADetalleNivel() {
    document.getElementById('view-prediccion').classList.remove('active');
    document.getElementById('view-nivel-detalle').classList.add('active');
}

// ========== EJECUTAR COMBATE ==========
async function ejecutarCombate() {
    console.log('üé≤ Ejecutando combate...');
    
    try {
        const res = await fetch(`${API_URL}/entrenadores/${entrenadorSeleccionado.id}/combatir`, {
            method: 'POST'
        });
        
        resultadoCombate = await res.json();
        console.log('üìä Resultado:', resultadoCombate);
        
        if (resultadoCombate.error) {
            alert(`‚ùå ${resultadoCombate.mensaje || resultadoCombate.error}`);
            volverALista();
            return;
        }
        
        mostrarResultado();
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error durante el combate: ' + error.message);
        volverALista();
    }
}

// ========== MOSTRAR RESULTADO ==========
function mostrarResultado() {
    console.log('üìã Mostrando resultado...');
    
    document.getElementById('view-prediccion').classList.remove('active');
    document.getElementById('view-resultado').classList.add('active');
    
    const gano = resultadoCombate.resultado === 'victoria';
    
    // T√≠tulo y mensaje
    document.getElementById('resultado-titulo').textContent = gano ? 'üéâ ¬°Ganaste!' : 'üíî Perdiste';
    document.getElementById('resultado-titulo').style.color = gano ? 'green' : 'red';
    document.getElementById('resultado-mensaje').textContent = resultadoCombate.mensaje;
    
    // Mostrar recompensas de XP
    document.getElementById('xp-jugador-ganada').textContent = `+${resultadoCombate.xp_jugador} XP`;
    document.getElementById('xp-pokemon-ganada').textContent = `+${resultadoCombate.xp_pokemon} XP`;
    document.getElementById('total-pokemons-text').textContent = `${resultadoCombate.total_pokemons} Pok√©mon`;
    
    // Mostrar si el jugador subi√≥ de nivel
    const jugadorSubioElement = document.getElementById('jugador-subio-nivel');
    if (resultadoCombate.jugador_subio_nivel) {
        jugadorSubioElement.style.display = 'block';
        jugadorSubioElement.textContent = `üéâ ¬°Subiste al nivel ${resultadoCombate.jugador_niveles_subidos[resultadoCombate.jugador_niveles_subidos.length - 1]}!`;
    } else {
        jugadorSubioElement.style.display = 'none';
    }
    
    // Filtrar solo Pok√©mon que subieron de nivel
    const subieron = resultadoCombate.pokemons_actualizados.filter(p => p.subio_nivel);
    console.log('‚¨ÜÔ∏è Pok√©mon que subieron:', subieron);
    
    if (subieron.length === 0) {
        document.getElementById('pokemons-subieron').innerHTML = `
            <p style="font-size: 0.7rem; color: #999;">Ning√∫n Pok√©mon subi√≥ de nivel</p>
        `;
    } else {
        const pokemonsHTML = subieron.map(p => `
            <div style="display: flex; align-items: center; gap: 15px; padding: 10px; border: 3px solid #27ae60; border-radius: 8px; background: #e8f5e9; width: 100%; max-width: 400px;">
                <div style="font-size: 2rem;">‚¨ÜÔ∏è</div>
                <div style="text-align: left; flex: 1;">
                    <div style="font-size: 0.8rem; text-transform: capitalize; font-weight: bold;">${p.pokemon}</div>
                    <div style="font-size: 0.7rem; color: #27ae60;">
                        Subi√≥ al nivel ${p.niveles_subidos.join(', ')}
                    </div>
                    <div style="font-size: 0.6rem; color: #666;">
                        +${p.xp_ganada} XP
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('pokemons-subieron').innerHTML = pokemonsHTML;
    }
}

// ========== VOLVER A LA LISTA ==========
function volverALista() {
    console.log('üîô Volviendo a lista...');
    
    // Quitar todas las clases active de los modals
    document.getElementById('view-nivel-detalle').classList.remove('active');
    document.getElementById('view-prediccion').classList.remove('active');
    document.getElementById('view-resultado').classList.remove('active');
    
    entrenadorSeleccionado = null;
    resultadoCombate = null;
    
    window.location.hash = '#combates';
    cargarCombates();
    actualizarHUDJugador();
}

// ========== ACTUALIZAR CONTADORES DE H√ÅBITAT ==========
async function actualizarContadoresHabitat() {
    console.log('üîÑ Actualizando contadores de h√°bitat...');
    try {
        const res = await fetch(`${API_URL}/jugador/habitats`);
        if (!res.ok) throw new Error('Error al cargar habitats');
        
        const habitats = await res.json();
        
        // 1. Reseteamos todos a 0 visualmente
        for (let i = 1; i <= 6; i++) {
            const contador = document.getElementById(`hab-count-${i}`);
            if (contador) contador.textContent = '0';
        }

        // 2. Actualizamos con la info real de la base de datos
        // Aseg√∫rate de que tu API devuelva "habitat_id" y "cantidad_pokemons" (o el nombre que tenga tu columna count)
        habitats.forEach(h => {
            const idHabitat = h.habitat_id || h.id; // Ajusta seg√∫n tu API
            const cantidad = h.cantidad_pokemons || h.total || h.count || 0;
            
            const contador = document.getElementById(`hab-count-${idHabitat}`);
            if (contador) {
                contador.textContent = cantidad;
            }
        });

    } catch (error) {
        console.error('‚ùå Error actualizando contadores:', error);
    }
}

// Diccionario con las fotos de fondo de cada h√°bitat
const infoHabitats = {
    1: { nombre: 'Pradera', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatllanura.jpg' },
    2: { nombre: 'Bosque', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatbosque.png' },
    3: { nombre: 'Agua', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatagua.png' },
    4: { nombre: 'Acero', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatacero.png' },
    5: { nombre: 'Desierto', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatdesierto.jpeg' },
    6: { nombre: 'Hielo', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitathielo.png' }
};

let habitatActualId = null;

async function cargarHabitat(id) {
    console.log('üå≤ Cargando h√°bitat:', id);
    habitatActualId = id;
    
    // 1. CAMBIAR FONDO Y T√çTULO SEG√öN EL H√ÅBITAT
    const info = infoHabitats[id];
    if (info) {
        document.getElementById('titulo-habitat-detalle').textContent = info.nombre;
        document.getElementById('fondo-habitat-detalle').src = info.fondo;
    }

    // 2. PEDIR POK√âMONS A LA API
    try {
        const res = await fetch(`${API_URL}/jugador/habitats/${id}/pokemons`);
        const pokemons = await res.json();
        
        const contenedor = document.getElementById('lista-slots-habitat');
        contenedor.innerHTML = ''; 

        for (let i = 0; i < 6; i++) {
            const pokemon = pokemons[i];

            if (pokemon) {
                // Pasamos la URL de la foto para que la interacci√≥n la use despu√©s
                contenedor.innerHTML += `
                    <a href="#poke-interaccion" class="poke-slot" 
                       onclick="interactuarPokemon(${pokemon.id}, '${pokemon.imagen_url}')">
                        <img src="${pokemon.imagen_url}" width="50">
                        <div>${pokemon.apodo || pokemon.nombre}</div>
                        <div style="color:var(--azul-poke);">Nvl ${pokemon.nivel}</div>
                    </a>
                `;
            } else {
                contenedor.innerHTML += `
                    <div class="poke-slot empty" onclick="abrirModalSeleccion(${id})">
                        + A√±adir
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error cargando habitat:', error);
    }
}
// Variable para recordar en qu√© h√°bitat estamos intentando a√±adir
let habitatSeleccionadoId = null;

// 1. ABRIR EL MODAL Y CARGAR POK√âMON DISPONIBLES
// Variable para recordar qu√© tipos permite el h√°bitat actual
let tiposPermitidosHabitat = [];

async function abrirModalSeleccion(idHabitat) {
    habitatSeleccionadoId = idHabitat;
    document.getElementById('modal-seleccion-habitat').classList.add('active');
    
    const contenedor = document.getElementById('lista-candidatos-habitat');
    contenedor.innerHTML = '<p>Cargando compatibles...</p>';

    try {
        // 1. Obtener Tipos Permitidos del Backend
        const resTipos = await fetch(`${API_URL}/habitats/${idHabitat}/tipos`);
        tiposPermitidosHabitat = await resTipos.json();
        
        // Actualizar t√≠tulo del modal
        const tituloModal = document.querySelector('#modal-seleccion-habitat h2');
        tituloModal.innerHTML = `Elige un Pok√©mon<br><span style="font-size:0.6rem; color:#666;">Admite: ${tiposPermitidosHabitat.join(', ')}</span>`;

        //Pedimos Pok√©mon y Ocupados al mismo tiempo <---
        const [res, idsEnHabitats] = await Promise.all([
            fetch(`${API_URL}/jugador/pokemons`),
            obtenerIdsPokemonsEnHabitats()
        ]);
        const pokemons = await res.json();

        //Filtrar compatibles Y libres <---
        const compatibles = pokemons.filter(p => {
            const idReal = p.jugador_pokemon_id || p.id;
            const esTipoValido = p.tipos.some(tipo => tiposPermitidosHabitat.includes(tipo));
            const estaLibre = !idsEnHabitats.includes(idReal); // <-- Filtro de ocupados
            
            return esTipoValido && estaLibre;
        });
        
        let html = '';
        
        if (compatibles.length === 0) {
            html = `
                <div style="grid-column: 1/-1; text-align: center; color: #e74c3c;">
                    <p>No tienes Pok√©mon disponibles.</p>
                    <p style="font-size: 0.7rem;">Necesitas tipos: ${tiposPermitidosHabitat.join(', ')}</p>
                    <p style="font-size: 0.6rem; color: #666;">(Si ya tienes de este tipo, s√°calos de otro h√°bitat primero)</p>
                </div>`;
        } else {
            compatibles.forEach(p => {
                const idReal = p.id || p.jugador_pokemon_id;
                
                // Mostrar tipos del Pok√©mon
                const tiposBadges = p.tipos.map(t => 
                    `<span style="font-size:0.5rem; background:#eee; padding:2px 4px; border-radius:3px;">${t}</span>`
                ).join(' ');

                html += `
                <div style="border: 2px solid #ccc; padding: 5px; display: flex; align-items: center; gap: 10px; cursor: pointer; background: white;" 
                     class="nes-pointer"
                     onclick="enviarPokemonAlHabitat(${idReal})">  
                    <img src="${p.imagen_url}" width="40">
                    <div>
                        <div style="font-size: 0.7rem; font-weight: bold;">${p.apodo || p.nombre}</div>
                        <div style="font-size: 0.6rem;">Nvl ${p.nivel}</div>
                        <div style="margin-top:2px;">${tiposBadges}</div>
                    </div>
                </div>
                `;
            });
        }

        contenedor.innerHTML = html;

    } catch (error) {
        console.error(error);
        contenedor.innerHTML = '<p>Error al cargar.</p>';
    }
}


// 2. ENVIAR EL POK√âMON SELECCIONADO AL SERVIDOR
// 2. ENVIAR EL POK√âMON SELECCIONADO AL SERVIDOR
async function enviarPokemonAlHabitat(jugadorPokemonId) {
    if (!habitatSeleccionadoId) return;

    // IMPORTANTE: Guardamos el ID en una variable local porque 
    // cerrarModalSeleccion() va a borrar la variable global.
    const idParaRecargar = habitatSeleccionadoId;

    // Efecto visual
    const lista = document.getElementById('lista-candidatos-habitat');
    lista.innerHTML = '<p style="text-align:center;">Asignando...</p>';

    try {
        const res = await fetch(`${API_URL}/jugador/habitats/${idParaRecargar}/asignar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jugador_pokemon_id: jugadorPokemonId })
        });

        const data = await res.json();

        if (data.error) {
            alert('‚ùå Error: ' + data.error);
            // Si fall√≥, volvemos a abrir la selecci√≥n para ese h√°bitat
            abrirModalSeleccion(idParaRecargar);
        } else {
            alert('‚úÖ ¬°Pok√©mon a√±adido al h√°bitat!');
            
            // 1. Cerramos el modal (esto borra habitatSeleccionadoId global)
            cerrarModalSeleccion();
            
            // 2. Recargamos usando la VARIABLE LOCAL que guardamos al principio
            await cargarHabitat(idParaRecargar); 
            
            // 3. Actualizamos el contador (ej: 2/6)
            actualizarContadoresHabitat(); 
        }

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}
// 3. CERRAR MODAL
function cerrarModalSeleccion() {
    document.getElementById('modal-seleccion-habitat').classList.remove('active');
    habitatSeleccionadoId = null;
}
// ==================== L√ìGICA DE INICIALIZACI√ìN ====================

async function verificarEstadoJuego() {
    try {
        // Intentamos obtener los datos del jugador
        const res = await fetch(`${API_URL}/jugador`);
        
        if (res.status === 404) {
            // SI NO EXISTE JUGADOR (404) -> MOSTRAR PANTALLA DE SELECCI√ìN
            console.log('üÜï Nuevo jugador detectado. Iniciando selecci√≥n de starter...');
            document.getElementById('view-inicializar').style.display = 'block';
            cargarStarters();
        } else {
            // SI EXISTE -> OCULTAR PANTALLA DE SELECCI√ìN
            document.getElementById('view-inicializar').style.display = 'none';
        }
    } catch (error) {
        console.error('Error verificando estado:', error);
    }
}

async function cargarStarters() {
    try {
        const res = await fetch(`${API_URL}/inicializar/starters`);
        const starters = await res.json();
        
        const contenedor = document.getElementById('lista-starters');
        
        contenedor.innerHTML = starters.map(p => `
            <div class="nes-container is-rounded is-centered with-title" style="width: 220px; cursor: pointer; background: white;" onclick="elegirStarter(${p.id})">
                <p class="title">${p.nombre}</p>
                <img src="${p.imagen_url}" width="120" style="margin-bottom: 10px;">
                <div>
                    <span class="nes-text is-primary">Tipo: ${p.tipos.join('/')}</span>
                </div>
                <br>
                <button class="nes-btn is-success">¬°Te elijo a ti!</button>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error cargando starters:', error);
        document.getElementById('lista-starters').innerHTML = '<p class="nes-text is-error">Error al conectar con el servidor.</p>';
    }
}

async function elegirStarter(idPokemon) {
    if (!confirm("¬øEst√°s seguro de tu elecci√≥n? No podr√°s cambiarlo.")) return;

    try {
        const res = await fetch(`${API_URL}/inicializar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pokemon_starter_id: idPokemon })
        });

        const data = await res.json();

        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(`¬°Genial! Has comenzado tu aventura con ${data.pokemon_starter.nombre}.`);
            // Recargar la p√°gina para entrar al juego normal
            window.location.href = "#home";
            location.reload();
        }

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

// Variable global
let pokemonInteraccionId = null;

async function interactuarPokemon(id, imgUrl) {
    pokemonInteraccionId = id;
    console.log('ü•ï Interactuando con:', id);
    
    // Cambiamos de vista
    window.location.hash = '#poke-interaccion';
    
    // 1. FOTO: Ponemos la foto que recibimos del h√°bitat
    if (imgUrl) {
        document.getElementById('int-img').src = imgUrl;
    }

    // 2. TEXTOS: Resetear mientras carga
    document.getElementById('int-nombre').textContent = 'Cargando...';
    document.getElementById('int-apodo-input').value = '';
    document.getElementById('int-bayas-qty').textContent = '--'; 

    // 3. CARGAR INVENTARIO (Agregamos el AWAIT aqu√≠)
    await actualizarContadoresBayas(); // <--- ¬°Aseg√∫rate de que tenga el await!
    
    try {
        // ... resto del c√≥digo ...
        // 4. CARGAR DATOS DEL POK√âMON
        const resPoke = await fetch(`${API_URL}/jugador/pokemons/${id}/nivel`);
        const dataPoke = await resPoke.json();
        
        // Actualizar textos
        const nombreMostrar = dataPoke.apodo || dataPoke.pokemon || 'Pok√©mon';
        document.getElementById('int-nombre').textContent = nombreMostrar;
        document.getElementById('int-apodo-input').placeholder = "Cambiar nombre";
        
        // Actualizar barra de nivel
        actualizarBarraXP(dataPoke);
        await verificarEvolucionUI(id);

    } catch (error) {
        console.error(error);
        alert('Error al cargar datos del Pok√©mon');
    }
}
// Helper para actualizar la barra visualmente
function actualizarBarraXP(data) {
    document.getElementById('int-nivel').textContent = `Nivel ${data.nivel}`;
    
    // Si es nivel m√°ximo
    if (data.max_nivel) {
        document.getElementById('int-xp-text').textContent = 'M√ÅXIMO';
        document.getElementById('int-progress').value = 100;
        document.getElementById('int-progress').classList.remove('is-primary');
        document.getElementById('int-progress').classList.add('is-warning');
    } else {
        document.getElementById('int-xp-text').textContent = `XP: ${data.xp_en_nivel_actual} / ${data.xp_para_subir}`;
        document.getElementById('int-progress').value = data.porcentaje_progreso;
        document.getElementById('int-progress').classList.remove('is-warning');
        document.getElementById('int-progress').classList.add('is-primary');
    }
}

// 2. ALIMENTAR POK√âMON
async function accionAlimentar() {
    if (!pokemonInteraccionId) return;
    
    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/alimentar`, {
            method: 'POST'
        });
        const data = await res.json();
        
        if (data.error) {
            alert('‚ùå ' + (data.mensaje || data.error));
        } else {
            // Obligamos a la pantalla de cuidados a leer el nuevo total de Neon
            await actualizarContadoresBayas(); 
            
            // Actualizamos la barra de nivel del Pok√©mon
            const resPoke = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/nivel`);
            const dataPoke = await resPoke.json();
            actualizarBarraXP(dataPoke);
        
            if (data.subio_nivel) {
                alert(`üéâ ¬°Subi√≥ de nivel!`);
                await verificarEvolucionUI(pokemonInteraccionId);
            }
        }
            
            // Recargar barra de XP visualmente
            const resPoke = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/nivel`);
            const dataPoke = await resPoke.json();
            actualizarBarraXP(dataPoke);
        
    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

// 4. QUITAR DEL H√ÅBITAT
async function accionQuitarDelHabitat() {
    if (!pokemonInteraccionId || !habitatActualId) return;

    if (!confirm("¬øQuieres devolver este Pok√©mon a la caja?")) return;

    try {
        // Llamamos a DELETE en la API
        const res = await fetch(`${API_URL}/jugador/habitats/${habitatActualId}/pokemons/${pokemonInteraccionId}`, {
            method: 'DELETE'
        });
        const data = await res.json();

        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // √âXITO: Cerramos la interacci√≥n. 
            // La funci√≥n cerrarInteraccion() ya se encarga de recargar el h√°bitat autom√°ticamente.
            alert('Pok√©mon enviado a la caja.');
            cerrarInteraccion();
        }
    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

// 1. ABRIR EL MEN√ö DE OPCIONES
function abrirMenuSacar() {
    // Ponemos el nombre del Pok√©mon en el t√≠tulo
    const nombre = document.getElementById('int-nombre').textContent;
    document.getElementById('nombre-sacar-pokemon').textContent = nombre;
    
    // Mostramos el modal (usando flex para centrarlo)
    const modal = document.getElementById('modal-sacar-opciones');
    modal.style.display = 'flex'; 
}

// 2. EJECUTAR LA ACCI√ìN ELEGIDA
async function ejecutarSalida(accion) {
    if (!pokemonInteraccionId) return;
    
    const modal = document.getElementById('modal-sacar-opciones');
    const nombre = document.getElementById('nombre-sacar-pokemon').textContent;

    try {
        let url, method, mensajeExito;

        if (accion === 'caja') {
            // --- OPCI√ìN A: GUARDAR EN CAJA ---
            // Solo borramos la relaci√≥n con el h√°bitat
            url = `${API_URL}/jugador/habitats/${habitatActualId}/pokemons/${pokemonInteraccionId}`;
            method = 'DELETE'; // Esto llama a quitarPokemonHabitat en backend
            mensajeExito = `‚úÖ ${nombre} ha sido enviado a tu Caja Pok√©mon.`;

        } else if (accion === 'liberar') {
            // --- OPCI√ìN B: LIBERAR PARA SIEMPRE ---
            if (!confirm(`¬øEst√°s 100% seguro de liberar a ${nombre}?\n\nNO podr√°s recuperarlo.`)) return;
            
            // Borramos el Pok√©mon entero
            url = `${API_URL}/jugador/pokemons/${pokemonInteraccionId}`; 
            method = 'DELETE'; // Esto llama a eliminarPokemon en backend
            mensajeExito = `üëã Adi√≥s, ${nombre}. Fue liberado correctamente.`;
        }

        // Ejecutar llamada
        const res = await fetch(url, { method: method });
        const data = await res.json();

        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(mensajeExito);
            modal.style.display = 'none'; // Cerrar modal
            cerrarInteraccion();          // Volver al h√°bitat y recargar
        }

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

// 3. CAMBIAR APODO
async function guardarApodo() {
    const nuevoApodo = document.getElementById('int-apodo-input').value;
    if (!nuevoApodo || !pokemonInteraccionId) return;
    
    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/apodo`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apodo: nuevoApodo })
        });
        
        const data = await res.json();
        
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('‚úÖ Nombre cambiado a: ' + data.apodo);
            document.getElementById('int-nombre').textContent = data.apodo;
            document.getElementById('int-apodo-input').value = '';
        }
    } catch (error) {
        console.error(error);
    }
}

// Variable global para controlar el reloj y que no se vuelva loco
let intervaloGranja = null;

async function cargarGranja() {
    // 1. LIMPIEZA: Si ya hab√≠a un reloj corriendo, lo paramos para reiniciarlo
    if (intervaloGranja) clearInterval(intervaloGranja);

    const nivelesDesbloqueo = { 2: 3, 3: 6, 4: 12, 5: 18, 6: 25 };

    try {
        // --- Actualizar Contadores (Inventario) ---
        await actualizarContadoresBayas();

        // --- Cargar Datos de Granja ---
        const res = await fetch(`${API_URL}/jugador/granjas`);
        if (!res.ok) {
            document.getElementById('lista-granjas').innerHTML = '<p>Error de conexi√≥n.</p>';
            return;
        }

        const data = await res.json();
        const listaGranjas = data.granjas || [];
        const contenedor = document.getElementById('lista-granjas');
        contenedor.innerHTML = '';

        if (listaGranjas.length === 0) {
            contenedor.innerHTML = '<p style="width:100%;">No tienes parcelas.</p>';
            return;
        }

        // --- RENDERIZAR PARCELAS ---
        listaGranjas.forEach(g => {
            const numero = g.numero_granja;
            const imagenGranja = "https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen%20granja/granjasinfondo.png";
            
            let imagenHTML = '';
            let botonAccion = '';
            let estiloContenedor = 'background: white;'; 

            if (!g.desbloqueada) {
                // --- BLOQUEADO ---
                const nivelReq = nivelesDesbloqueo[numero] || 30;
                estiloContenedor = 'background: #e0e0e0; color: #777;'; 

                imagenHTML = `
                    <div style="position: relative; width: 100%; height: 120px; display:flex; align-items:center; justify-content:center;">
                        <img src="${imagenGranja}" style="height: 100%; width: auto; filter: grayscale(100%); opacity: 0.4;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                    background: #333; color: white; padding: 6px 10px; border-radius: 4px; 
                                    font-size: 0.8rem; z-index: 10; white-space: nowrap;">
                            üîí Nivel ${nivelReq}
                        </div>
                    </div>
                `;
                botonAccion = `<button class="nes-btn is-disabled" style="width: 100%; font-size: 0.7rem; margin-top: 10px;">BLOQUEADO</button>`;

            } else {
                // --- DESBLOQUEADO ---
                imagenHTML = `
                    <div style="width: 100%; height: 120px; display:flex; align-items:center; justify-content:center;">
                        <img src="${imagenGranja}" style="height: 100%; width: auto; filter: drop-shadow(0 4px 0 rgba(0,0,0,0.2));">
                    </div>
                `;

                if (g.puede_recolectar) {
                    // LISTO PARA RECOLECTAR
                    botonAccion = `
                        <button class="nes-btn is-warning" onclick="recolectar(${g.granja_id})" style="width: 100%; font-size: 0.7rem; margin-top: 10px; padding: 5px;">
                            RECOLECTAR (+10 üçí)
                        </button>`;
                } else {
                    // CRECIENDO (Aqu√≠ est√° la magia del timer)
                    let segundosRestantes = Math.floor(g.tiempo_restante);
                    
                    // Formato inicial MM:SS
                    const min = Math.floor(segundosRestantes / 60);
                    const seg = segundosRestantes % 60;
                    const textoInicial = `‚è≥ ${min}:${seg.toString().padStart(2, '0')}`;

                    // Agregamos la clase "granja-timer" y el atributo "data-segundos"
                    botonAccion = `
                        <button class="nes-btn is-primary granja-timer" 
                                data-segundos="${segundosRestantes}"
                                style="width: 100%; font-size: 0.7rem; margin-top: 10px; opacity: 0.8; cursor: default;">
                            ${textoInicial}
                        </button>`;
                }
            }

            contenedor.innerHTML += `
                <div class="nes-container is-rounded" style="${estiloContenedor} padding: 15px; text-align: center;">
                    <h3 style="font-size: 0.9rem; margin: 0 0 15px 0; border-bottom: 2px dashed #ccc; padding-bottom: 5px;">
                        Parcela ${numero}
                    </h3>
                    ${imagenHTML}
                    ${botonAccion}
                </div>
            `;
        });

        // --- INICIAR EL RELOJ EN VIVO ---
        intervaloGranja = setInterval(async () => {
            const timers = document.querySelectorAll('.granja-timer');
            
            // Si no hay timers activos, paramos el reloj para ahorrar recursos
            if (timers.length === 0) {
                clearInterval(intervaloGranja);
                return;
            }

            // Actualizar contador de bayas cada segundo
            await actualizarContadoresBayas();

            let algunCambio = false;

            timers.forEach(btn => {
                let segs = parseInt(btn.getAttribute('data-segundos'));
                
                if (segs > 0) {
                    segs--; // Restamos 1 segundo
                    btn.setAttribute('data-segundos', segs); // Guardamos el nuevo valor
                    
                    // Actualizamos texto visualmente
                    const m = Math.floor(segs / 60);
                    const s = segs % 60;
                    btn.innerHTML = `‚è≥ ${m}:${s.toString().padStart(2, '0')}`;
                } else {
                    // ¬°SE ACAB√ì EL TIEMPO!
                    // Recargamos toda la granja para que aparezca el bot√≥n de "RECOLECTAR"
                    // (Solo lo hacemos una vez para evitar bucles infinitos)
                    if (!btn.classList.contains('finalizado')) {
                        btn.classList.add('finalizado');
                        algunCambio = true;
                    }
                }
            });

            // Si alg√∫n contador lleg√≥ a 0, recargamos la vista completa
            if (algunCambio) {
                cargarGranja();
            }

        }, 1000);

    } catch (error) { console.error('Error cargando granja:', error); }
}
// ==================== FUNCIONES DE GRANJA ====================

async function recolectar(granjaId) {
    try {
        const btn = event.target; 
        const textoOriginal = btn.innerHTML;
        btn.innerHTML = '‚è≥...';
        btn.disabled = true;

        const res = await fetch(`${API_URL}/jugador/granjas/${granjaId}/recolectar`, { method: 'POST' });
        const data = await res.json();

        if (data.error) {
            alert(data.mensaje || data.error);
      } else {
    console.log("‚úÖ Recolectado con √©xito");
    await actualizarContadoresBayas(); // <-- AGREGA ESTA L√çNEA AQU√ç
    await cargarGranja(); 
    await actualizarHUDJugador();
}
    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

// --- FUNCI√ìN MAESTRA PARA ACTUALIZAR CONTADORES ---
async function actualizarContadoresBayas() {
    try {
        // El "?t=" + Date.now() es el "descongelante"
        const res = await fetch(`${API_URL}/jugador/inventario?t=${Date.now()}`);
        if (res.ok) {
            const inventario = await res.json();
            
            // Buscamos la Baya (ID 1)
            const bayas = inventario.find(i => i.fruta_id === 1 || i.id === 1);
            const cantidadReal = bayas ? bayas.cantidad : 0;

            console.log("üîÑ Cantidad real detectada:", cantidadReal);

            // ACTUALIZACI√ìN MANUAL FORZOSA
            const cGranja = document.getElementById('contador-bayas-granja');
            const cAlimentar = document.getElementById('int-bayas-qty');

            if (cGranja) cGranja.innerText = cantidadReal;
            if (cAlimentar) cAlimentar.innerText = cantidadReal;
            
            return cantidadReal;
        }
    } catch (error) {
        console.error("‚ùå Error de sincronizaci√≥n:", error);
    }
}
// 4. CERRAR
function cerrarInteraccion() {
    // Volvemos al habitat anterior (usando la variable global que creamos antes)
    if (habitatActualId) {
        cargarHabitat(habitatActualId); // Recargar para ver cambios (nivel, nombre)
        window.location.hash = '#habitat-detalle';
    } else {
        window.location.hash = '#habitats';
    }
}

// --- FUNCIONES DE EVOLUCI√ìN ---

async function verificarEvolucionUI(id) {
    const zonaEvo = document.getElementById('zona-evolucion');
    zonaEvo.style.display = 'none'; // Ocultar por defecto

    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${id}/puede-evolucionar`);
        const data = await res.json();

        // Si puede evolucionar, mostramos el bot√≥n m√°gico
        if (data.puede_evolucionar) {
            zonaEvo.style.display = 'block';
            console.log("‚ú® Evoluci√≥n disponible:", data.mensaje);
        }
    } catch (error) {
        console.error("Error verificando evoluci√≥n:", error);
    }
}

async function realizarEvolucion() {
    if (!pokemonInteraccionId) return;

    const btn = document.querySelector('#zona-evolucion button');
    const textoOriginal = btn.textContent;
    btn.textContent = "Evolucionando...";
    btn.disabled = true;

    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/evolucionar`, {
            method: 'POST'
        });
        const data = await res.json();

        if (data.error) {
            alert(data.mensaje || data.error);
            btn.textContent = textoOriginal;
            btn.disabled = false;
        } else {
            // ¬°√âXITO! Animaci√≥n y actualizaci√≥n
            alert(`‚ú® ¬°Enhorabuena! Tu ${data.pokemon_anterior} evolucion√≥ a ${data.pokemon_nuevo}! ‚ú®`);
            
            // 1. Actualizar Foto y Nombre
            document.getElementById('int-img').src = data.pokemon.imagen_url;
            document.getElementById('int-nombre').textContent = data.pokemon.apodo || data.pokemon.nombre;
            
            // 2. Ocultar bot√≥n de evoluci√≥n
            document.getElementById('zona-evolucion').style.display = 'none';

            // 3. Recargar datos del nivel (por si cambiaron stats o algo visual)
            const resPoke = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/nivel`);
            const dataPoke = await resPoke.json();
            actualizarBarraXP(dataPoke);
            actualizarHUDJugador();
        }
    } catch (error) {
        console.error(error);
        alert('Error al evolucionar');
        btn.textContent = textoOriginal;
        btn.disabled = false;
    }
}

// Variable global para saber d√≥nde estamos y qu√© atrapamos
let zonaActualId = null;
let pokemonCapturadoTempId = null; 

// Im√°genes de fondo para cada zona (Coinciden con tus IDs de BD)
const fondosZonas = {
    1: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturallanura.png',
    2: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturabosque.png',
    3: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturaplaya.png',
    4: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturacueva.png',
    5: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturadesierto.png',
    6: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturahielo.png'
};

// 1. ENTRAR A LA ZONA
function cargarEscenario(zonaId) {
    zonaActualId = zonaId;
    const fondo = fondosZonas[zonaId] || fondosZonas[1];
    
    // Configurar vista
    document.getElementById('img-escenario-fondo').src = fondo;
    document.getElementById('titulo-zona-captura').textContent = "Explorando...";
    
    // Resetear bot√≥n
    const btn = document.getElementById('btn-lanzar');
    btn.disabled = false;
    btn.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Pokebola-pokeball-png-0.png" style="width:24px;"> ¬°Lanzar Ball!';
    btn.className = "nes-btn is-error"; // Rojo
}

// 2. LANZAR POK√âBALL (Llamada al Backend)
async function lanzarPokeball() {
    const btn = document.getElementById('btn-lanzar');
    btn.disabled = true;
    btn.innerHTML = "Lanzando...";
    btn.className = "nes-btn is-disabled";

    try {
        // Llamamos a tu API: POST /api/zonas/:id/capturar
        const res = await fetch(`${API_URL}/zonas/${zonaActualId}/capturar`, {
            method: 'POST'
        });
        const data = await res.json();

        if (data.error) {
            alert(data.mensaje || data.error);
            // Si la caja est√° llena, el bot√≥n permite intentar de nuevo tras liberar espacio
            btn.innerHTML = "Caja Llena";
            return;
        }

        // ¬°CAPTURA EXITOSA!
        pokemonCapturadoTempId = data.jugador_pokemon_id; // Guardamos ID por si lo libera

        // Llenar datos en la pantalla de resultado
        document.getElementById('res-img-pokemon').src = data.imagen_url;
        document.getElementById('res-nombre-pokemon').textContent = data.nombre;
        
        // Mostrar tipos si est√°n disponibles
        const tiposTexto = data.tipos ? data.tipos.join(' / ') : 'Desconocido';
        document.getElementById('res-tipos-pokemon').textContent = tiposTexto;

        // Resetear radio buttons (siempre marcado "Guardar" por defecto)
        document.querySelectorAll('input[name="decision-captura"]')[0].checked = true;

        // Ir a la pantalla de resultado
        window.location.hash = '#captura-resultado';

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n con el servidor');
        btn.disabled = false;
        btn.innerHTML = "Reintentar";
        btn.className = "nes-btn is-error";
    }
}

// 3. CONFIRMAR (Guardar o Liberar)
async function finalizarCaptura() {
    // Ver qu√© eligi√≥ el usuario
    const accion = document.querySelector('input[name="decision-captura"]:checked').value;

    if (accion === 'liberar' && pokemonCapturadoTempId) {
        if (!confirm("¬øSeguro? Si lo liberas no podr√°s recuperarlo.")) return;

        try {
            // Llamamos a la API para borrarlo
            const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonCapturadoTempId}`, {
                method: 'DELETE'
            });
            const data = await res.json();
            
            if (data.error) {
                alert("Error al liberar: " + data.error);
            } else {
                alert(`Has liberado al Pok√©mon. ¬°Adi√≥s!`);
            }
        } catch (error) {
            console.error(error);
        }
    } else {
        alert("¬°Pok√©mon enviado a tu Caja!");
    }

    // Volver al men√∫ de zonas para seguir capturando
    window.location.hash = '#capturar';
}


// --- FUNCI√ìN GLOBAL: ACTUALIZAR HUD DEL JUGADOR (Nivel/XP) ---
// --- FUNCI√ìN GLOBAL: ACTUALIZAR HUD DEL JUGADOR ---
// --- FUNCI√ìN GLOBAL: ACTUALIZAR HUD DEL JUGADOR (Nivel/XP) ---
async function actualizarHUDJugador() {
    try {
        // 1. FORZAMOS VERIFICACI√ìN: Le decimos al backend "revisa si debo subir de nivel"
        // (Esto arregla el problema de tener 270 XP y seguir en Nivel 1)
        await fetch(`${API_URL}/jugador/verificar-nivel`, { method: 'POST' });

        // 2. OBTENEMOS DATOS PRE-CALCULADOS
        const res = await fetch(`${API_URL}/jugador/nivel`);
        
        if (res.ok) {
            const data = await res.json();
            
            // data.nivel (ej: 3)
            // data.xp_en_nivel_actual (ej: 70)
            // data.xp_para_subir (ej: 100)
            
            // 3. ACTUALIZAR EL HTML
            const elNivel = document.getElementById('hud-nivel-num');
            const elTexto = document.getElementById('hud-xp-texto');
            const elBarra = document.getElementById('hud-xp-bar');
            
            if (elNivel) elNivel.textContent = data.nivel;
            if (elTexto) elTexto.textContent = `${data.xp_en_nivel_actual} / ${data.xp_para_subir}`;
            
            if (elBarra) {
                elBarra.value = data.xp_en_nivel_actual;
                elBarra.max = data.xp_para_subir;
            }
            
            console.log(`‚≠ê HUD: Nivel ${data.nivel} | XP Barra: ${data.xp_en_nivel_actual}/${data.xp_para_subir}`);
        }
    } catch (error) {
        console.error("Error actualizando HUD:", error);
    }
}

// ==================== FUNCIONES DE LA CAJA ====================
let pokemonsEnCaja = []; 
let pokemonCajaSeleccionado = null;

async function cargarCaja() {
    console.log('üì¶ Cargando Caja...');
    const contenedor = document.getElementById('lista-caja');
    const titulo = document.getElementById('titulo-caja');
    
    contenedor.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">Cargando...</p>';

    try {
        // 1. Obtener TODOS mis Pok√©mon y los IDs de los que est√°n ocupados
        const [resPokemons, idsEnHabitats] = await Promise.all([
            fetch(`${API_URL}/jugador/pokemons`),
            obtenerIdsPokemonsEnHabitats()
        ]);
        
        const todosLosPokemons = await resPokemons.json();

        // 2. Obtener capacidad m√°xima de inventario
        const resNivel = await fetch(`${API_URL}/jugador/nivel`);
        const datosNivel = await resNivel.json();
        const capacidadMax = datosNivel.slots_inventario || 10;

        // 3. FILTRAR: Solo nos quedamos con los que NO est√°n en h√°bitats
        pokemonsEnCaja = todosLosPokemons.filter(p => {
            const id = p.jugador_pokemon_id || p.id;
            return !idsEnHabitats.includes(id); // Si NO est√° en la lista de ocupados, se queda en la caja
        });

        // 4. Actualizar t√≠tulo (Mostramos el total de Pok√©mon vs Capacidad M√°xima)
        titulo.textContent = `Mi Caja (${todosLosPokemons.length}/${capacidadMax})`;

        // 5. Renderizar
        if (pokemonsEnCaja.length === 0) {
            contenedor.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1; padding: 20px;">Tu caja est√° vac√≠a o todos tus Pok√©mon est√°n entrenando en h√°bitats.</p>';
            return;
        }

        contenedor.innerHTML = pokemonsEnCaja.map(p => `
            <div class="box-item nes-pointer" style="cursor: pointer;" onclick="verDetalleCaja(${p.jugador_pokemon_id || p.id})">
                <img src="${p.imagen_url}" width="60" style="image-rendering: pixelated; margin-bottom: 5px;"><br>
                <strong style="text-transform: capitalize;">${p.apodo || p.nombre}</strong><br>
                <span style="color: var(--azul-poke);">Nvl ${p.nivel}</span>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error cargando la caja:', error);
        contenedor.innerHTML = '<p style="color: red; text-align: center; grid-column: 1/-1;">Error de conexi√≥n.</p>';
    }
}

// Mostrar modal de detalle al hacer clic en un Pok√©mon de la caja
function verDetalleCaja(id) {
    const p = pokemonsEnCaja.find(poke => poke.jugador_pokemon_id === id);
    if (!p) return;

    pokemonCajaSeleccionado = p;
    document.getElementById('caja-poke-nombre').textContent = p.apodo || p.nombre;
    document.getElementById('caja-poke-img').src = p.imagen_url;
    document.getElementById('caja-poke-nivel').textContent = p.nivel;
    document.getElementById('caja-poke-tipos').textContent = p.tipos ? p.tipos.join(' / ') : 'Desconocido';
    
    document.getElementById('modal-opciones-caja').style.display = 'flex';
}

// Acci√≥n de liberar desde la caja
document.getElementById('btn-liberar-caja').onclick = async () => {
    if (!pokemonCajaSeleccionado) return;
    const nombre = pokemonCajaSeleccionado.apodo || pokemonCajaSeleccionado.nombre;

    if (!confirm(`¬øEst√°s 100% seguro de liberar a ${nombre}?\n\nNO podr√°s recuperarlo.`)) return;

    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonCajaSeleccionado.jugador_pokemon_id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.error) {
            alert(data.error);
        } else {
            alert(data.mensaje); // "Pikachu ha sido liberado"
            document.getElementById('modal-opciones-caja').style.display = 'none';
            cargarCaja(); // Recargar la vista de la caja autom√°ticamente
        }
    } catch (e) { 
        console.error(e); 
        alert('Error de conexi√≥n');
    }
}

// ==================== FUNCIONES DE EQUIPO ====================
let posicionEquipoSeleccionada = null;

async function cargarEquipo() {
    console.log('‚öîÔ∏è Cargando equipo...');
    const contenedor = document.getElementById('lista-equipo');
    contenedor.innerHTML = '<p>Cargando...</p>';

    try {
        const res = await fetch(`${API_URL}/jugador/equipo`);
        // Si no hay equipo, la API devuelve error o vac√≠o, lo manejamos.
        const equipo = res.ok ? await res.json() : [];
        const equipoData = Array.isArray(equipo) ? equipo : []; // Aseguramos que sea array
        
        let html = '';
        
        // Creamos SIEMPRE 5 slots
        for (let i = 1; i <= 5; i++) {
            // Buscamos si hay un Pok√©mon en esta posici√≥n espec√≠fica
            const pokemonEnSlot = equipoData.find(p => p.posicion === i);

            if (pokemonEnSlot) {
                // SLOT OCUPADO
                html += `
                <div class="team-slot">
                    <div class="team-info">
                        <span style="font-weight: bold; color: #aaa; font-size: 0.9rem; margin-right: 5px;">#${i}</span>
                        <img src="${pokemonEnSlot.imagen_url}" width="50" style="image-rendering: pixelated;">
                        <div>
                            <div class="team-name">${pokemonEnSlot.apodo || pokemonEnSlot.nombre}</div>
                            <div class="team-lvl">Nivel ${pokemonEnSlot.nivel}</div>
                        </div>
                    </div>
                    <button class="nes-btn is-error" style="font-size: 0.6rem; padding: 2px 8px;" onclick="quitarDelEquipo(${i})" title="Quitar del equipo">X</button>
                </div>
                `;
            } else {
                // SLOT VAC√çO
                html += `
                <div class="team-slot slot-empty" onclick="abrirModalEquipo(${i})">
                    <span style="font-weight: bold; margin-right: 10px;">#${i}</span> + A√ëADIR POK√âMON
                </div>
                `;
            }
        }
        
        contenedor.innerHTML = html;

    } catch (error) {
        console.error(error);
        contenedor.innerHTML = '<p>Error de conexi√≥n al cargar equipo.</p>';
    }
}

async function abrirModalEquipo(pos) {
    posicionEquipoSeleccionada = pos;
    document.getElementById('modal-seleccion-equipo').style.display = 'flex';
    
    const contenedor = document.getElementById('lista-candidatos-equipo');
    contenedor.innerHTML = 'Cargando...';
    
    try {
        // Pedimos TODOS los pokemons y LOS DEL EQUIPO al mismo tiempo
        const [resPokemons, resEquipo] = await Promise.all([
            fetch(`${API_URL}/jugador/pokemons`),
            fetch(`${API_URL}/jugador/equipo`)
        ]);
        
        const todos = await resPokemons.json();
        const equipoActual = resEquipo.ok ? await resEquipo.json() : [];
        const equipoData = Array.isArray(equipoActual) ? equipoActual : [];
        
        // Filtramos para NO mostrar los que ya est√°n en el equipo
        const idsEnEquipo = equipoData.map(p => p.jugador_pokemon_id);
        const disponibles = todos.filter(p => !idsEnEquipo.includes(p.jugador_pokemon_id));
        
        if (disponibles.length === 0) {
            contenedor.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No tienes m√°s Pok√©mon disponibles en la Caja.</p>';
            return;
        }
        
        contenedor.innerHTML = disponibles.map(p => `
            <div style="border: 2px solid #ccc; padding: 5px; display: flex; align-items: center; gap: 10px; cursor: pointer; background: white;" 
                 class="nes-pointer" onclick="asignarAlEquipo(${p.jugador_pokemon_id})">  
                <img src="${p.imagen_url}" width="40" style="image-rendering: pixelated;">
                <div style="text-align: left;">
                    <div style="font-size: 0.7rem; font-weight: bold; text-transform: capitalize;">${p.apodo || p.nombre}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Nvl ${p.nivel}</div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error(error);
    }
}

function cerrarModalEquipo() {
    document.getElementById('modal-seleccion-equipo').style.display = 'none';
    posicionEquipoSeleccionada = null;
}

async function asignarAlEquipo(idPokemon) {
    try {
        // Mandamos a guardar en la base de datos
        const res = await fetch(`${API_URL}/jugador/equipo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jugador_pokemon_id: idPokemon, posicion: posicionEquipoSeleccionada })
        });
        
        const data = await res.json();
        if (data.error) {
            alert(data.error);
        } else {
            cerrarModalEquipo();
            cargarEquipo(); // Recargamos para que se vea el nuevo pokemon
        }
    } catch (error) {
        console.error(error);
        alert("Error de conexi√≥n");
    }
}

async function quitarDelEquipo(posicion) {
    try {
        // Mandamos a borrar de la base de datos
        const res = await fetch(`${API_URL}/jugador/equipo/${posicion}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.error) {
            alert(data.error);
        } else {
            cargarEquipo(); // Recargamos para que el slot vuelva a quedar "Vac√≠o"
        }
    } catch (error) {
        console.error(error);
    }
}
// NUEVA FUNCI√ìN: Busca qu√© Pok√©mon ya est√°n asignados a h√°bitats
async function obtenerIdsPokemonsEnHabitats() {
    let idsOcupados = [];
    try {
        // Consultamos los 6 h√°bitats al mismo tiempo para ser r√°pidos
        const promesas = [1,2,3,4,5,6].map(id => 
            fetch(`${API_URL}/jugador/habitats/${id}/pokemons`).then(r => r.ok ? r.json() : [])
        );
        const resultados = await Promise.all(promesas);
        
        resultados.forEach(lista => {
            lista.forEach(p => {
                if (p) { // Si el slot no est√° vac√≠o
                    idsOcupados.push(p.jugador_pokemon_id || p.id);
                }
            });
        });
    } catch (e) {
        console.error("Error obteniendo ocupados:", e);
    }
    return idsOcupados;
}

// ==================== BORRAR PARTIDA (CRUD: DELETE JUGADORES) ====================
async function borrarPartida() {
    // 1. Doble confirmaci√≥n de seguridad para evitar borrados accidentales
    const seguro = confirm("‚ö†Ô∏è ¬øEst√°s 100% seguro de que quieres BORRAR TU PARTIDA?\n\nPerder√°s todos tus Pok√©mon, niveles y granjas para siempre.");
    
    if (!seguro) return;

    try {
        // 2. Ejecutar el DELETE en la API
        const res = await fetch(`${API_URL}/jugador`, { method: 'DELETE' });
        
        if (res.ok) {
            alert("Partida borrada. Comenzar√°s tu aventura desde cero.");
            // 3. Volver al inicio y recargar la p√°gina para que salte la pantalla de elegir Starter
            window.location.hash = "#home";
            location.reload(); 
        } else {
            const data = await res.json();
            alert("Error al intentar borrar la partida: " + (data.error || "Desconocido"));
        }
    } catch (error) {
        console.error("Error de conexi√≥n al borrar partida:", error);
        alert("Error de conexi√≥n con el servidor.");
    }
}
</script>

</body>
</html>