<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Pok√©mon Rancher</title>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <link href="https://unpkg.com/nes.css/css/nes.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --azul-poke: #020c69;
            --fondo: linear-gradient(180deg, #b2fefa 0%, #ffffff 100%);
        }
       body {
            font-family: 'Press Start 2P';
            background: var(--fondo);
            background-attachment: fixed; 
            background-repeat: no-repeat; 
            margin: 0; 
            min-height: 100vh;
            color: #333;
            font-size: 12px; 
        }

        #view-home { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
        }
        nav { display: none; }
        .page { display: none; }
        #view-home { display: block; }
        #granja:target ~ #view-home,
        #habitats:target ~ #view-home,
        #capturar:target ~ #view-home,
        #captura-escenario:target ~ #view-home,
        #captura-resultado:target ~ #view-home,
        #combates:target ~ #view-home,
        #equipo:target ~ #view-home,
        #caja:target ~ #view-home,
        #habitat-detalle:target ~ #view-home,
        #poke-interaccion:target ~ #view-home {
            display: none !important;
        }
        #granja:target ~ nav,
        #habitats:target ~ nav,
        #capturar:target ~ nav,
        #captura-escenario:target ~ nav,
        #captura-resultado:target ~ nav,
        #combates:target ~ nav,
        #equipo:target ~ nav,
        #caja:target ~ nav,
        #habitat-detalle:target ~ nav,
        #poke-interaccion:target ~ nav {
            display: flex;
        }
        #granja:target ~ .page { display: none !important; }
        #granja:target ~ #view-granja { display: block !important; }
        
        #habitats:target ~ .page { display: none !important; }
        #habitats:target ~ #view-habitats { display: block !important; }
        
        #capturar:target ~ .page { display: none !important; }
        #capturar:target ~ #view-capturar { display: block !important; }
                
        #equipo:target ~ .page { display: none !important; }
        #equipo:target ~ #view-equipo { display: block !important; }
        
        #caja:target ~ .page { display: none !important; }
        #caja:target ~ #view-caja { display: block !important; }
        #captura-escenario:target ~ .page { display: none !important; }
        #captura-escenario:target ~ #view-captura-escenario { display: block !important; }
        
        #captura-resultado:target ~ .page { display: none !important; }
        #captura-resultado:target ~ #view-captura-resultado { display: block !important; }
        
        #habitat-detalle:target ~ .page { display: none !important; }
        #habitat-detalle:target ~ #view-habitat-detalle { display: block !important; }
        
        #poke-interaccion:target ~ .page { display: none !important; }
        #poke-interaccion:target ~ #view-poke-interaccion { display: block !important; }
        nav {
            background: white;
            padding: 15px;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-btn {
            text-decoration: none;
            color: #555;
            font-size: 0.7rem; 
            padding: 8px 12px;
            text-transform: uppercase;
            transition: 0.2s;
            font-weight: bold;
        }
        .nav-btn:hover { color: var(--azul-poke); transform: translateY(-2px); }
        .page {
            padding: 40px 20px;
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
            padding-bottom: 100px;
        }
        h1, h2, h3 { margin-bottom: 20px; line-height: 1.5; }
        .logo-db-container { margin: 50px auto; text-align: center; max-width: 500px; }
        .logo-img { width: 100%; max-height: 200px; object-fit: contain; }
        .menu-inicio {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 30px; 
            max-width: 850px; 
            margin: 0 auto;
            padding: 20px;
        }      

        .nes-btn.inicio {
            padding: 30px 10px; 
            font-size: 1rem; 
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            gap: 15px; 
            transition: all 0.2s ease; 
            }

        .nes-btn.inicio:hover { 
            background: var(--azul-poke); 
            color: white; 
            transform: scale(1.05); 
        }
        .resources-hud {
            background: #fff;
            padding: 10px;
            border: 4px solid #333;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        .gen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px;
            margin-top: 20px;
        }
        .granja-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }.habitat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }.captura-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .gen-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            position: relative; 
            transition: transform 0.2s;
            border: 2px solid transparent;
        }
        .gen-card:hover { border-color: var(--azul-poke); }
        .farm-img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 10px; }
        .gen-card.locked { background: #e0e0e0; border-color: #999; pointer-events: none; }
        .gen-card.locked::after {
            content: "üîí Nivel " attr(data-req);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #333; color: white; padding: 5px; font-size: 0.6rem;
        }
        .gen-card.locked .farm-img { opacity: 0.3; filter: grayscale(100%); }
        .nes-btn.cooldown { background: #7f8c8d; box-shadow: 0 4px 0 #555; cursor: not-allowed; }
        .zone-img { width: 100%; height: 100px; object-fit: cover;  }
        .zone-body { padding: 10px; }
        .scene-bg { width: 100%; height: 100%; object-fit: cover; }
        .scene-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.2);
        }
        .radio-group { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .radio-group input { display: none; }
        .radio-label {
            padding: 10px; border: 4px solid #ccc; cursor: pointer; background: #fff;
        }
        .radio-group input:checked + .radio-label { border-color: var(--azul-poke); background: #e3f2fd; }
        .habitat-slots {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            max-width: 600px; margin: -40px auto 20px; position: relative; z-index: 10;
        }
        .poke-slot {
            background: white; border: 4px solid #333; padding: 5px; cursor: pointer;
            font-size: 0.7rem;
        }
        .poke-slot:hover { border-color: rgb(0, 38, 255); }
        .poke-slot.empty { border-style: dashed; border-color: #999; color: #999; display: flex; align-items: center; justify-content: center; height: 100px; }
        .box-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px; background: #333; padding: 10px; border: 4px solid #000;
        }
        .box-item { background: white; width:"80"; padding: 5px; font-size: 0.6rem; border: 2px solid #999; }
        .combat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }
        .combat-modal.active {
            display: block;
        }

        .team-list {
            display: flex; flex-direction: column; gap: 12px;
            max-width: 500px; margin: 0 auto;
        }
        .team-slot {
            background: white; border: 4px solid #333; padding: 10px;
            display: flex; align-items: center; justify-content: space-between;
            text-decoration: none; transition: transform 0.1s;
        }
        .team-info { display: flex; align-items: center; gap: 15px; }
        .team-name { font-size: 0.8rem; font-weight: bold; text-align: left; text-transform: capitalize;}
        .team-lvl { color: var(--azul-poke); font-size: 0.6rem; margin-top: 4px; text-align: left; }
        
        .slot-empty {
            height: 74px; border: 4px dashed #aaa; background: rgba(255, 255, 255, 0.5);
            color: #888; font-size: 0.6rem; justify-content: center; cursor: pointer;
        }
        .slot-empty:hover { border-color: var(--azul-poke); color: var(--azul-poke); background: #e3f2fd; }
    </style>
</head>
<body>
<section id="view-inicializar" style="display: none; background: var(--fondo); z-index: 2000; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; overflow-y: auto;">
    
    <div style="display: flex; align-items: center; justify-content: center; min-height: 100%; padding: 20px;">
        
        <div class="nes-container is-rounded is-white" style="background: white; max-width: 850px; width: 100%; text-align: center; padding: 40px 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            
            <h1 style="color: var(--azul-poke); margin-bottom: 20px; font-size: 1.5rem; line-height: 1.5;">¬°Bienvenido a<br>Pok√©mon Rancher!</h1>
            <p style="font-size: 0.9rem;">Parece que eres nuevo aqu√≠.</p>
            <p style="margin-bottom: 30px; color: #555; font-size: 0.8rem;">Para comenzar tu aventura, el Profesor te ofrece un compa√±ero:</p>
            
            <div id="lista-starters" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 30px;">
                Cargando...
            </div>
            
        </div>

    </div>
</section>

    <div id="home"></div>
    <div id="granja"></div>
    <div id="habitats"></div>
    <div id="habitat-detalle"></div>
    <div id="poke-interaccion"></div>
    <div id="capturar"></div>
    <div id="captura-escenario"></div>
    <div id="captura-resultado"></div>
    <div id="combates"></div>
    <div id="equipo"></div>
    <div id="caja"></div>
    <nav style="justify-content: space-between; padding: 10px 20px; align-items: center;">
        
        <div style="display: flex; align-items: center; gap: 15px; width: 300px;">
            
            <div style="background: #f1c40f; padding: 5px 10px; border-radius: 5px; border: 4px solid #000; color: #000; font-weight: bold; text-align: center; line-height: 1.2;">
                <div style="font-size: 0.5rem;">NIVEL</div>
                <div id="hud-nivel-num" style="font-size: 1.2rem;">1</div>
            </div>

            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                <div style="display: flex; justify-content: space-between; font-size: 0.6rem; margin-bottom: 5px; color: #666; font-weight: bold;">
                    <span>EXP</span>
                    <span id="hud-xp-texto">0 / 100</span>
                </div>
                <progress id="hud-xp-bar" class="nes-progress is-success" value="0" max="100" style="height: 20px;"></progress>
            </div>
        </div>

       <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <a href="#granja" class="nav-btn">Granja</a>
                <a href="#habitats" class="nav-btn">Habitats</a>
                <a href="#capturar" class="nav-btn">Capturar</a>
                <a href="#combates" class="nav-btn">Combates</a>
                <a href="#equipo" class="nav-btn">Equipo</a>
                <a href="#caja" class="nav-btn">Caja</a>
                
                <span style="color: #ccc;">|</span>
                
                <a href="#home" class="nav-btn">Salir</a>

                <button onclick="borrarPartida()" class="nav-btn" style="color: red; border: none; background: transparent; cursor: pointer; font-family: 'Press Start 2P';">Reiniciar</button>
            </div>
    </nav>
 <section id="view-home">
        <div class="logo-db-container" style="max-width: 900px; margin-top: -50px; margin-bottom: 0;">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen-titulo/PokeRancher.png" 
                 alt="Logo Pok√©mon Rancher" class="logo-img" style="max-height: 450px; image-rendering: pixelated; width: 100%; height: auto;">
        </div>
        
        <div class="menu-inicio" style="margin-top: -30px;">
            <a href="#granja" class="nes-btn inicio">
                <span style="font-size: 3rem;">üöú</span>
                GRANJA
            </a>
            <a href="#habitats" class="nes-btn inicio">
                <span style="font-size: 3rem;">üèïÔ∏è</span>
                H√ÅBITATS
            </a>
            <a href="#capturar" class="nes-btn inicio">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Pokebola-pokeball-png-0.png" style="width: 55px; height: 55px; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3));">
                CAPTURAR
            </a>
            <a href="#combates" class="nes-btn inicio">
                <span style="font-size: 3rem;">‚öîÔ∏è</span>
                COMBATES
            </a>
            <a href="#equipo" class="nes-btn inicio">
                <span style="font-size: 3rem;">üõ°Ô∏è</span>
                EQUIPO
            </a>
            <a href="#caja" class="nes-btn inicio">
                <span style="font-size: 3rem;">üì¶</span>
                CAJA
            </a>
        </div>
    </section>
   <section id="view-granja" class="page" style="display: none;">
    <div class="container" style="margin-top: 20px; position: relative;">
        
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 30px; position: relative; height: 60px;">
            
            <div style="text-align: center;">
                <h1 style="margin: 0; font-size: 1.5rem;">Mis Granjas</h1>
                <p style="margin: 5px 0 0 0; font-size: 0.7rem;">Gestiona tus cultivos</p>
            </div>

            <div class="nes-container is-rounded" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); padding: 5px 15px; background: white; display: flex; align-items: center; gap: 10px; z-index: 10;">
                <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen_bayas/Baya_Ziuela_EP.png" width="28">
                <span id="contador-bayas-granja" style="font-weight: bold; font-size: 1rem;">--</span>
            </div>
        </div>

        <div id="lista-granjas" class="granja-grid">
            <p style="text-align:center; width:100%;">Cargando...</p>
        </div>
    </div>
</section>
<section id="view-habitats" class="page">
    <h1>Gestionar H√°bitats</h1>
    <p>Visita a tus Pok√©mon y alim√©ntalos.</p>
    
    <button class="nes-btn is-success" onclick="crearNuevoHabitat()" style="margin-bottom: 20px;">
        + Nuevo H√°bitat
    </button>

    <div id="lista-habitats-dinamica" class="habitat-grid">
        <p>Cargando...</p>
    </div>
</section>
</section>
    <section id="view-habitat-detalle" class="page">
        <h2 id="titulo-habitat-detalle">Cargando...</h2>
<div class="nes-container is-rounded" style="height: 200px;">
    <img id="fondo-habitat-detalle" src="" class="scene-bg">
</div>
        <div class="habitat-slots" id="lista-slots-habitat">
    </div>
        <a href="#habitats" class="nav-btn" style="display:inline-block; margin-top:20px;">&larr; Volver</a>
    </section>
   <section id="view-poke-interaccion" class="page">
    <div class="nes-container is-rounded" style="background:white; max-width:500px; margin:auto; text-align: left;">
        
        <div style="display:flex; gap:20px; align-items:center; margin-bottom: 20px;">
            
            <div style="text-align: center;">
                <img id="int-img" src="" width="120" style="image-rendering: pixelated; min-height: 120px;">
            </div>
            
            <div style="flex: 1;">
                <h3 id="int-nombre" style="margin:0; font-size: 1.1rem; text-transform: capitalize;">Cargando...</h3>
                
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    <input type="text" id="int-apodo-input" class="nes-input is-success" style="padding: 0 8px; height: 28px; font-size: 0.7rem;" placeholder="Nuevo apodo">
                    <button class="nes-btn is-primary" style="padding: 0 8px; height: 28px; font-size: 0.7rem;" onclick="guardarApodo()">OK</button>
                </div>

                <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: baseline;">
                    <span id="int-nivel" style="color:var(--azul-poke); font-weight: bold; font-size: 0.9rem;">Nivel --</span>
                    <span id="int-xp-text" style="font-size: 0.6rem; color: #666;">XP: --/--</span>
                </div>
                <progress id="int-progress" class="nes-progress is-primary" value="0" max="100" style="height: 15px; margin-top: 4px; width: 100%;"></progress>
            </div>
        </div>

        <div id="zona-evolucion" style="display: none; margin-bottom: 20px; text-align: center; animation: pulse 2s infinite;">
            <p style="color: #27ae60; font-size: 0.7rem; margin-bottom: 10px;">‚ú® ¬°Este Pok√©mon est√° reaccionando! ‚ú®</p>
            <button class="nes-btn is-success" onclick="realizarEvolucion()" style="width: 100%;">
            ¬°EVOLUCIONAR!
            </button>
        </div>

<div style="border-top: 4px dashed #ddd; margin: 20px 0; opacity: 0.6;"></div>

        <div style="border-top: 4px dashed #ddd; margin: 20px 0; opacity: 0.6;"></div>

        <h3 style="text-align: center; color: #e67e22; margin-bottom: 15px; font-size: 1rem;">üçé Zona de Cuidados</h3>
        
        <div style="background: #fffdf6; padding: 15px; border-radius: 12px; border: 3px solid #f0d39e;">
    <p style="text-align: center; font-size: 0.8rem; margin-bottom: 15px;">
        Tu Inventario: <strong id="int-bayas-qty" style="font-size: 1.1rem; color: #d35400;">--</strong> Bayas
    </p>
    
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 5px;">
        <div style="display: flex; align-items: center; gap: 5px;">
            <img src="https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen_bayas/Baya_Ziuela_EP.png" width="30">
            <div style="font-size: 0.6rem; line-height: 1.2;">
                <strong style="color: #e67e22;">Baya</strong><br>
                <span>+20 XP</span>
            </div>
        </div>

        <div style="display: flex; gap: 5px;">
            <button class="nes-btn is-error" onclick="abrirMenuSacar()" style="font-size: 0.6rem; padding: 0 8px;" title="Opciones de salida">
            SACAR
            </button>
            
            <button class="nes-btn is-warning" style="font-size: 0.6rem; padding: 0 10px;" onclick="accionAlimentar()">
                COMER
            </button>
        </div>
    </div>
</div>

        <br>
        <button class="nes-btn" style="width: 100%; margin-top: 10px;" onclick="cerrarInteraccion()">Volver</button>
    </div>
</section>
   <section id="view-capturar" class="page">
    <h1>Explorar Zona</h1>
    <p>Elige una zona para buscar Pok√©mon salvajes.</p>
    
    <button class="nes-btn is-primary" onclick="crearNuevaZona()" style="margin-bottom: 20px;">
        + Nueva Zona
    </button>
    
    <div id="lista-zonas-dinamica" class="captura-grid">
        <p>Cargando...</p>
    </div>
</section>
    <section id="view-captura-escenario" class="page">
    <h2 id="titulo-zona-captura">Zona Salvaje</h2>
    
    <div class="nes-container is-rounded" style="padding: 0; overflow: hidden; position: relative; height: 300px; border: 4px solid #333;">
        <img id="img-escenario-fondo" src="" style="width: 100%; height: 100%; object-fit: cover;">
        
        <div style="position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
            
            <button id="btn-lanzar" class="nes-btn is-error" onclick="lanzarPokeball()" style="padding: 15px 30px; font-size: 1rem; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 0 #8e0000;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Pokebola-pokeball-png-0.png" style="width:24px; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5));">
                ¬°Lanzar Pokeball!
            </button>

        </div>
    </div>
    <br>
    <a href="#capturar" class="nes-btn">Huir</a>
</section>

<section id="view-captura-resultado" class="page">
    <div class="nes-container is-rounded" style="background:white; padding:20px; max-width:400px; margin:auto; border: 4px solid #212529;">
        <h3 style="color: #27ae60; text-transform: uppercase;">¬°Te atrap√©!</h3>
        
        <div style="margin: 20px 0; background: #f0f0f0; border-radius: 50%; width: 150px; height: 150px; display: inline-flex; align-items: center; justify-content: center; border: 4px solid #ccc;">
            <img id="res-img-pokemon" src="" width="120" style="image-rendering: pixelated;">
        </div>
        
        <h2 id="res-nombre-pokemon" style="margin-bottom: 5px;">POKEMON</h2>
        <div id="res-tipos-pokemon" style="font-size: 0.7rem; color: #666; margin-bottom: 15px;">Tipo</div>
        
        <p style="font-size: 0.8rem; border-top: 2px dashed #ddd; padding-top: 15px;">
            ¬øQu√© quieres hacer?
        </p>
        
        <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">
           <label>
                <input type="radio" name="decision-captura" value="guardar" checked class="nes-radio">
                <span>Guardar en Caja</span>
            </label>
            <label>
                <input type="radio" name="decision-captura" value="liberar" class="nes-radio is-error">
                <span style="color: #e74c3c;">Liberar</span>
            </label>
        </div>
        
        <br>
        <button class="nes-btn is-primary" onclick="finalizarCaptura()" style="width: 100%;">CONFIRMAR</button>
    </div>
</section>
  <section id="view-caja" class="page">
        <h1 id="titulo-caja">Mi Caja (--/--)</h1>
        <p style="font-size: 0.7rem; margin-bottom: 25px;">Aqu√≠ est√°n todos los Pok√©mon que has capturado.</p>
        
        <div id="lista-caja" class="box-grid" style="border-radius: 8px;">
            </div>
        <br>
        <a href="#home" class="nav-btn" style="display:inline-block; margin-top:20px;">&larr; Volver al Inicio</a>
    </section>

    <section id="modal-opciones-caja" class="combat-modal" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8);">
        <div class="nes-container is-rounded is-white" style="background: white; max-width: 350px; width: 90%; text-align: center;">
            <h3 id="caja-poke-nombre" style="text-transform: capitalize;">Pok√©mon</h3>
            
            <div style="background: #f0f0f0; border-radius: 50%; width: 120px; height: 120px; display: inline-flex; align-items: center; justify-content: center; border: 4px solid #ccc; margin: 15px 0;">
                <img id="caja-poke-img" src="" width="90" style="image-rendering: pixelated;">
            </div>
            
            <p style="color: var(--azul-poke); font-weight: bold;">Nivel <span id="caja-poke-nivel"></span></p>
            <p style="font-size: 0.7rem; color: #666; margin-bottom: 20px;" id="caja-poke-tipos"></p>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="nes-btn is-error" id="btn-liberar-caja">üëã Liberar (Adi√≥s)</button>
                <button class="nes-btn" onclick="document.getElementById('modal-opciones-caja').style.display='none'">Cerrar</button>
            </div>
        </div>
    </section>
<section id="view-combates" class="page" style="display: none;">
    <h1>‚öîÔ∏è Combates</h1>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <button class="nes-btn is-primary" onclick="abrirGestionRivales()">
            üõ†Ô∏è Crear/Editar Rivales
        </button>
    </div>
    <div id="lista-niveles" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; margin: 0 auto;">
    </div>
</section>
<section id="view-nivel-detalle" class="combat-modal">
    <div style="max-width: 600px; margin: 0 auto;">
        <h2 id="nivel-titulo" style="text-align: left; margin-bottom: 10px; font-size: 0.9rem;">Nivel 1</h2>
        <h3 id="nivel-nombre" style="text-align: left; margin-bottom: 30px; font-size: 0.9rem;">Nombre rival</h3>
        
        <div style="display: flex; gap: 40px; align-items: flex-start; margin-bottom: 40px;">
            <img id="nivel-imagen" src="" style="width: 200px; height: 300px; object-fit: contain;">
            
            <div style="flex: 1;">
                <h3 style="margin-bottom: 15px; font-size: 0.8rem;">Equipo</h3>
                <div id="equipo-rival" style="display: flex; flex-direction: column; gap: 10px;">
                </div>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="nes-btn is-warning" onclick="verPrediccion()" style="padding: 15px 40px; font-size: 0.8rem;">
                Ver Predicci√≥n
            </button>
            <br><br>
            <a href="#combates" class="nav-btn" onclick="volverALista()">‚Üê Volver</a>
        </div>
    </div>
</section>
<section id="view-prediccion" class="combat-modal">
    <div style="max-width: 1200px; margin: 0 auto;">
        <h1 style="text-align: center; margin-bottom: 30px; font-size: 1.2rem;">üìä Predicci√≥n de Batalla</h1>
        
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: center; min-height: 400px;">
            <div id="equipo-jugador-prediccion">
            </div>
            
            <div style="text-align: center;">
                <div style="width: 220px; height: 220px; border: 5px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); box-shadow: 0 8px 16px rgba(0,0,0,0.2);">
                    <div style="text-align: center;">
                        <div style="font-size: 0.65rem; margin-bottom: 8px; color: #555; letter-spacing: 1px;">RESULTADO</div>
                        <div style="font-size: 0.65rem; margin-bottom: 15px; color: #555; letter-spacing: 1px;">PREDICHO</div>
                        <div id="porcentaje-victoria" style="font-size: 2.5rem; font-weight: bold; color: var(--azul-poke); text-shadow: 2px 2px 4px rgba(0,0,0,0.1); line-height: 1;">--</div>
                        <div id="mensaje-porcentaje" style="font-size: 0.55rem; margin-top: 10px; color: #888; font-weight: normal;">Calculando...</div>
                    </div>
                </div>
            </div>
            
            <div id="equipo-rival-prediccion" style="text-align: right;">
            </div>
        </div>
        
        <div id="detalles-combates" style="margin-top: 30px; padding: 20px; background: white; border: 4px solid #333; border-radius: 10px;">
            <h3 style="font-size: 0.8rem; margin-bottom: 15px; text-align: center;">‚öîÔ∏è Combates 1 vs 1</h3>
            <p style="font-size: 0.55rem; text-align: center; color: #666; margin-bottom: 15px;">Necesitas ganar 3 o m√°s combates para ganar la batalla</p>
            <div id="lista-predicciones" style="display: flex; flex-direction: column; gap: 10px;">
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
            <button class="nes-btn is-error" onclick="volverADetalleNivel()" style="padding: 15px 30px; font-size: 0.8rem;">
                ‚Üê Cancelar
            </button>
            <button class="nes-btn is-success" onclick="ejecutarCombate()" style="padding: 15px 50px; font-size: 0.8rem;">
                ‚öîÔ∏è COMBATIR
            </button>
        </div>
    </div>
</section>
<section id="view-resultado" class="combat-modal">
    <div style="max-width: 700px; margin: 0 auto; text-align: center;">
        <h1 id="resultado-titulo" style="font-size: 2.5rem; margin-bottom: 20px;">Gan√≥ o Perdi√≥</h1>
        <p id="resultado-mensaje" style="font-size: 0.8rem; color: #666; margin-bottom: 40px;">Mensaje del resultado</p>
        
        <div style="background: white; border: 4px solid #333; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
            <h2 style="font-size: 1rem; margin-bottom: 20px;">üéÅ Recompensas</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 2px solid var(--azul-poke);">
                    <div style="font-size: 0.6rem; color: #666; margin-bottom: 5px;">JUGADOR</div>
                    <div id="xp-jugador-ganada" style="font-size: 1.5rem; font-weight: bold; color: var(--azul-poke);">+100 XP</div>
                    <div id="jugador-subio-nivel" style="font-size: 0.6rem; color: #27ae60; margin-top: 5px; display: none;">
                        üéâ ¬°Subiste de nivel!
                    </div>
                </div>
                
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border: 2px solid #ff9800;">
                    <div style="font-size: 0.6rem; color: #666; margin-bottom: 5px;">CADA POK√âMON</div>
                    <div id="xp-pokemon-ganada" style="font-size: 1.5rem; font-weight: bold; color: #ff9800;">+30 XP</div>
                    <div style="font-size: 0.55rem; color: #666; margin-top: 5px;" id="total-pokemons-text">5 Pok√©mon</div>
                </div>
            </div>
        </div>
        
        <div id="resultado-content" style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 20px; font-size: 0.9rem;">‚¨ÜÔ∏è Pok√©mon que subieron de nivel</h3>
            <div id="pokemons-subieron" style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
            </div>
        </div>
        
        <button class="nes-btn is-primary" onclick="volverALista()" style="padding: 15px 60px; font-size: 0.9rem;">
            Continuar
        </button>
    </div>
</section>
   <section id="view-equipo" class="page">
        <h1>Mi Equipo</h1>
        <p style="margin-bottom: 25px; font-size: 0.7rem;">Selecciona tus 5 Pok√©mon para el combate. <br>¬°El orden importa!</p>

        <div id="lista-equipo" class="team-list">
            </div>

        <a href="#caja" class="nav-btn" style="display:inline-block; margin-top:20px;">&larr; VER CAJA</a>
    </section>

    <section id="modal-seleccion-equipo" class="combat-modal" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8);">
        <div class="nes-container is-rounded is-white" style="max-width: 600px; width: 90%; background: white;">
            <h2 style="text-align: center;">Elegir Pok√©mon</h2>
            <p style="text-align: center; font-size: 0.6rem; color: #666;">Selecciona un Pok√©mon de tu caja.</p>
            
            <div id="lista-candidatos-equipo" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px;">
                Cargando...
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="nes-btn is-error" onclick="cerrarModalEquipo()">Cancelar</button>
            </div>
        </div>
    </section>>
    <section id="modal-seleccion-habitat" class="combat-modal">
    <div class="nes-container is-rounded is-white" style="max-width: 600px; margin: 20px auto; background: white;">
        <h2 style="text-align: center;">Elige un Pok√©mon</h2>
        <p style="text-align: center; font-size: 0.7rem;">Solo ver√°s los que no est√°n ocupados.</p>
        
        <div id="lista-candidatos-habitat" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px;">
            Cargando...
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="nes-btn is-error" onclick="cerrarModalSeleccion()">Cancelar</button>
        </div>
    </div>
</section>
<section id="modal-sacar-opciones" class="combat-modal" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8);">
    <div class="nes-container is-rounded is-white" style="background: white; max-width: 400px; width: 90%; text-align: center;">
        
        <h3 style="color: #e74c3c;">Sacar Pok√©mon</h3>
        <p>¬øQu√© quieres hacer con <strong id="nombre-sacar-pokemon">este Pok√©mon</strong>?</p>
        
        <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
            
            <button class="nes-btn is-primary" onclick="ejecutarSalida('caja')">
                üì¶ Guardar en la Caja
            </button>
            <span style="font-size: 0.6rem; color: #666;">Se quita del h√°bitat pero te lo quedas.</span>

            <button class="nes-btn is-error" onclick="ejecutarSalida('liberar')">
                üëã Liberar (Adi√≥s)
            </button>
            <span style="font-size: 0.6rem; color: red;">Lo pierdes para siempre.</span>
        
        </div>

        <button class="nes-btn" onclick="document.getElementById('modal-sacar-opciones').style.display='none'">
            Cancelar
        </button>
    </div>
</section>

<section id="modal-tutorial" class="combat-modal" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); z-index: 99999;">
    <div class="nes-container is-rounded is-white" style="background: white; max-width: 600px; width: 95%; text-align: center; border: 4px solid #f1c40f;">
        <div style="font-size: 2.5rem; margin-bottom: 5px; animation: bounce 2s infinite;">üí°</div>
        <h3 id="tut-titulo" style="color: var(--azul-poke); margin-bottom: 15px; font-size: 1.2rem;">T√≠tulo</h3>
        
        <div id="tut-texto" style="text-align: left; font-size: 0.75rem; line-height: 1.8; color: #333; margin-bottom: 25px; padding: 0 10px; max-height: 50vh; overflow-y: auto; overflow-x: hidden;">
            </div>

        <button class="nes-btn is-warning" style="width: 100%; font-size: 0.9rem; padding: 10px;" onclick="document.getElementById('modal-tutorial').style.display='none'">¬°Entendido!</button>
    </div>
</section>

<button onclick="revisarTutorial(window.location.hash, true)" 
        class="nes-btn is-warning" 
        style="position: fixed; bottom: 30px; right: 30px; z-index: 1000; padding: 10px 15px; font-size: 1.5rem; line-height: 1; box-shadow: 0 4px 8px rgba(0,0,0,0.3);"
        title="Ver informaci√≥n de esta zona">
    ‚ùì
</button>


<section id="modal-gestion-rivales" class="combat-modal" style="z-index: 9990;">
    <div class="nes-container is-rounded is-white" style="max-width: 800px; margin: 20px auto; background: white; height: 90vh; display: flex; flex-direction: column;">
        
        <div style="flex: 0 0 auto; margin-bottom: 20px; text-align: center;">
            <h2 style="margin-bottom: 10px;">Mis Rivales</h2>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="nes-btn is-success" onclick="abrirModalEditorCompleto()">+ Crear Nuevo</button>
                <button class="nes-btn" onclick="document.getElementById('modal-gestion-rivales').style.display='none'; cargarCombates();">Cerrar</button>
            </div>
        </div>

        <div id="lista-gestion-entrenadores" style="flex: 1; overflow-y: auto; padding-right: 10px; display: grid; gap: 15px;">
            </div>
    </div>
</section>

<section id="modal-editor-completo" class="combat-modal" style="display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.9); z-index: 9995;">
    <div class="nes-container is-rounded is-white" style="background:white; max-width:600px; width:95%; height: 90vh; display: flex; flex-direction: column;">
        <h3 id="titulo-editor-completo" style="text-align:center;">Crear Rival</h3>
        
        <div style="flex: 1; overflow-y: auto; padding: 10px;">
            
            <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
                <label>Nombre del Rival:</label>
                <input type="text" id="edit-nombre" class="nes-input" placeholder="Ej: Team Rocket Grunt">
                
                <label style="margin-top: 10px;">URL Imagen:</label>
                <input type="text" id="edit-img" class="nes-input" placeholder="https://...">
            </div>

            <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Equipo Pok√©mon (Orden 1-5)</h4>
            <p style="font-size: 0.6rem; color: #666; margin-bottom: 15px;">Ingresa el ID de la Pok√©dex (ej: 25 para Pikachu) y el Nivel (Max 30).</p>

            <div id="lista-slots-inputs" style="display: flex; flex-direction: column; gap: 10px;">
                </div>

        </div>

        <div style="margin-top: 15px; text-align: center; flex: 0 0 auto;">
            <button class="nes-btn is-error" onclick="document.getElementById('modal-editor-completo').style.display='none'">Cancelar</button>
            <button class="nes-btn is-primary" onclick="guardarEntrenadorCompleto()">üíæ GUARDAR TODO</button>
        </div>
    </div>
</section>
<script>

//const API_URL = 'https://pokemon-rancher-2c7u.onrender.com/api';
const API_URL = 'http://localhost:3000/api'
let entrenadores = [];
let entrenadorSeleccionado = null;
let resultadoCombate = null;
let efectividades = [];
let equipoJugador = [];


console.log('‚úÖ Script de combates cargado');



const textosTutoriales = {
    '#granja': {
        titulo: 'üöú Gu√≠a de la Granja',
        texto: `
            <p style="text-align: center;">Las granjas son tu motor principal de recursos. Aqu√≠ cultivas tus <b>Bayas</b>.</p>
            <ul style="list-style: none; padding: 0; margin-top: 15px;">
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>Jugador:</b> Cada vez que recolectas, ganas <b>+20 XP</b> para tu nivel personal.</div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>Pok√©mon:</b> Cada baya que le des a un Pok√©mon le otorgar√° <b>+20 XP</b>.</div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div style="width: 100%;"><b>Desbloqueos de Parcelas:</b>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; color: #444; font-size: 0.65rem; background: #f0f0f0; padding: 10px; border-radius: 5px; border: 2px solid #ccc;">
                            <div>üå± Parcela 2: Nivel 3</div>
                            <div>üå± Parcela 3: Nivel 6</div>
                            <div>üå± Parcela 4: Nivel 12</div>
                            <div>üå± Parcela 5: Nivel 18</div>
                            <div style="grid-column: 1 / -1; text-align: center; font-weight: bold; border-top: 1px dashed #ccc; padding-top: 5px; margin-top: 2px;">
                                üå± Parcela 6: Nivel 25
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        `
    },
    '#habitats': {
        titulo: 'üèïÔ∏è Mis H√°bitats',
        texto: `
            <p style="text-align: center;">Aqu√≠ descansan y entrenan tus Pok√©mon capturados.</p>
            <ul style="list-style: none; padding: 0; margin-top: 15px;">
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div style="width: 100%;"><b>Compatibilidad:</b> El <b>Tipo</b> de tu Pok√©mon debe coincidir con el h√°bitat. Aceptan estos tipos:
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px; color: #444; font-size: 0.55rem; background: #f0f0f0; padding: 10px; border-radius: 5px; border: 2px solid #ccc;">
                            <div>üåæ <b>Pradera:</b> Normal, El√©ctrico, Ps√≠quico.</div>
                            <div>üå≤ <b>Bosque:</b> Planta, Bicho, Veneno, Hada.</div>
                            <div>üíß <b>Playa:</b> Agua, Volador.</div>
                            <div>‚öôÔ∏è <b>Cueva:</b> Roca, Lucha, Acero, Siniestro.</div>
                            <div>üèúÔ∏è <b>Desierto:</b> Tierra, Fuego, Fantasma.</div>
                            <div>‚ùÑÔ∏è <b>Hielo:</b> Hielo, Drag√≥n.</div>
                        </div>
                    </div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>Capacidad:</b> Tienes un m√°ximo de <b>6 Pok√©mon</b> por h√°bitat.</div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>Cuidados:</b> Toca un Pok√©mon para darle bayas, cambiarle el nombre o <b>Evolucionarlo</b>.</div>
                </li>
            </ul>
        `
    },
    '#capturar': {
        titulo: 'üéØ Zona de Captura',
        texto: `
            <p style="text-align: center;">Explora diferentes entornos para encontrar nuevos compa√±eros.</p>
            <ul style="list-style: none; padding: 0; margin-top: 15px;">
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div style="width: 100%;"><b>Zonas:</b> Los Pok√©mon aparecen seg√∫n su tipo:
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px; color: #444; font-size: 0.55rem; background: #f0f0f0; padding: 10px; border-radius: 5px; border: 2px solid #ccc;">
                            <div>üåæ <b>Pradera:</b> Normal, El√©ctrico, Ps√≠quico.</div>
                            <div>üå≤ <b>Bosque:</b> Planta, Bicho, Veneno, Hada.</div>
                            <div>üèñÔ∏è <b>Playa:</b> Agua, Volador.</div>
                            <div>ü¶á <b>Cueva:</b> Roca, Lucha, Acero, Siniestro.</div>
                            <div>üèúÔ∏è <b>Desierto:</b> Tierra, Fuego, Fantasma.</div>
                            <div>‚ùÑÔ∏è <b>Nieve:</b> Hielo, Drag√≥n.</div>
                        </div>
                    </div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>Lanzamiento:</b> Todos los Pok√©mon atrapados empezar√°n siempre en <b>Nivel 1</b>.</div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>Inventario:</b> Si tu Caja est√° llena, no podr√°s lanzar Pok√©balls. ¬°Libera espacio primero!</div>
                </li>
            </ul>
        `
    },
    '#combates': {
        titulo: '‚öîÔ∏è Liga Pok√©mon',
        texto: `
            <p style="text-align: center;">¬°Demuestra que eres el mejor entrenador!</p>
            <ul style="list-style: none; padding: 0; margin-top: 15px;">
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>El Poder:</b> Se calcula multiplicando: <br><b>Nivel √ó Ventaja de Tipo</b>.</div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>Regla de 3:</b> Son duelos de 5 vs 5. Gana <b>3 duelos individuales</b> para llevarte la victoria total.</div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>Progresi√≥n:</b> Sube tu nivel de jugador para desbloquear rivales m√°s dif√≠ciles.</div>
                </li>
            </ul>
        `
    },
    '#equipo': {
        titulo: 'üõ°Ô∏è Tu Equipo de Combate',
        texto: `
            <p style="text-align: center;">Prepara tu formaci√≥n t√°ctica antes de ir a pelear.</p>
            <ul style="list-style: none; padding: 0; margin-top: 15px;">
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div><b>El Orden es vital:</b> Tu Pok√©mon <b>#1</b> pelear√° contra el #1 del rival, el #2 contra el #2, etc.</div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div>¬°Organiza tus tipos estrat√©gicamente seg√∫n el equipo del rival al que te vayas a enfrentar!</div>
                </li>
            </ul>
        `
    },
    '#caja': {
        titulo: 'üì¶ La Caja PC',
        texto: `
            <p style="text-align: center;">El almacenamiento central de tu aventura.</p>
            <ul style="list-style: none; padding: 0; margin-top: 15px;">
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div>Aqu√≠ descansan los Pok√©mon que no caben en tu equipo ni est√°n entrenando en los h√°bitats.</div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div>La capacidad m√°xima aumenta a medida que subes tu nivel de Jugador.</div>
                </li>
                <li style="display: flex; align-items: flex-start; margin-bottom: 12px; line-height: 1.5; text-align: left;">
                    <span style="margin-right: 10px; margin-top: 2px;">‚ñ™</span>
                    <div>Toca un Pok√©mon para ver sus datos en detalle o <b>Liberarlo</b> para hacer espacio.</div>
                </li>
            </ul>
        `
    }
};
function revisarTutorial(hashPantalla, forzar = false) {
    const tutorial = textosTutoriales[hashPantalla];
    
    if (tutorial) {
        const yaLoVio = localStorage.getItem('visto_' + hashPantalla);
        
        if (!yaLoVio || forzar) {
            document.getElementById('tut-titulo').textContent = tutorial.titulo;
            document.getElementById('tut-texto').innerHTML = tutorial.texto; 
            document.getElementById('modal-tutorial').style.display = 'flex';
            
            if (!forzar) {
                localStorage.setItem('visto_' + hashPantalla, 'true');
            }
        }
    } else if (forzar) {
        alert("¬°Explora las diferentes zonas desde el men√∫!");
    }
}

window.addEventListener('hashchange', () => {
    const hash = window.location.hash;
    const viewCombates = document.getElementById('view-combates');
    
    revisarTutorial(hash);
    actualizarHUDJugador();         
    actualizarContadoresBayas();

    if (hash !== '#combates') {
        if(viewCombates) viewCombates.style.display = 'none';
    }

    if (hash === '#combates') {
        if(viewCombates) viewCombates.style.display = 'block';
        cargarCombates();
    } 
    else if (hash === '#habitats') {
        cargarListaHabitats(); 
    } 
    else if (hash === '#capturar') {
        cargarListaZonas();    
    }
    else if (hash === '#granja') {  
        cargarGranja();
    }
    else if (hash === '#caja') {
        cargarCaja();
    }
    else if (hash === '#equipo') {
        cargarEquipo();
    }
});

window.addEventListener('DOMContentLoaded', async () => {
    await verificarEstadoJuego();

    actualizarHUDJugador();       
    actualizarContadoresBayas();

    try {
        const res = await fetch(`${API_URL}/tipo-efectividad`);
        if (res.ok) efectividades = await res.json();
    } catch (error) { console.error(error); }

    const hash = window.location.hash;
    const viewCombates = document.getElementById('view-combates');
    
    if (hash === '#combates') {
        if(viewCombates) viewCombates.style.display = 'block';
        cargarCombates();
    } 
    else if (hash === '#granja') { 
        cargarGranja();
    } 
    else if (hash === '#habitats') {
        cargarListaHabitats(); 
    } 
    else if (hash === '#capturar') {
        cargarListaZonas();    
    } 
    else if (hash === '#caja') {
        cargarCaja();
    } 
    else if (hash === '#equipo') {
        cargarEquipo();
    }
});
async function cargarCombates() {
    console.log('üîÑ Cargando combates...');
    
    try {
        const res = await fetch(`${API_URL}/entrenadores`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        const entrenadores = await res.json();
        
        
        const historia = entrenadores.filter(e => e.descripcion !== 'Entrenador Personalizado');
        const personalizados = entrenadores.filter(e => e.descripcion === 'Entrenador Personalizado');

        let html = '';

        
        html += `<h3 style="grid-column: 1/-1; margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 5px;">üìú Modo Historia</h3>`;
        
        if (historia.length > 0) {
            html += historia.map(e => generarBotonNivel(e)).join('');
        } else {
            html += `<p style="grid-column: 1/-1;">No hay niveles de historia cargados.</p>`;
        }

        
        html += `<h3 style="grid-column: 1/-1; margin-top: 30px; border-bottom: 2px solid #333; padding-bottom: 5px; color: var(--azul-poke);">üõ†Ô∏è Rivales Personalizados</h3>`;
        
        if (personalizados.length > 0) {
            html += personalizados.map(e => generarBotonNivel(e, true)).join('');
        } else {
            html += `<div style="grid-column: 1/-1; text-align: center; color: #666; font-size: 0.7rem;">
                        <p>No has creado rivales a√∫n.</p>
                        <p>Usa el bot√≥n "Gestionar Rivales" para crear uno.</p>
                     </div>`;
        }
        
        document.getElementById('lista-niveles').innerHTML = html;
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        document.getElementById('lista-niveles').innerHTML = `<p>Error cargando combates.</p>`;
    }
}


function generarBotonNivel(e, esPersonalizado = false) {
   
    const bloqueado = esPersonalizado ? false : !e.desbloqueado;
    const derrotado = parseInt(e.victorias) > 0;
    
    
    const estiloBorde = esPersonalizado ? 'border: 4px solid var(--azul-poke);' : '';
    const claseBtn = esPersonalizado ? 'is-primary' : (derrotado ? 'is-success' : '');
    
    const colorSubtitulo = bloqueado ? '#888' : (esPersonalizado ? '#e0e0e0' : '#555');

    let textoPrincipal = '';
    let textoSubtitulo = '';

    if (esPersonalizado) {
        textoPrincipal = e.nombre;
        textoSubtitulo = `Nvl promedio: ${e.nivel}`;
    } else {
        textoPrincipal = `Nivel ${e.nivel}`;
        textoSubtitulo = e.nombre;
    }
    

    return `
        <button 
            class="nes-btn ${bloqueado ? 'is-disabled' : claseBtn}" 
            ${bloqueado ? 'disabled' : ''}
            onclick="verNivel(${e.id})"
            style="padding: 15px; position: relative; ${estiloBorde}; min-height: 85px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;">
            
            <span style="font-size: 0.9rem; font-weight: bold;">
                ${bloqueado ? 'üîí ' : ''}${textoPrincipal}
            </span>

            ${derrotado ? '<span style="font-size: 0.6rem; color: #ffeb3b;">‚úì Vencido</span>' : ''}
            
            <span style="font-size: 0.6rem; color: ${colorSubtitulo}; text-transform: capitalize;">
                ${textoSubtitulo}
            </span>
        </button>
    `;
}

async function verNivel(id) {
    console.log('üëÅÔ∏è Ver nivel:', id);
    
    try {
        const res = await fetch(`${API_URL}/entrenadores/${id}`);
        entrenadorSeleccionado = await res.json();
        console.log('‚úÖ Entrenador cargado:', entrenadorSeleccionado);
        
        document.getElementById('nivel-titulo').textContent = `Nivel ${entrenadorSeleccionado.nivel}`;
        document.getElementById('nivel-nombre').textContent = entrenadorSeleccionado.nombre;
        document.getElementById('nivel-imagen').src = entrenadorSeleccionado.imagen_url;
        
        const equipoHTML = entrenadorSeleccionado.pokemons.map(p => `
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border: 3px solid #333; border-radius: 8px; background: white;">
                <img src="${p.imagen_url}" width="50" style="border: 2px solid #333; border-radius: 5px;"
                     onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png'">
                <div style="text-align: left; flex: 1;">
                    <div style="font-size: 0.7rem; text-transform: capitalize;">${p.nombre}</div>
                    <div style="font-size: 0.6rem; color: #666;">${p.tipos.join(' / ')}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Lvl ${p.nivel}</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('equipo-rival').innerHTML = equipoHTML;
        
        document.getElementById('view-nivel-detalle').classList.add('active');
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al cargar el entrenador: ' + error.message);
    }
}


function calcularMultiplicadorCliente(tiposAtacante, tiposDefensor, efectividades) {
    let sumaEfectividad = 0;
    
    if (!Array.isArray(efectividades)) {
        console.error('‚ùå efectividades no es un array');
        return 0;
    }

    for (const tipoAtacante of tiposAtacante) {
        for (const tipoDefensor of tiposDefensor) {
            const efectividad = efectividades.find(
                e => e.tipo_atacante === tipoAtacante && e.tipo_defensor === tipoDefensor
            );
            
            if (efectividad) {
                sumaEfectividad += parseFloat(efectividad.multiplicador);
            } else {
                sumaEfectividad += 1.0; 
            }
        }
    }
    
    return sumaEfectividad;
}

async function verPrediccion() {
    console.log('üîÆ Mostrando predicci√≥n...');
    
    try {
        if (!efectividades || efectividades.length === 0) {
            console.log('‚ö†Ô∏è Cargando efectividades...');
            const resEfectividad = await fetch(`${API_URL}/tipo-efectividad`);
            efectividades = await resEfectividad.json();
            console.log('‚úÖ Efectividades cargadas:', efectividades.length);
        }
        
        const equipoRes = await fetch(`${API_URL}/jugador/equipo`);
        equipoJugador = await equipoRes.json();
        console.log('üë• Equipo jugador:', equipoJugador);
        
        if (equipoJugador.error || equipoJugador.length === 0) {
            alert('‚ùå No ten√©s Pok√©mon en tu equipo. Agreg√° al menos uno antes de combatir.');
            return;
        }
        
        document.getElementById('view-nivel-detalle').classList.remove('active');
        document.getElementById('view-prediccion').classList.add('active');
        
        const jugadorHTML = equipoJugador.map(p => `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; border: 3px solid #333; border-radius: 8px; background: white;">
                <img src="${p.imagen_url}" width="50" style="border: 2px solid #333; border-radius: 5px;"
                     onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png'">
                <div style="text-align: left;">
                    <div style="font-size: 0.7rem; text-transform: capitalize;">${p.apodo || p.nombre}</div>
                    <div style="font-size: 0.6rem; color: #666;">${p.tipos.join(' / ')}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Lvl ${p.nivel}</div>
                </div>
            </div>
        `).join('');
        
        const rivalHTML = entrenadorSeleccionado.pokemons.map(p => `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; border: 3px solid #333; border-radius: 8px; background: white; justify-content: flex-end;">
                <div style="text-align: right;">
                    <div style="font-size: 0.7rem; text-transform: capitalize;">${p.nombre}</div>
                    <div style="font-size: 0.6rem; color: #666;">${p.tipos.join(' / ')}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Lvl ${p.nivel}</div>
                </div>
                <img src="${p.imagen_url}" width="50" style="border: 2px solid #333; border-radius: 5px;"
                     onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png'">
            </div>
        `).join('');
        
        document.getElementById('equipo-jugador-prediccion').innerHTML = jugadorHTML;
        document.getElementById('equipo-rival-prediccion').innerHTML = rivalHTML;
        
        const totalCombates = Math.min(equipoJugador.length, entrenadorSeleccionado.pokemons.length, 5);
        const predicciones = [];

        for (let i = 0; i < totalCombates; i++) {
            const pokemonJugador = equipoJugador[i];
            const pokemonRival = entrenadorSeleccionado.pokemons[i];

            const multiplicadorJugador = calcularMultiplicadorCliente(
                pokemonJugador.tipos,
                pokemonRival.tipos,
                efectividades
            );

            const multiplicadorRival = calcularMultiplicadorCliente(
                pokemonRival.tipos,
                pokemonJugador.tipos,
                efectividades
            );

            const poderJugador = pokemonJugador.nivel * multiplicadorJugador;
            const poderRival = pokemonRival.nivel * multiplicadorRival;
            
            const ganadorPredicho = poderJugador > poderRival ? 'jugador' : 'rival';
            
            predicciones.push({
                numero: i + 1,
                pokemonJugador: pokemonJugador.apodo || pokemonJugador.nombre,
                pokemonRival: pokemonRival.nombre,
                poderJugador: poderJugador.toFixed(2),
                poderRival: poderRival.toFixed(2),
                multiplicadorJugador: multiplicadorJugador.toFixed(2),
                multiplicadorRival: multiplicadorRival.toFixed(2),
                ganador: ganadorPredicho
            });
        }

        let victoriasPredichasJugador = 0;
        let victoriasPredichasRival = 0;
        
        predicciones.forEach(p => {
            if (p.ganador === 'jugador') {
                victoriasPredichasJugador++;
            } else {
                victoriasPredichasRival++;
            }
        });
        
        const ganarasLaBatalla = victoriasPredichasJugador >= 3;
        const mensajeResultado = `${victoriasPredichasJugador} vs ${victoriasPredichasRival}`;
        
        console.log('\nüèÜ PREDICCI√ìN:');
        console.log('   Victorias Jugador:', victoriasPredichasJugador);
        console.log('   Victorias Rival:', victoriasPredichasRival);
        console.log('   Resultado predicho:', ganarasLaBatalla ? 'VICTORIA' : 'DERROTA\n');
        
        const prediccionesHTML = predicciones.map(p => `
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; padding: 8px; border: 2px solid ${p.ganador === 'jugador' ? '#27ae60' : '#e74c3c'}; border-radius: 5px; background: ${p.ganador === 'jugador' ? '#e8f5e9' : '#ffebee'};">
                <div style="text-align: left; font-size: 0.6rem;">
                    <div style="font-weight: bold;">${p.pokemonJugador}</div>
                    <div style="color: #666;">Poder: ${p.poderJugador} (√ó${p.multiplicadorJugador})</div>
                </div>
                <div style="font-size: 0.7rem; font-weight: bold;">
                    ${p.ganador === 'jugador' ? '‚úÖ' : '‚ùå'}
                </div>
                <div style="text-align: right; font-size: 0.6rem;">
                    <div style="font-weight: bold;">${p.pokemonRival}</div>
                    <div style="color: #666;">Poder: ${p.poderRival} (√ó${p.multiplicadorRival})</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('lista-predicciones').innerHTML = prediccionesHTML;
        
        const porcentajeElement = document.getElementById('porcentaje-victoria');
        const mensajeElement = document.getElementById('mensaje-porcentaje');
        
        porcentajeElement.textContent = mensajeResultado;
        porcentajeElement.style.fontSize = '2rem';
        
        if (ganarasLaBatalla) {
            porcentajeElement.style.color = '#27ae60';
            mensajeElement.textContent = '¬°Vas a ganar!';
            mensajeElement.style.color = '#27ae60';
        } else {
            porcentajeElement.style.color = '#e74c3c';
            mensajeElement.textContent = 'Vas a perder';
            mensajeElement.style.color = '#e74c3c';
        }
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al calcular predicci√≥n: ' + error.message);
    }
}

function volverADetalleNivel() {
    document.getElementById('view-prediccion').classList.remove('active');
    document.getElementById('view-nivel-detalle').classList.add('active');
}

async function ejecutarCombate() {
    console.log('üé≤ Ejecutando combate...');
    
    try {
        const res = await fetch(`${API_URL}/entrenadores/${entrenadorSeleccionado.id}/combatir`, {
            method: 'POST'
        });
        
        resultadoCombate = await res.json();
        console.log('üìä Resultado:', resultadoCombate);
        
        if (resultadoCombate.error) {
            alert(`‚ùå ${resultadoCombate.mensaje || resultadoCombate.error}`);
            volverALista();
            return;
        }
        
        mostrarResultado();
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error durante el combate: ' + error.message);
        volverALista();
    }
}

function mostrarResultado() {
    console.log('üìã Mostrando resultado...');
    
    document.getElementById('view-prediccion').classList.remove('active');
    document.getElementById('view-resultado').classList.add('active');
    
    const gano = resultadoCombate.resultado === 'victoria';
    
    document.getElementById('resultado-titulo').textContent = gano ? 'üéâ ¬°Ganaste!' : 'üíî Perdiste';
    document.getElementById('resultado-titulo').style.color = gano ? 'green' : 'red';
    document.getElementById('resultado-mensaje').textContent = resultadoCombate.mensaje;
    
    document.getElementById('xp-jugador-ganada').textContent = `+${resultadoCombate.xp_jugador} XP`;
    document.getElementById('xp-pokemon-ganada').textContent = `+${resultadoCombate.xp_pokemon} XP`;
    document.getElementById('total-pokemons-text').textContent = `${resultadoCombate.total_pokemons} Pok√©mon`;
    
    const jugadorSubioElement = document.getElementById('jugador-subio-nivel');
    if (resultadoCombate.jugador_subio_nivel) {
        jugadorSubioElement.style.display = 'block';
        jugadorSubioElement.textContent = `üéâ ¬°Subiste al nivel ${resultadoCombate.jugador_niveles_subidos[resultadoCombate.jugador_niveles_subidos.length - 1]}!`;
    } else {
        jugadorSubioElement.style.display = 'none';
    }
    
    const subieron = resultadoCombate.pokemons_actualizados.filter(p => p.subio_nivel);
    console.log('‚¨ÜÔ∏è Pok√©mon que subieron:', subieron);
    
    if (subieron.length === 0) {
        document.getElementById('pokemons-subieron').innerHTML = `
            <p style="font-size: 0.7rem; color: #999;">Ning√∫n Pok√©mon subi√≥ de nivel</p>
        `;
    } else {
        const pokemonsHTML = subieron.map(p => `
            <div style="display: flex; align-items: center; gap: 15px; padding: 10px; border: 3px solid #27ae60; border-radius: 8px; background: #e8f5e9; width: 100%; max-width: 400px;">
                <div style="font-size: 2rem;">‚¨ÜÔ∏è</div>
                <div style="text-align: left; flex: 1;">
                    <div style="font-size: 0.8rem; text-transform: capitalize; font-weight: bold;">${p.pokemon}</div>
                    <div style="font-size: 0.7rem; color: #27ae60;">
                        Subi√≥ al nivel ${p.niveles_subidos.join(', ')}
                    </div>
                    <div style="font-size: 0.6rem; color: #666;">
                        +${p.xp_ganada} XP
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('pokemons-subieron').innerHTML = pokemonsHTML;
    }
}

function volverALista() {
    console.log('üîô Volviendo a lista...');
    
    document.getElementById('view-nivel-detalle').classList.remove('active');
    document.getElementById('view-prediccion').classList.remove('active');
    document.getElementById('view-resultado').classList.remove('active');
    
    entrenadorSeleccionado = null;
    resultadoCombate = null;
    
    window.location.hash = '#combates';
    cargarCombates();
    actualizarHUDJugador();
}

async function actualizarContadoresHabitat() {
    console.log('üîÑ Actualizando contadores de h√°bitat...');
    try {
        const res = await fetch(`${API_URL}/jugador/habitats`);
        if (!res.ok) throw new Error('Error al cargar habitats');
        
        const habitats = await res.json();
        
        for (let i = 1; i <= 6; i++) {
            const contador = document.getElementById(`hab-count-${i}`);
            if (contador) contador.textContent = '0';
        }

        habitats.forEach(h => {
            const idHabitat = h.habitat_id || h.id; 
            const cantidad = h.cantidad_pokemons || h.total || h.count || 0;
            
            const contador = document.getElementById(`hab-count-${idHabitat}`);
            if (contador) {
                contador.textContent = cantidad;
            }
        });

    } catch (error) {
        console.error('‚ùå Error actualizando contadores:', error);
    }
}

const infoHabitats = {
    1: { nombre: 'Pradera', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatllanura.jpg' },
    2: { nombre: 'Bosque', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatbosque.png' },
    3: { nombre: 'Playa', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatagua.png' },
    4: { nombre: 'Cueva', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatacero.png' },
    5: { nombre: 'Desierto', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitatdesierto.jpeg' },
    6: { nombre: 'Hielo', fondo: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/habitats/habitathielo.png' }
};

let habitatActualId = null;

async function cargarHabitat(id) {
    console.log('üå≤ Cargando h√°bitat:', id);
    habitatActualId = id;
    
    const info = infoHabitats[id];
    if (info) {
        document.getElementById('titulo-habitat-detalle').textContent = info.nombre;
        document.getElementById('fondo-habitat-detalle').src = info.fondo;
    }

    try {
        const res = await fetch(`${API_URL}/jugador/habitats/${id}/pokemons`);
        const pokemons = await res.json();
        
        const contenedor = document.getElementById('lista-slots-habitat');
        contenedor.innerHTML = ''; 

        for (let i = 0; i < 6; i++) {
            const pokemon = pokemons[i];

            if (pokemon) {
                contenedor.innerHTML += `
                    <a href="#poke-interaccion" class="poke-slot" 
                       onclick="interactuarPokemon(${pokemon.id}, '${pokemon.imagen_url}')">
                        <img src="${pokemon.imagen_url}" width="50">
                        <div>${pokemon.apodo || pokemon.nombre}</div>
                        <div style="color:var(--azul-poke);">Nvl ${pokemon.nivel}</div>
                    </a>
                `;
            } else {
                contenedor.innerHTML += `
                    <div class="poke-slot empty" onclick="abrirModalSeleccion(${id})">
                        + A√±adir
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error cargando habitat:', error);
    }
}
let habitatSeleccionadoId = null;

let tiposPermitidosHabitat = [];

async function abrirModalSeleccion(idHabitat) {
    habitatSeleccionadoId = idHabitat;
    document.getElementById('modal-seleccion-habitat').classList.add('active');
    
    const contenedor = document.getElementById('lista-candidatos-habitat');
    contenedor.innerHTML = '<p>Cargando compatibles...</p>';

    try {
        const resTipos = await fetch(`${API_URL}/habitats/${idHabitat}/tipos`);
        tiposPermitidosHabitat = await resTipos.json();
        
        const tituloModal = document.querySelector('#modal-seleccion-habitat h2');
        tituloModal.innerHTML = `Elige un Pok√©mon<br><span style="font-size:0.6rem; color:#666;">Admite: ${tiposPermitidosHabitat.join(', ')}</span>`;

        const [res, idsEnHabitats] = await Promise.all([
            fetch(`${API_URL}/jugador/pokemons`),
            obtenerIdsPokemonsEnHabitats()
        ]);
        const pokemons = await res.json();

        const compatibles = pokemons.filter(p => {
            const idReal = p.jugador_pokemon_id || p.id;
            const esTipoValido = p.tipos.some(tipo => tiposPermitidosHabitat.includes(tipo));
            const estaLibre = !idsEnHabitats.includes(idReal); 
            
            return esTipoValido && estaLibre;
        });
        
        let html = '';
        
        if (compatibles.length === 0) {
            html = `
                <div style="grid-column: 1/-1; text-align: center; color: #e74c3c;">
                    <p>No tienes Pok√©mon disponibles.</p>
                    <p style="font-size: 0.7rem;">Necesitas tipos: ${tiposPermitidosHabitat.join(', ')}</p>
                    <p style="font-size: 0.6rem; color: #666;">(Si ya tienes de este tipo, s√°calos de otro h√°bitat primero)</p>
                </div>`;
        } else {
            compatibles.forEach(p => {
                const idReal = p.id || p.jugador_pokemon_id;
                
                const tiposBadges = p.tipos.map(t => 
                    `<span style="font-size:0.5rem; background:#eee; padding:2px 4px; border-radius:3px;">${t}</span>`
                ).join(' ');

                html += `
                <div style="border: 2px solid #ccc; padding: 5px; display: flex; align-items: center; gap: 10px; cursor: pointer; background: white;" 
                     class="nes-pointer"
                     onclick="enviarPokemonAlHabitat(${idReal})">  
                    <img src="${p.imagen_url}" width="40">
                    <div>
                        <div style="font-size: 0.7rem; font-weight: bold;">${p.apodo || p.nombre}</div>
                        <div style="font-size: 0.6rem;">Nvl ${p.nivel}</div>
                        <div style="margin-top:2px;">${tiposBadges}</div>
                    </div>
                </div>
                `;
            });
        }

        contenedor.innerHTML = html;

    } catch (error) {
        console.error(error);
        contenedor.innerHTML = '<p>Error al cargar.</p>';
    }
}


async function enviarPokemonAlHabitat(jugadorPokemonId) {
    if (!habitatSeleccionadoId) return;

    const idParaRecargar = habitatSeleccionadoId;

    const lista = document.getElementById('lista-candidatos-habitat');
    lista.innerHTML = '<p style="text-align:center;">Asignando...</p>';

    try {
        const res = await fetch(`${API_URL}/jugador/habitats/${idParaRecargar}/asignar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jugador_pokemon_id: jugadorPokemonId })
        });

        const data = await res.json();

        if (data.error) {
            alert('‚ùå Error: ' + data.error);
            abrirModalSeleccion(idParaRecargar);
        } else {
            alert('‚úÖ ¬°Pok√©mon a√±adido al h√°bitat!');
            
            cerrarModalSeleccion();
            
            await cargarHabitat(idParaRecargar); 
            
            actualizarContadoresHabitat(); 
        }

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}
function cerrarModalSeleccion() {
    document.getElementById('modal-seleccion-habitat').classList.remove('active');
    habitatSeleccionadoId = null;
}

async function verificarEstadoJuego() {
    try {
        const res = await fetch(`${API_URL}/jugador`);
        
        if (res.status === 404) {
            console.log('üÜï Nuevo jugador detectado. Iniciando selecci√≥n de starter...');
            document.getElementById('view-inicializar').style.display = 'block';
            cargarStarters();
        } else {
            document.getElementById('view-inicializar').style.display = 'none';
        }
    } catch (error) {
        console.error('Error verificando estado:', error);
    }
}

async function cargarStarters() {
    try {
        const res = await fetch(`${API_URL}/inicializar/starters`);
        const starters = await res.json();
        
        const contenedor = document.getElementById('lista-starters');
        
        contenedor.innerHTML = starters.map(p => `
            <div class="nes-container is-rounded is-centered with-title" style="width: 220px; cursor: pointer; background: white; display: flex; flex-direction: column;" onclick="elegirStarter(${p.id})">
                <p class="title" style="text-transform: capitalize;">${p.nombre}</p>
                
                <img src="${p.imagen_url}" width="120" style="margin: 0 auto;">
                
                <div style="margin-top: 5px; margin-bottom: 15px; text-align: center;">
                    <span class="nes-text is-primary" style="font-size: 0.75rem; line-height: 1.4;">
                        Tipo:<br>${p.tipos.join(' / ')}
                    </span>
                </div>
                
                <button class="nes-btn is-success" style="margin-top: auto; width: 100%; padding: 5px;">¬°Te elijo a ti!</button>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error cargando starters:', error);
        document.getElementById('lista-starters').innerHTML = '<p class="nes-text is-error">Error al conectar con el servidor.</p>';
    }
}

async function elegirStarter(idPokemon) {
    if (!confirm("¬øEst√°s seguro de tu elecci√≥n? No podr√°s cambiarlo.")) return;

    try {
        const res = await fetch(`${API_URL}/inicializar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pokemon_starter_id: idPokemon })
        });

        const data = await res.json();

        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(`¬°Genial! Has comenzado tu aventura con ${data.pokemon_starter.nombre}.`);
            window.location.href = "#home";
            location.reload();
        }

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

let pokemonInteraccionId = null;

async function interactuarPokemon(id, imgUrl) {
    pokemonInteraccionId = id;
    console.log('ü•ï Interactuando con:', id);
    
    window.location.hash = '#poke-interaccion';
    
    if (imgUrl) {
        document.getElementById('int-img').src = imgUrl;
    }

    document.getElementById('int-nombre').textContent = 'Cargando...';
    document.getElementById('int-apodo-input').value = '';
    document.getElementById('int-bayas-qty').textContent = '--'; 

    await actualizarContadoresBayas(); 
    
    try {
        const resPoke = await fetch(`${API_URL}/jugador/pokemons/${id}/nivel`);
        const dataPoke = await resPoke.json();
        
        const nombreMostrar = dataPoke.apodo || dataPoke.pokemon || 'Pok√©mon';
        document.getElementById('int-nombre').textContent = nombreMostrar;
        document.getElementById('int-apodo-input').placeholder = "Cambiar nombre";
        
        actualizarBarraXP(dataPoke);
        await verificarEvolucionUI(id);

    } catch (error) {
        console.error(error);
        alert('Error al cargar datos del Pok√©mon');
    }
}
function actualizarBarraXP(data) {
    document.getElementById('int-nivel').textContent = `Nivel ${data.nivel}`;
    
    if (data.max_nivel) {
        document.getElementById('int-xp-text').textContent = 'M√ÅXIMO';
        document.getElementById('int-progress').value = 100;
        document.getElementById('int-progress').classList.remove('is-primary');
        document.getElementById('int-progress').classList.add('is-warning');
    } else {
        document.getElementById('int-xp-text').textContent = `XP: ${data.xp_en_nivel_actual} / ${data.xp_para_subir}`;
        document.getElementById('int-progress').value = data.porcentaje_progreso;
        document.getElementById('int-progress').classList.remove('is-warning');
        document.getElementById('int-progress').classList.add('is-primary');
    }
}

async function accionAlimentar() {
    if (!pokemonInteraccionId) return;
    
    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/alimentar`, {
            method: 'POST'
        });
        const data = await res.json();
        
        if (data.error) {
            alert('‚ùå ' + (data.mensaje || data.error));
        } else {
            await actualizarContadoresBayas(); 
            
            const resPoke = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/nivel`);
            const dataPoke = await resPoke.json();
            actualizarBarraXP(dataPoke);
        
            if (data.subio_nivel) {
                alert(`üéâ ¬°Subi√≥ de nivel!`);
                await verificarEvolucionUI(pokemonInteraccionId);
            }
        }
            
            const resPoke = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/nivel`);
            const dataPoke = await resPoke.json();
            actualizarBarraXP(dataPoke);
        
    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

async function accionQuitarDelHabitat() {
    if (!pokemonInteraccionId || !habitatActualId) return;

    if (!confirm("¬øQuieres devolver este Pok√©mon a la caja?")) return;

    try {
        const res = await fetch(`${API_URL}/jugador/habitats/${habitatActualId}/pokemons/${pokemonInteraccionId}`, {
            method: 'DELETE'
        });
        const data = await res.json();

        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Pok√©mon enviado a la caja.');
            cerrarInteraccion();
        }
    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

function abrirMenuSacar() {
    const nombre = document.getElementById('int-nombre').textContent;
    document.getElementById('nombre-sacar-pokemon').textContent = nombre;
    
    const modal = document.getElementById('modal-sacar-opciones');
    modal.style.display = 'flex'; 
}

async function ejecutarSalida(accion) {
    if (!pokemonInteraccionId) return;
    
    const modal = document.getElementById('modal-sacar-opciones');
    const nombre = document.getElementById('nombre-sacar-pokemon').textContent;

    try {
        let url, method, mensajeExito;

        if (accion === 'caja') {
            url = `${API_URL}/jugador/habitats/${habitatActualId}/pokemons/${pokemonInteraccionId}`;
            method = 'DELETE'; 
            mensajeExito = `‚úÖ ${nombre} ha sido enviado a tu Caja Pok√©mon.`;

        } else if (accion === 'liberar') {
            if (!confirm(`¬øEst√°s 100% seguro de liberar a ${nombre}?\n\nNO podr√°s recuperarlo.`)) return;
            
            url = `${API_URL}/jugador/pokemons/${pokemonInteraccionId}`; 
            method = 'DELETE'; 
            mensajeExito = `üëã Adi√≥s, ${nombre}. Fue liberado correctamente.`;
        }

        const res = await fetch(url, { method: method });
        const data = await res.json();

        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(mensajeExito);
            modal.style.display = 'none'; 
            cerrarInteraccion();          
        }

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

async function guardarApodo() {
    const nuevoApodo = document.getElementById('int-apodo-input').value;
    if (!nuevoApodo || !pokemonInteraccionId) return;
    
    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/apodo`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apodo: nuevoApodo })
        });
        
        const data = await res.json();
        
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('‚úÖ Nombre cambiado a: ' + data.apodo);
            document.getElementById('int-nombre').textContent = data.apodo;
            document.getElementById('int-apodo-input').value = '';
        }
    } catch (error) {
        console.error(error);
    }
}

let intervaloGranja = null;

async function cargarGranja() {
    if (intervaloGranja) clearInterval(intervaloGranja);

    const nivelesDesbloqueo = { 2: 3, 3: 6, 4: 12, 5: 18, 6: 25 };

    try {
        await actualizarContadoresBayas();

        const res = await fetch(`${API_URL}/jugador/granjas`);
        if (!res.ok) {
            document.getElementById('lista-granjas').innerHTML = '<p>Error de conexi√≥n.</p>';
            return;
        }

        const data = await res.json();
        const listaGranjas = data.granjas || [];
        const contenedor = document.getElementById('lista-granjas');
        contenedor.innerHTML = '';

        if (listaGranjas.length === 0) {
            contenedor.innerHTML = '<p style="width:100%;">No tienes parcelas.</p>';
            return;
        }

        listaGranjas.forEach(g => {
            const numero = g.numero_granja;
            const imagenGranja = "https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/imagen%20granja/granjasinfondo.png";
            
            let imagenHTML = '';
            let botonAccion = '';
            let estiloContenedor = 'background: white;'; 

            if (!g.desbloqueada) {
                
                const nivelReq = nivelesDesbloqueo[numero] || 30;
                estiloContenedor = 'background: #e0e0e0; color: #777;'; 

                imagenHTML = `
                    <div style="position: relative; width: 100%; height: 120px; display:flex; align-items:center; justify-content:center;">
                        <img src="${imagenGranja}" style="height: 100%; width: auto; filter: grayscale(100%); opacity: 0.4;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                    background: #333; color: white; padding: 6px 10px; border-radius: 4px; 
                                    font-size: 0.8rem; z-index: 10; white-space: nowrap;">
                            üîí Nivel ${nivelReq}
                        </div>
                    </div>
                `;
                botonAccion = `<button class="nes-btn is-disabled" style="width: 100%; font-size: 0.7rem; margin-top: 10px;">BLOQUEADO</button>`;

            } else {
                imagenHTML = `
                    <div style="width: 100%; height: 120px; display:flex; align-items:center; justify-content:center;">
                        <img src="${imagenGranja}" style="height: 100%; width: auto; filter: drop-shadow(0 4px 0 rgba(0,0,0,0.2));">
                    </div>
                `;

                if (g.puede_recolectar) {
                    botonAccion = `
                        <button class="nes-btn is-warning" onclick="recolectar(${g.granja_id})" style="width: 100%; font-size: 0.7rem; margin-top: 10px; padding: 5px;">
                            RECOLECTAR (+10 üçí)
                        </button>`;
                } else {
                    let segundosRestantes = Math.floor(g.tiempo_restante);
                    
                    const min = Math.floor(segundosRestantes / 60);
                    const seg = segundosRestantes % 60;
                    const textoInicial = `‚è≥ ${min}:${seg.toString().padStart(2, '0')}`;

                    botonAccion = `
                        <button class="nes-btn is-primary granja-timer" 
                                data-segundos="${segundosRestantes}"
                                style="width: 100%; font-size: 0.7rem; margin-top: 10px; opacity: 0.8; cursor: default;">
                            ${textoInicial}
                        </button>`;
                }
            }

            contenedor.innerHTML += `
                <div class="nes-container is-rounded" style="${estiloContenedor} padding: 15px; text-align: center;">
                    <h3 style="font-size: 0.9rem; margin: 0 0 15px 0; border-bottom: 2px dashed #ccc; padding-bottom: 5px;">
                        Parcela ${numero}
                    </h3>
                    ${imagenHTML}
                    ${botonAccion}
                </div>
            `;
        });

        intervaloGranja = setInterval(async () => {
            await actualizarContadoresBayas();
            
            const timers = document.querySelectorAll('.granja-timer');
            
            if (timers.length === 0) {
                return;
            };

            let algunCambio = false;

            timers.forEach(btn => {
                let segs = parseInt(btn.getAttribute('data-segundos'));
                
                if (segs > 0) {
                    segs--;
                    btn.setAttribute('data-segundos', segs);
                    
                    const m = Math.floor(segs / 60);
                    const s = segs % 60;
                    btn.innerHTML = `‚è≥ ${m}:${s.toString().padStart(2, '0')}`;
                } else {
                    if (!btn.classList.contains('finalizado')) {
                        btn.classList.add('finalizado');
                        algunCambio = true;
                    }
                }
            });

            if (algunCambio) {
                cargarGranja();
            }

        }, 1000);

    } catch (error) { console.error('Error cargando granja:', error); }
}

async function recolectar(granjaId) {
    try {
        const btn = event.target; 
        const textoOriginal = btn.innerHTML;
        btn.innerHTML = '‚è≥...';
        btn.disabled = true;

        const res = await fetch(`${API_URL}/jugador/granjas/${granjaId}/recolectar`, { method: 'POST' });
        const data = await res.json();

        if (data.error) {
            alert(data.mensaje || data.error);
      } else {
    console.log("‚úÖ Recolectado con √©xito");
    await actualizarContadoresBayas(); 
    await cargarGranja(); 
    await actualizarHUDJugador();
}
    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}

async function actualizarContadoresBayas() {
    try {
        const res = await fetch(`${API_URL}/jugador/inventario?t=${Date.now()}`);
        if (res.ok) {
            const inventario = await res.json();
            
            const bayas = inventario.find(i => i.fruta_id === 1 || i.id === 1);
            const cantidadReal = bayas ? bayas.cantidad : 0;

            console.log("üîÑ Cantidad real detectada:", cantidadReal);

            const cGranja = document.getElementById('contador-bayas-granja');
            const cAlimentar = document.getElementById('int-bayas-qty');

            if (cGranja) cGranja.innerText = cantidadReal;
            if (cAlimentar) cAlimentar.innerText = cantidadReal;
            
            return cantidadReal;
        }
    } catch (error) {
        console.error("‚ùå Error de sincronizaci√≥n:", error);
    }
}
function cerrarInteraccion() {
    if (habitatActualId) {
        cargarHabitat(habitatActualId);
        window.location.hash = '#habitat-detalle';
    } else {
        window.location.hash = '#habitats';
    }
}


async function verificarEvolucionUI(id) {
    const zonaEvo = document.getElementById('zona-evolucion');
    zonaEvo.style.display = 'none'; 

    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${id}/puede-evolucionar`);
        const data = await res.json();

        if (data.puede_evolucionar) {
            zonaEvo.style.display = 'block';
            console.log("‚ú® Evoluci√≥n disponible:", data.mensaje);
        }
    } catch (error) {
        console.error("Error verificando evoluci√≥n:", error);
    }
}

async function realizarEvolucion() {
    if (!pokemonInteraccionId) return;

    const btn = document.querySelector('#zona-evolucion button');
    const textoOriginal = btn.textContent;
    btn.textContent = "Evolucionando...";
    btn.disabled = true;

    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/evolucionar`, {
            method: 'POST'
        });
        const data = await res.json();

        if (data.error) {
            alert(data.mensaje || data.error);
            btn.textContent = textoOriginal;
            btn.disabled = false;
        } else {
            alert(`‚ú® ¬°Enhorabuena! Tu ${data.pokemon_anterior} evolucion√≥ a ${data.pokemon_nuevo}! ‚ú®`);
            
            document.getElementById('int-img').src = data.pokemon.imagen_url;
            document.getElementById('int-nombre').textContent = data.pokemon.apodo || data.pokemon.nombre;
            
            document.getElementById('zona-evolucion').style.display = 'none';

            const resPoke = await fetch(`${API_URL}/jugador/pokemons/${pokemonInteraccionId}/nivel`);
            const dataPoke = await resPoke.json();
            actualizarBarraXP(dataPoke);
            actualizarHUDJugador();
        }
    } catch (error) {
        console.error(error);
        alert('Error al evolucionar');
        btn.textContent = textoOriginal;
        btn.disabled = false;
    }
}

let zonaActualId = null;
let pokemonCapturadoTempId = null; 

const fondosZonas = {
    1: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturallanura.png',
    2: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturabosque.png',
    3: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturaplaya.png',
    4: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturacueva.png',
    5: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturadesierto.png',
    6: 'https://raw.githubusercontent.com/lucas-loiacono/imagenes/refs/heads/main/assets/nuevas_zonas_captura/zonacapturahielo.png'
};

function cargarEscenario(zonaId) {
    zonaActualId = zonaId;
    const fondo = fondosZonas[zonaId] || fondosZonas[1];
    
    document.getElementById('img-escenario-fondo').src = fondo;
    document.getElementById('titulo-zona-captura').textContent = "Explorando...";
    
    const btn = document.getElementById('btn-lanzar');
    btn.disabled = false;
    btn.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Pokebola-pokeball-png-0.png" style="width:24px;"> ¬°Lanzar Ball!';
    btn.className = "nes-btn is-error"; 
}

async function lanzarPokeball() {
    const btn = document.getElementById('btn-lanzar');
    btn.disabled = true;
    btn.innerHTML = "Lanzando...";
    btn.className = "nes-btn is-disabled";

    try {
        const res = await fetch(`${API_URL}/zonas/${zonaActualId}/capturar`, {
            method: 'POST'
        });
        const data = await res.json();

        if (data.error) {
            alert(data.mensaje || data.error);
            btn.innerHTML = "Caja Llena";
            return;
        }

        pokemonCapturadoTempId = data.jugador_pokemon_id; 

        document.getElementById('res-img-pokemon').src = data.imagen_url;
        document.getElementById('res-nombre-pokemon').textContent = data.nombre;
        
        const tiposTexto = data.tipos ? data.tipos.join(' / ') : 'Desconocido';
        document.getElementById('res-tipos-pokemon').textContent = tiposTexto;

        document.querySelectorAll('input[name="decision-captura"]')[0].checked = true;

        window.location.hash = '#captura-resultado';

    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n con el servidor');
        btn.disabled = false;
        btn.innerHTML = "Reintentar";
        btn.className = "nes-btn is-error";
    }
}

async function finalizarCaptura() {
    const accion = document.querySelector('input[name="decision-captura"]:checked').value;

    if (accion === 'liberar' && pokemonCapturadoTempId) {
        if (!confirm("¬øSeguro? Si lo liberas no podr√°s recuperarlo.")) return;

        try {
            const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonCapturadoTempId}`, {
                method: 'DELETE'
            });
            const data = await res.json();
            
            if (data.error) {
                alert("Error al liberar: " + data.error);
            } else {
                alert(`Has liberado al Pok√©mon. ¬°Adi√≥s!`);
            }
        } catch (error) {
            console.error(error);
        }
    } else {
        alert("¬°Pok√©mon enviado a tu Caja!");
    }

    window.location.hash = '#capturar';
}


async function actualizarHUDJugador() {
    try {
        await fetch(`${API_URL}/jugador/verificar-nivel`, { method: 'POST' });

        const res = await fetch(`${API_URL}/jugador/nivel`);
        
        if (res.ok) {
            const data = await res.json();
            
            const elNivel = document.getElementById('hud-nivel-num');
            const elTexto = document.getElementById('hud-xp-texto');
            const elBarra = document.getElementById('hud-xp-bar');
            
            if (elNivel) elNivel.textContent = data.nivel;
            if (elTexto) elTexto.textContent = `${data.xp_en_nivel_actual} / ${data.xp_para_subir}`;
            
            if (elBarra) {
                elBarra.value = data.xp_en_nivel_actual;
                elBarra.max = data.xp_para_subir;
            }
            
            console.log(`‚≠ê HUD: Nivel ${data.nivel} | XP Barra: ${data.xp_en_nivel_actual}/${data.xp_para_subir}`);
        }
    } catch (error) {
        console.error("Error actualizando HUD:", error);
    }
}

let pokemonsEnCaja = []; 
let pokemonCajaSeleccionado = null;

async function cargarCaja() {
    console.log('üì¶ Cargando Caja...');
    const contenedor = document.getElementById('lista-caja');
    const titulo = document.getElementById('titulo-caja');
    
    contenedor.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">Cargando...</p>';

    try {
        const [resPokemons, idsEnHabitats] = await Promise.all([
            fetch(`${API_URL}/jugador/pokemons`),
            obtenerIdsPokemonsEnHabitats()
        ]);
        
        const todosLosPokemons = await resPokemons.json();

        const resNivel = await fetch(`${API_URL}/jugador/nivel`);
        const datosNivel = await resNivel.json();
        const capacidadMax = datosNivel.slots_inventario || 10;

        pokemonsEnCaja = todosLosPokemons.filter(p => {
            const id = p.jugador_pokemon_id || p.id;
            return !idsEnHabitats.includes(id);
        });

        titulo.textContent = `Mi Caja (${todosLosPokemons.length}/${capacidadMax})`;

        if (pokemonsEnCaja.length === 0) {
            contenedor.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1; padding: 20px;">Tu caja est√° vac√≠a o todos tus Pok√©mon est√°n entrenando en h√°bitats.</p>';
            return;
        }

        contenedor.innerHTML = pokemonsEnCaja.map(p => `
            <div class="box-item nes-pointer" style="cursor: pointer;" onclick="verDetalleCaja(${p.jugador_pokemon_id || p.id})">
                <img src="${p.imagen_url}" width="60" style="image-rendering: pixelated; margin-bottom: 5px;"><br>
                <strong style="text-transform: capitalize;">${p.apodo || p.nombre}</strong><br>
                <span style="color: var(--azul-poke);">Nvl ${p.nivel}</span>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error cargando la caja:', error);
        contenedor.innerHTML = '<p style="color: red; text-align: center; grid-column: 1/-1;">Error de conexi√≥n.</p>';
    }
}

function verDetalleCaja(id) {
    const p = pokemonsEnCaja.find(poke => poke.jugador_pokemon_id === id);
    if (!p) return;

    pokemonCajaSeleccionado = p;
    document.getElementById('caja-poke-nombre').textContent = p.apodo || p.nombre;
    document.getElementById('caja-poke-img').src = p.imagen_url;
    document.getElementById('caja-poke-nivel').textContent = p.nivel;
    document.getElementById('caja-poke-tipos').textContent = p.tipos ? p.tipos.join(' / ') : 'Desconocido';
    
    document.getElementById('modal-opciones-caja').style.display = 'flex';
}

document.getElementById('btn-liberar-caja').onclick = async () => {
    if (!pokemonCajaSeleccionado) return;
    const nombre = pokemonCajaSeleccionado.apodo || pokemonCajaSeleccionado.nombre;

    if (!confirm(`¬øEst√°s 100% seguro de liberar a ${nombre}?\n\nNO podr√°s recuperarlo.`)) return;

    try {
        const res = await fetch(`${API_URL}/jugador/pokemons/${pokemonCajaSeleccionado.jugador_pokemon_id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.error) {
            alert(data.error);
        } else {
            alert(data.mensaje); 
            document.getElementById('modal-opciones-caja').style.display = 'none';
            cargarCaja(); 
        }
    } catch (e) { 
        console.error(e); 
        alert('Error de conexi√≥n');
    }
}

let posicionEquipoSeleccionada = null;

async function cargarEquipo() {
    console.log('‚öîÔ∏è Cargando equipo...');
    const contenedor = document.getElementById('lista-equipo');
    contenedor.innerHTML = '<p>Cargando...</p>';

    try {
        const res = await fetch(`${API_URL}/jugador/equipo`);
        const equipo = res.ok ? await res.json() : [];
        const equipoData = Array.isArray(equipo) ? equipo : []; 
        
        let html = '';
        
        for (let i = 1; i <= 5; i++) {
            const pokemonEnSlot = equipoData.find(p => p.posicion === i);

            if (pokemonEnSlot) {
                html += `
                <div class="team-slot">
                    <div class="team-info">
                        <span style="font-weight: bold; color: #aaa; font-size: 0.9rem; margin-right: 5px;">#${i}</span>
                        <img src="${pokemonEnSlot.imagen_url}" width="50" style="image-rendering: pixelated;">
                        <div>
                            <div class="team-name">${pokemonEnSlot.apodo || pokemonEnSlot.nombre}</div>
                            <div class="team-lvl">Nivel ${pokemonEnSlot.nivel}</div>
                        </div>
                    </div>
                    <button class="nes-btn is-error" style="font-size: 0.6rem; padding: 2px 8px;" onclick="quitarDelEquipo(${i})" title="Quitar del equipo">X</button>
                </div>
                `;
            } else {
                html += `
                <div class="team-slot slot-empty" onclick="abrirModalEquipo(${i})">
                    <span style="font-weight: bold; margin-right: 10px;">#${i}</span> + A√ëADIR POK√âMON
                </div>
                `;
            }
        }
        
        contenedor.innerHTML = html;

    } catch (error) {
        console.error(error);
        contenedor.innerHTML = '<p>Error de conexi√≥n al cargar equipo.</p>';
    }
}

async function abrirModalEquipo(pos) {
    posicionEquipoSeleccionada = pos;
    document.getElementById('modal-seleccion-equipo').style.display = 'flex';
    
    const contenedor = document.getElementById('lista-candidatos-equipo');
    contenedor.innerHTML = 'Cargando...';
    
    try {
        const [resPokemons, resEquipo] = await Promise.all([
            fetch(`${API_URL}/jugador/pokemons`),
            fetch(`${API_URL}/jugador/equipo`)
        ]);
        
        const todos = await resPokemons.json();
        const equipoActual = resEquipo.ok ? await resEquipo.json() : [];
        const equipoData = Array.isArray(equipoActual) ? equipoActual : [];
        
        const idsEnEquipo = equipoData.map(p => p.jugador_pokemon_id);
        const disponibles = todos.filter(p => !idsEnEquipo.includes(p.jugador_pokemon_id));
        
        if (disponibles.length === 0) {
            contenedor.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No tienes m√°s Pok√©mon disponibles en la Caja.</p>';
            return;
        }
        
        contenedor.innerHTML = disponibles.map(p => `
            <div style="border: 2px solid #ccc; padding: 5px; display: flex; align-items: center; gap: 10px; cursor: pointer; background: white;" 
                 class="nes-pointer" onclick="asignarAlEquipo(${p.jugador_pokemon_id})">  
                <img src="${p.imagen_url}" width="40" style="image-rendering: pixelated;">
                <div style="text-align: left;">
                    <div style="font-size: 0.7rem; font-weight: bold; text-transform: capitalize;">${p.apodo || p.nombre}</div>
                    <div style="font-size: 0.6rem; color: var(--azul-poke);">Nvl ${p.nivel}</div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error(error);
    }
}

function cerrarModalEquipo() {
    document.getElementById('modal-seleccion-equipo').style.display = 'none';
    posicionEquipoSeleccionada = null;
}

async function asignarAlEquipo(idPokemon) {
    try {
        const res = await fetch(`${API_URL}/jugador/equipo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jugador_pokemon_id: idPokemon, posicion: posicionEquipoSeleccionada })
        });
        
        const data = await res.json();
        if (data.error) {
            alert(data.error);
        } else {
            cerrarModalEquipo();
            cargarEquipo(); 
        }
    } catch (error) {
        console.error(error);
        alert("Error de conexi√≥n");
    }
}

async function quitarDelEquipo(posicion) {
    try {
        const res = await fetch(`${API_URL}/jugador/equipo/${posicion}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.error) {
            alert(data.error);
        } else {
            cargarEquipo(); 
        }
    } catch (error) {
        console.error(error);
    }
}
async function obtenerIdsPokemonsEnHabitats() {
    let idsOcupados = [];
    try {
        const promesas = [1,2,3,4,5,6].map(id => 
            fetch(`${API_URL}/jugador/habitats/${id}/pokemons`).then(r => r.ok ? r.json() : [])
        );
        const resultados = await Promise.all(promesas);
        
        resultados.forEach(lista => {
            lista.forEach(p => {
                if (p) { 
                    idsOcupados.push(p.jugador_pokemon_id || p.id);
                }
            });
        });
    } catch (e) {
        console.error("Error obteniendo ocupados:", e);
    }
    return idsOcupados;
}


async function borrarPartida() {
    const seguro = confirm("‚ö†Ô∏è ¬øEst√°s 100% seguro de que quieres BORRAR TU PARTIDA?\n\nPerder√°s todos tus Pok√©mon, niveles y granjas para siempre.");
    
    if (!seguro) return;

    try {
        const res = await fetch(`${API_URL}/jugador`, { method: 'DELETE' });
        
        if (res.ok) {
            alert("Partida borrada. Comenzar√°s tu aventura desde cero.");
            
            localStorage.clear(); 
            
            window.location.hash = "#home";
            location.reload(); 
        } else {
            const data = await res.json();
            alert("Error al intentar borrar la partida: " + (data.error || "Desconocido"));
        }
    } catch (error) {
        console.error("Error de conexi√≥n al borrar partida:", error);
        alert("Error de conexi√≥n con el servidor.");
    }
}


async function cargarListaHabitats() {
    const contenedor = document.getElementById('lista-habitats-dinamica');
    contenedor.innerHTML = '<p>Cargando...</p>';

    try {
        const [resDefs, resJug] = await Promise.all([
            fetch(`${API_URL}/habitats`),        
            fetch(`${API_URL}/jugador/habitats`)
        ]);

        const definiciones = await resDefs.json();
        const contadores = await resJug.json();

        contenedor.innerHTML = '';

        definiciones.forEach(h => {
            const dato = contadores.find(c => c.habitat_id === h.id) || { cantidad_pokemons: 0 };
            
            contenedor.innerHTML += `
                <div class="gen-card nes-container is-rounded" style="position: relative; padding-top: 30px;">
                    
                    <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 10;">
                        <button class="nes-btn is-warning" style="padding: 0 5px; font-size: 0.6rem;" onclick="editarHabitat(${h.id}, '${h.tipo}', '${h.imagen_url}')">‚úèÔ∏è</button>
                        <button class="nes-btn is-error" style="padding: 0 5px; font-size: 0.6rem;" onclick="eliminarHabitat(${h.id})">X</button>
                    </div>

                    <img src="${h.imagen_url || 'https://via.placeholder.com/150'}" class="zone-img">
                    
                    <div class="zone-body">
                        <h3>${h.tipo} (${dato.cantidad_pokemons}/6)</h3> 
                        <a href="#habitat-detalle" class="nes-btn" onclick="entrarHabitat(${h.id}, '${h.tipo}', '${h.imagen_url}')">Entrar</a>
                    </div>
                </div>
            `;
        });
    } catch (e) { console.error(e); contenedor.innerHTML = 'Error cargando datos.'; }
}

async function entrarHabitat(id, nombre, imagen) {
    habitatActualId = id;
    document.getElementById('titulo-habitat-detalle').textContent = nombre;
    document.getElementById('fondo-habitat-detalle').src = imagen;
    await cargarHabitat(id); 
}


async function crearNuevoHabitat() {
    const nombre = prompt("Nombre del H√°bitat (ej: Volc√°n):");
    if (!nombre) return;
    
    const imagen = prompt("URL de la imagen de fondo:");
    if (!imagen) return;

    const tiposRaw = prompt("Tipos permitidos separados por coma (ej: Fuego, Dragon, Normal):");
    if (!tiposRaw) return;

    const tiposArray = tiposRaw.split(',').map(t => t.trim());

    try {
        const res = await fetch(`${API_URL}/habitats`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                nombre: nombre, 
                imagen_url: imagen,
                tiposAceptados: tiposArray 
            })
        });

        if (res.ok) {
            alert("‚úÖ H√°bitat restrictivo creado con √©xito.");
            cargarListaHabitats();
        } else {
            const err = await res.json();
            alert("‚ùå Error: " + err.error);
        }
    } catch (e) { 
        alert("Error de conexi√≥n al crear."); 
    }
}

async function editarHabitat(id, nombreActual, imagenActual) {
    const nombre = prompt("Nuevo nombre:", nombreActual);
    if (nombre === null) return;
    const imagen = prompt("Nueva URL imagen:", imagenActual);
    
    await fetch(`${API_URL}/habitats/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ nombre, imagen_url: imagen })
    });
    cargarListaHabitats();
}

async function eliminarHabitat(id) {
    if(!confirm("¬øBorrar h√°bitat? Los Pok√©mon volver√°n a la caja.")) return;
    await fetch(`${API_URL}/habitats/${id}`, { method: 'DELETE' });
    cargarListaHabitats();
}


async function cargarListaZonas() {
    const contenedor = document.getElementById('lista-zonas-dinamica');
    contenedor.innerHTML = '<p>Cargando...</p>';

    try {
        const res = await fetch(`${API_URL}/zonas`);
        const zonas = await res.json();
        
        contenedor.innerHTML = '';
        
        zonas.forEach(z => {
            contenedor.innerHTML += `
                <div class="gen-card nes-container is-rounded" style="position: relative; padding-top: 30px;">
                    
                    <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 10;">
                        <button class="nes-btn is-warning" style="padding: 0 5px; font-size: 0.6rem;" onclick="editarZona(${z.id}, '${z.nombre}', '${z.imagen_url}')">‚úèÔ∏è</button>
                        <button class="nes-btn is-error" style="padding: 0 5px; font-size: 0.6rem;" onclick="eliminarZona(${z.id})">X</button>
                    </div>

                    <img src="${z.imagen_url}" class="zone-img">
                    <div class="zone-body">
                        <h3>${z.nombre}</h3>
                        <a href="#captura-escenario" class="nes-btn is-primary" onclick="cargarEscenario(${z.id}, '${z.imagen_url}')">Buscar</a>
                    </div>
                </div>
            `;
        });
    } catch (e) { console.error(e); }
}

function cargarEscenario(zonaId, imagenUrl) {
    zonaActualId = zonaId;
    document.getElementById('img-escenario-fondo').src = imagenUrl;
    document.getElementById('titulo-zona-captura').textContent = "Explorando...";
    
    const btn = document.getElementById('btn-lanzar');
    btn.disabled = false;
    btn.innerHTML = '¬°Lanzar Ball!';
    btn.className = "nes-btn is-error"; 
}


async function crearNuevaZona() {
    const nombre = prompt("Nombre de la Zona (ej: Monta√±a Rocosa):");
    if (!nombre) return;
    
    const imagen = prompt("URL de la imagen de fondo:");
    if (!imagen) return;

    const tiposRaw = prompt("Tipos de Pok√©mon que aparecer√°n (ej: Roca, Tierra):");
    if (!tiposRaw) return;

    const tiposArray = tiposRaw.split(',').map(t => t.trim());

    try {
        const res = await fetch(`${API_URL}/zonas`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                nombre: nombre, 
                imagen_url: imagen,
                tiposAceptados: tiposArray 
            })
        });

        if (res.ok) {
            alert("‚úÖ Zona creada con √©xito.");
            await cargarListaZonas(); 
        } else {
            const err = await res.json();
            alert("‚ùå Error: " + err.error);
        }
    } catch (e) { 
        console.error(e);
        alert("Error de conexi√≥n al crear zona."); 
    }
}

async function editarZona(id, nombreActual, imagenActual) {
    const nombre = prompt("Nuevo nombre:", nombreActual);
    if (!nombre) return;
    const imagen = prompt("Nueva URL imagen:", imagenActual);

    await fetch(`${API_URL}/zonas/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ nombre, imagen_url: imagen })
    });
    cargarListaZonas();
}

async function eliminarZona(id) {
    if(!confirm("¬øEliminar zona?")) return;
    await fetch(`${API_URL}/zonas/${id}`, { method: 'DELETE' });
    cargarListaZonas();
}


let todosLosPokedex = []; 
let entrenadorEditandoId = null;


async function abrirGestionRivales() {
    document.getElementById('modal-gestion-rivales').style.display = 'block';
    const contenedor = document.getElementById('lista-gestion-entrenadores');
    contenedor.innerHTML = '<p style="text-align:center;">Cargando...</p>';

    try {
        const [resEnt, resPoke] = await Promise.all([
            fetch(`${API_URL}/entrenadores`),
            fetch(`${API_URL}/pokemons`)
        ]);
        
        const todos = await resEnt.json();
        todosLosPokedex = await resPoke.json(); 
        
        const misRivales = todos.filter(e => e.descripcion === 'Entrenador Personalizado');

        if(misRivales.length === 0) {
            contenedor.innerHTML = '<p style="text-align:center;">No has creado rivales a√∫n.</p>';
            return;
        }

        contenedor.innerHTML = misRivales.map(e => `
            <div class="nes-container is-rounded with-title" style="background: white; padding: 10px;">
                <p class="title">Rival Personalizado (Nvl ${e.nivel})</p>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="${e.imagen_url}" style="width: 60px; height: 60px; object-fit: cover; border: 2px solid #333;" onerror="this.src='https://via.placeholder.com/60'">
                    <div style="flex: 1;">
                        <strong style="font-size: 0.9rem;">${e.nombre}</strong><br>
                        <span style="font-size: 0.7rem; color: #666;">Haz click en Editar para ver su equipo.</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="nes-btn is-primary" style="padding: 5px 10px; font-size: 0.7rem;" onclick="cargarDatosYEditar(${e.id})">‚úèÔ∏è Editar</button>
                        <button class="nes-btn is-error" style="padding: 5px 10px; font-size: 0.7rem;" onclick="borrarEntrenador(${e.id})">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        `).join('');

    } catch (e) {
        console.error(e);
        contenedor.innerHTML = '<p>Error de conexi√≥n.</p>';
    }
}


async function abrirModalEditorCompleto() {
    entrenadorEditandoId = null; 
    document.getElementById('titulo-editor-completo').textContent = "Crear Nuevo Rival";
    
    
    document.getElementById('edit-nombre').value = "";
    document.getElementById('edit-img').value = "";
    
    generarInputsEquipo([]); 
    
    document.getElementById('modal-editor-completo').style.display = 'flex';
}

async function cargarDatosYEditar(id) {
    entrenadorEditandoId = id; 
    document.getElementById('titulo-editor-completo').textContent = "Editar Rival";
    
    try {
        const res = await fetch(`${API_URL}/entrenadores/${id}`);
        const data = await res.json();
        
        document.getElementById('edit-nombre').value = data.nombre;
        document.getElementById('edit-img').value = data.imagen_url;
        
        generarInputsEquipo(data.pokemons || []);
        
        document.getElementById('modal-editor-completo').style.display = 'flex';
    } catch (e) { console.error(e); }
}


function generarInputsEquipo(equipoExistente) {
    const contenedor = document.getElementById('lista-slots-inputs');
    contenedor.innerHTML = '';
    
    for (let i = 1; i <= 5; i++) {
        
        const poke = equipoExistente.find(p => p.posicion === i);
        let valId = '';
        if (poke) {
            valId = poke.pokedex_id || ''; 
        }

        const valNivel = poke ? poke.nivel : 1;

        const div = document.createElement('div');
        div.style.cssText = "display: flex; gap: 10px; align-items: center; background: #fafafa; padding: 5px; border: 1px solid #ddd;";
        
        div.innerHTML = `
            <span style="font-weight:bold; width: 20px;">#${i}</span>
            
            <div style="flex: 1;">
                <label style="font-size: 0.6rem;">ID Pok√©dex</label>
                <input type="number" id="slot-id-${i}" class="nes-input" placeholder="Ej: 1, 4, 7..." value="${valId}" min="1">
            </div>

            <div style="width: 80px;">
                <label style="font-size: 0.6rem;">Nivel (Max 30)</label>
                <input type="number" id="slot-lvl-${i}" class="nes-input" value="${valNivel}" min="1" max="30">
            </div>
        `;
        contenedor.appendChild(div);
    }
}


async function guardarEntrenadorCompleto() {
    const nombre = document.getElementById('edit-nombre').value;
    const img = document.getElementById('edit-img').value || 'https://via.placeholder.com/150';
    
    if (!nombre) return alert("¬°El nombre es obligatorio!");

    const nuevoEquipo = [];
    let sumaNiveles = 0;
    let contadorPokemons = 0;

    for (let i = 1; i <= 5; i++) {
        const inputId = document.getElementById(`slot-id-${i}`).value;
        const inputLvl = document.getElementById(`slot-lvl-${i}`).value;

        if (inputId) { 
            const pokedexId = parseInt(inputId);
            let nivel = parseInt(inputLvl);

            if (nivel > 30) {
                alert(`‚ö†Ô∏è El nivel en la posici√≥n #${i} es ${nivel}. El m√°ximo es 30.`);
                return; 
            }
            if (nivel < 1 || isNaN(nivel)) nivel = 1;

            const pokemonReal = todosLosPokedex.find(p => p.pokedex_id === pokedexId);
            
            if (!pokemonReal) {
                alert(`‚ö†Ô∏è No existe ning√∫n Pok√©mon con ID de Pok√©dex: ${pokedexId} (Posici√≥n #${i})`);
                return;
            }

            nuevoEquipo.push({
                pokemon_id: pokemonReal.id, 
                nivel: nivel,
                posicion: i
            });

            sumaNiveles += nivel;
            contadorPokemons++;
        }
    }

    if (nuevoEquipo.length === 0) return alert("Debes agregar al menos 1 Pok√©mon al equipo.");
   
    const nivelPromedio = Math.ceil(sumaNiveles / contadorPokemons);

    const bodyEntrenador = JSON.stringify({ 
        nombre, 
        nivel: nivelPromedio, 
        imagen_url: img 
    });

    const method = entrenadorEditandoId ? 'PUT' : 'POST';
    const url = entrenadorEditandoId ? `${API_URL}/entrenadores/${entrenadorEditandoId}` : `${API_URL}/entrenadores`;

    try {
        const res1 = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: bodyEntrenador
        });
        const dataEntrenador = await res1.json();

        if (!res1.ok) throw new Error(dataEntrenador.error || "Error guardando entrenador");

        const idFinal = entrenadorEditandoId || dataEntrenador.id;

        
        const res2 = await fetch(`${API_URL}/entrenadores/${idFinal}/equipo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: nuevoEquipo })
        });

        if (res2.ok) {
            alert("‚úÖ ¬°Rival guardado correctamente!");
            document.getElementById('modal-editor-completo').style.display = 'none';
            abrirGestionRivales(); 
        } else {
            alert("Error al guardar el equipo.");
        }

    } catch (e) {
        console.error(e);
        alert("Error: " + e.message);
    }
}

async function borrarEntrenador(id) {
    if (!confirm("¬øEliminar este rival para siempre?")) return;
    try {
        await fetch(`${API_URL}/entrenadores/${id}`, { method: 'DELETE' });
        abrirGestionRivales(); 
    } catch (e) { console.error(e); }
}
</script>

</body>
</html>